<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“ç³»ç»Ÿ - Paper Summarizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-cyan: #00d9ff;
            --neon-purple: #7b2cbf;
            --neon-green: #0f0;
            --neon-red: #ff0054;
            --neon-orange: #ffaa00;
            --dark-bg: #0a0e27;
            --dark-panel: rgba(10, 20, 40, 0.7);
            --dark-border: #00d9ff;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark-bg);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        /* èƒŒæ™¯ç½‘æ ¼æ•ˆæœ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: var(--dark-panel);
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .btn-danger {
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .btn-danger:hover {
            background: rgba(255, 0, 84, 0.2);
            box-shadow: 0 0 10px rgba(255, 0, 84, 0.3);
        }

        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-action {
            padding: 4px 8px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 4px;
            color: var(--neon-cyan);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-action:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        .btn-action.delete {
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .btn-action.delete:hover {
            background: rgba(255, 0, 84, 0.2);
        }

        /* å¯ç¼–è¾‘å•å…ƒæ ¼ */
        .editable-cell {
            cursor: pointer;
            position: relative;
            display: inline-block;
            min-width: 100px;
            min-height: 24px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .editable-cell:hover {
            background: rgba(0, 217, 255, 0.1);
        }

        /* æ‘˜è¦å•å…ƒæ ¼ç‰¹æ®Šæ ·å¼ */
        .abstract-cell {
            cursor: pointer;
            width: 100%;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            transition: all 0.3s;
            padding: 8px;
        }

        .abstract-cell:hover {
            border-color: var(--neon-cyan);
            background: rgba(0, 217, 255, 0.05);
        }

        .abstract-cell.has-content {
            border: 2px solid var(--neon-green);
            background: rgba(0, 255, 0, 0.05);
        }

        .abstract-cell.has-content:hover {
            background: rgba(0, 255, 0, 0.1);
        }

        .abstract-cell .add-icon {
            font-size: 24px;
            color: rgba(0, 217, 255, 0.5);
        }

        .abstract-cell .check-icon {
            font-size: 20px;
            color: var(--neon-green);
        }

        /* æ‘˜è¦ç¼–è¾‘æ¨¡æ€æ¡† */
        .abstract-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            backdrop-filter: blur(5px);
        }

        .abstract-modal.active {
            display: flex !important;
            justify-content: center;
            align-items: center;
        }

        .abstract-modal-content {
            background: var(--dark-panel);
            border: 2px solid var(--neon-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            padding: 30px;
        }

        .abstract-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .abstract-modal-header h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--neon-cyan);
            margin: 0;
        }

        .abstract-modal-close {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .abstract-modal-close:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .abstract-modal-body textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }

        .abstract-modal-body textarea:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .abstract-modal-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .editable-cell:empty::before {
            content: 'ç‚¹å‡»ç¼–è¾‘';
            color: rgba(255, 255, 255, 0.3);
            font-style: italic;
            pointer-events: none;
        }
        
        /* å¦‚æœå•å…ƒæ ¼åªåŒ…å«'-'ï¼Œä¹Ÿæ˜¾ç¤ºæç¤º */
        .editable-cell:has-text('-')::before {
            content: 'ç‚¹å‡»ç¼–è¾‘';
            color: rgba(255, 255, 255, 0.3);
            font-style: italic;
        }

        /* ç¡®ä¿ç©ºå•å…ƒæ ¼ä¹Ÿæœ‰è¶³å¤Ÿçš„ç‚¹å‡»åŒºåŸŸ */
        #papers-table tbody td .editable-cell {
            width: 100%;
            min-height: 32px;
            display: inline-flex;
            align-items: center;
            box-sizing: border-box;
        }
        
        /* ç©ºå•å…ƒæ ¼å æ»¡æ•´ä¸ªtdåŒºåŸŸ */
        #papers-table tbody td:has(.editable-cell:empty) {
            padding: 12px;
        }
        
        #papers-table tbody td .editable-cell:empty {
            width: 100%;
            min-height: 32px;
        }

        .editable-cell input,
        .editable-cell textarea {
            width: 100%;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid var(--neon-cyan);
            border-radius: 4px;
            color: #fff;
            padding: 4px 8px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
        }

        .editable-cell input:focus,
        .editable-cell textarea:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        /* åˆ—ç®¡ç†æ¨¡æ€æ¡† */
        .column-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .column-modal.active {
            display: flex !important;
            justify-content: center;
            align-items: center;
        }

        .column-modal-content {
            background: var(--dark-panel);
            border: 2px solid var(--neon-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            padding: 20px;
        }

        .column-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .column-modal-header h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--neon-cyan);
            margin: 0;
        }

        .column-modal-close {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .column-modal-close:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .column-list {
            margin-bottom: 20px;
        }

        .column-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 6px;
        }

        .column-item.fixed {
            opacity: 0.6;
        }

        .column-item-name {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .column-item-actions {
            display: flex;
            gap: 10px;
        }

        .column-modal-body {
            margin-bottom: 20px;
            padding: 15px 0;
        }

        .column-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-column-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-column-form input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .add-column-form input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .add-column-form .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .add-column-form .form-row input {
            flex: 1;
            margin-bottom: 0;
        }

        .add-column-form .form-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-bottom: 5px;
            display: block;
        }

        .header h1 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--neon-cyan);
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
            margin: 0;
        }

        .title-link {
            color: var(--neon-cyan);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: 500;
        }

        .title-link:hover {
            color: #fff;
            text-shadow: 0 0 8px var(--neon-cyan);
            text-decoration: underline;
        }

        .table-container {
            background: var(--dark-panel);
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
            overflow-x: visible;
            overflow-y: visible;
            width: 100%;
        }

        /* DataTables å®¹å™¨æ ·å¼ */
        .dataTables_wrapper {
            position: relative;
            width: 100%;
            overflow: visible;
        }
        
        /* DataTables è‡ªå®šä¹‰æ ·å¼ */
        #papers-table {
            width: 100% !important;
            border-collapse: collapse;
            display: table !important;
        }

        #papers-table thead th {
            background: rgba(0, 217, 255, 0.1);
            color: var(--neon-cyan);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--neon-cyan);
            cursor: pointer;
            user-select: none;
        }

        #papers-table thead th:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        #papers-table tbody td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            min-height: 40px;
            vertical-align: middle;
            word-wrap: break-word;
            max-width: 300px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢åˆ—è¿‡å®½ */
        }

        #papers-table tbody tr:hover {
            background: rgba(0, 217, 255, 0.05);
        }

        /* DataTables æœç´¢æ¡†å’Œåˆ†é¡µæ ·å¼ */
        .dataTables_wrapper {
            color: rgba(255, 255, 255, 0.8);
        }

        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 15px;
        }

        .dataTables_wrapper .dataTables_filter input {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            padding: 8px 12px;
            margin-left: 10px;
        }

        .dataTables_wrapper .dataTables_filter input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .dataTables_wrapper .dataTables_length {
            margin-bottom: 15px;
        }

        .dataTables_wrapper .dataTables_length select {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            padding: 6px 10px;
            margin: 0 5px;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan) !important;
            padding: 6px 12px;
            margin: 0 2px;
            cursor: pointer;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: rgba(0, 217, 255, 0.3);
            border-color: var(--neon-cyan);
        }

        .dataTables_wrapper .dataTables_info {
            color: rgba(255, 255, 255, 0.6);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--neon-cyan);
        }

        .error {
            text-align: center;
            padding: 40px;
            color: var(--neon-red);
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 217, 255, 0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 217, 255, 0.3);
        }
        /* Agentå¯¼å…¥å¼€å…³æ ·å¼ */
        .agent-import-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .agent-import-toggle input[type="checkbox"] {
            width: 40px;
            height: 20px;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .agent-import-toggle input[type="checkbox"]:checked {
            background: rgba(0, 217, 255, 0.3);
            border-color: var(--neon-cyan);
        }

        .agent-import-toggle input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            top: 1px;
            left: 1px;
            transition: all 0.3s;
        }

        .agent-import-toggle input[type="checkbox"]:checked::before {
            left: 21px;
            background: var(--neon-cyan);
            box-shadow: 0 0 8px rgba(0, 217, 255, 0.5);
        }

        .toggle-label {
            font-size: 14px;
            color: var(--neon-cyan);
            font-weight: 600;
            font-family: 'Rajdhani', sans-serif;
        }

        .btn-brain {
            background: rgba(255, 170, 0, 0.1);
            border-color: var(--neon-orange);
            color: var(--neon-orange);
        }

        .btn-brain:hover {
            background: rgba(255, 170, 0, 0.2);
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.3);
        }

        /* ç»Ÿä¸€å›¾æ ‡æ ·å¼ */
        .status-icon {
            font-size: 18px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ•°æ®åº“ç³»ç»Ÿ</h1>
            <div class="header-actions">
                <div id="paper-count" style="color: rgba(255, 255, 255, 0.6); margin-right: 15px;">åŠ è½½ä¸­...</div>
                <label class="agent-import-toggle" title="å¼€å¯åï¼Œå¤§è„‘ä¼šè‡ªåŠ¨åœ¨åå°åˆ†ææ‰€æœ‰æœªå¤„ç†çš„è®ºæ–‡">
                    <input type="checkbox" id="brain-analysis-switch" onchange="toggleBrainAnalysis()">
                    <span class="toggle-label">âš¡ è®ºæ–‡åˆ†æ</span>
                </label>
                <button class="btn" id="btn-refresh" onclick="loadPapersTable()" title="åˆ·æ–°æ•°æ®åº“ä¿¡æ¯">ğŸ”„ åˆ·æ–°</button>
                <button class="btn" id="btn-export-csv" onclick="exportToCSV()">å¯¼å‡ºCSV</button>
                <button class="btn" id="btn-import-csv" onclick="openCSVUploadModal()">ä¸Šä¼ CSV</button>
                <button class="btn btn-danger" id="btn-cleanup-pdfs" onclick="cleanupUnusedPDFs()">æ¸…ç†æ— ç”¨PDF</button>
            </div>
        </div>
        <div class="table-container">
            <div id="loading" class="loading">æ­£åœ¨åŠ è½½è®ºæ–‡åˆ—è¡¨...</div>
            <div id="error" class="error" style="display: none;"></div>
            <table id="papers-table" class="display">
                <thead>
                    <tr>
                        <!-- è¡¨å¤´å°†ç”±DataTablesåŠ¨æ€ç”Ÿæˆ -->
                    </tr>
                </thead>
                <tbody>
                    <!-- æ•°æ®å°†é€šè¿‡DataTablesåŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- CSVä¸Šä¼ æ¨¡æ€æ¡† -->
    <div class="column-modal" id="csv-upload-modal">
        <div class="column-modal-content">
            <div class="column-modal-header">
                <h3>ä¸Šä¼ CSVæ–‡ä»¶</h3>
                <button class="column-modal-close" id="csv-upload-modal-close">âœ•</button>
            </div>
            <div class="column-modal-body">
                <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 15px;">
                    è¯·é€‰æ‹©CSVæ–‡ä»¶è¿›è¡Œä¸Šä¼ ã€‚ç³»ç»Ÿå°†æ¯”å¯¹æ•°æ®åº“å¹¶æ›´æ–°è®ºæ–‡ä¿¡æ¯ã€‚
                </p>
                <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
                <button class="btn" onclick="document.getElementById('csv-file-input').click()">é€‰æ‹©æ–‡ä»¶</button>
                <div id="csv-file-name" style="margin-top: 10px; color: rgba(255, 255, 255, 0.7);"></div>
                <div id="csv-upload-status" style="margin-top: 15px;"></div>
            </div>
            <div class="column-modal-footer">
                <button class="btn" onclick="closeCSVUploadModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="btn-upload-csv" onclick="uploadCSV()" disabled>ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <!-- åˆ—ç®¡ç†æ¨¡æ€æ¡†ï¼ˆå·²ç¦ç”¨ï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰ -->
    <div class="column-modal" id="column-modal" style="display: none;">
        <div class="column-modal-content">
            <div class="column-modal-header">
                <h3>ç®¡ç†åˆ—</h3>
                <button class="column-modal-close" id="column-modal-close">âœ•</button>
            </div>
            <div class="column-list" id="column-list">
                <!-- åˆ—åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="add-column-form">
                <label class="form-label">ä¸­æ–‡åç§°ï¼š</label>
                <input type="text" id="new-column-name-cn" placeholder="è¾“å…¥ä¸­æ–‡åˆ—å...">
                <label class="form-label">è‹±æ–‡åç§°ï¼š</label>
                <input type="text" id="new-column-name-en" placeholder="è¾“å…¥è‹±æ–‡åˆ—åï¼ˆå¯é€‰ï¼‰...">
                <button class="btn" onclick="addCustomColumn()">æ·»åŠ åˆ—</button>
            </div>
        </div>
    </div>

    <!-- æ‘˜è¦æŸ¥çœ‹æ¨¡æ€æ¡†ï¼ˆåªè¯»ï¼‰ -->
    <div class="abstract-modal" id="abstract-modal">
        <div class="abstract-modal-content">
            <div class="abstract-modal-header">
                <h3>æŸ¥çœ‹æ‘˜è¦</h3>
                <button class="abstract-modal-close" id="abstract-modal-close">âœ•</button>
            </div>
            <div class="abstract-modal-body">
                <div id="abstract-textarea" style="min-height: 200px; padding: 15px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); white-space: pre-wrap; overflow-y: auto; max-height: 400px;"></div>
            </div>
            <div class="abstract-modal-footer">
                <button class="btn" onclick="closeAbstractModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // ç¡®ä¿jQueryå·²åŠ è½½
        if (typeof jQuery === 'undefined') {
            document.write('<script src="https://code.jquery.com/jquery-3.7.1.min.js"><\/script>');
        }

        // å›ºå®šåˆ—å®šä¹‰ï¼ˆä½¿ç”¨æ•°æ®åº“å­—æ®µåï¼‰
        const FIXED_COLUMNS_DEF = {
            'title': 'æ ‡é¢˜',
            'source': 'ç±»å‹',
            'tag': 'æ ‡ç­¾',
            'think_points': 'Thinkç‚¹',
            'contextual_summary': 'å…³è”æ€»ç»“',
            'abstract': 'æ‘˜è¦',
            'content': 'æ­£æ–‡',
            'attachment_path': 'åŸæ–‡è·¯å¾„'
        };
        
        // å½“å‰æ˜¾ç¤ºçš„åˆ—
        const FIXED_VISIBLE_COLUMNS = ['title', 'source', 'tag', 'think_points', 'contextual_summary', 'abstract', 'content', 'attachment_path'];
        let visibleColumns = FIXED_VISIBLE_COLUMNS;
        
        // è·å–åˆ—æ˜¾ç¤ºåç§°
        function getColumnDisplayName(columnKey) {
            return FIXED_COLUMNS_DEF[columnKey] || columnKey;
        }
        
        // è·å–åˆ—é”®åï¼ˆä»æ˜¾ç¤ºåç§°ä¸­æå–ï¼‰
        function getColumnKey(displayName) {
            // å¦‚æœæ˜¯å›ºå®šåˆ—ï¼ŒæŸ¥æ‰¾é”®å
            for (const [key, display] of Object.entries(FIXED_COLUMNS_DEF)) {
                if (display === displayName) {
                    return key;
                }
            }
            // å¦‚æœæ˜¯è‡ªå®šä¹‰åˆ—ï¼ŒæŸ¥æ‰¾é”®å
            const customCol = customColumns.find(col => col.display === displayName);
            if (customCol) {
                return customCol.key;
            }
            // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœç›´æ¥æ˜¯é”®åï¼Œè¿”å›é”®å
            if (FIXED_COLUMNS.includes(displayName)) {
                return displayName;
            }
            return displayName;
        }
        
        // è®ºæ–‡æ•°æ®
        let papersData = [];
        let papersTable = null;

        $(document).ready(function() {
            loadPapersTable();
            initColumnModal();
            initAbstractModal();
            initCSVUploadModal();
            initBrainAnalysisSwitch();
        });

        // åˆå§‹åŒ–è®ºæ–‡åˆ†æå¼€å…³çŠ¶æ€
        function initBrainAnalysisSwitch() {
            fetch('/api/note/settings')
                .then(res => res.json())
                .then(data => {
                    const brainSwitch = document.getElementById('brain-analysis-switch');
                    if (brainSwitch) {
                        brainSwitch.checked = !!data.brain_analysis_active;
                    }
                });
        }

        // åˆ‡æ¢è®ºæ–‡åˆ†æåŠŸèƒ½
        window.toggleBrainAnalysis = function() {
            const isChecked = document.getElementById('brain-analysis-switch').checked;
            
            fetch('/api/note/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brain_analysis_active: isChecked })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log(isChecked ? 'è®ºæ–‡åå°åˆ†æå·²å¼€å¯' : 'è®ºæ–‡åå°åˆ†æå·²åœæ­¢');
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                    document.getElementById('brain-analysis-switch').checked = !isChecked;
                }
            });
        };

        // åˆå§‹åŒ–åˆ—ç®¡ç†æ¨¡æ€æ¡†
        function initColumnModal() {
            $('#column-modal-close').on('click', function() {
                $('#column-modal').removeClass('active');
            });
            
            $('#column-modal').on('click', function(e) {
                if (e.target === this) {
                    $(this).removeClass('active');
                }
            });
        }

        // åˆå§‹åŒ–æ‘˜è¦æŸ¥çœ‹æ¨¡æ€æ¡†ï¼ˆåªè¯»ï¼‰
        function initAbstractModal() {
            $('#abstract-modal-close').on('click', function() {
                closeAbstractModal();
            });
            
            $('#abstract-modal').on('click', function(e) {
                if (e.target === this) {
                    closeAbstractModal();
                }
            });
            
            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && $('#abstract-modal').hasClass('active')) {
                    closeAbstractModal();
                }
            });
        }

        // æ‰“å¼€åˆ—ç®¡ç†æ¨¡æ€æ¡†
        function openColumnModal() {
            renderColumnList();
            $('#column-modal').addClass('active');
        }

        // æ¸²æŸ“åˆ—åˆ—è¡¨
        function renderColumnList() {
            const columnList = $('#column-list');
            columnList.empty();
            
            // æ˜¾ç¤ºå›ºå®šåˆ—
            FIXED_COLUMNS.forEach(colKey => {
                const displayName = getColumnDisplayName(colKey);
                const item = $('<div class="column-item fixed"></div>');
                item.html(`
                    <span class="column-item-name">${displayName}</span>
                    <span style="color: rgba(255, 255, 255, 0.4); font-size: 12px;">å›ºå®šåˆ—</span>
                `);
                columnList.append(item);
            });
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰åˆ—
            customColumns.forEach(col => {
                const displayName = col.display || col.key || col; // å…¼å®¹æ—§æ ¼å¼
                const colKey = col.key || col; // å…¼å®¹æ—§æ ¼å¼
                const item = $('<div class="column-item"></div>');
                item.html(`
                    <span class="column-item-name">${displayName}</span>
                    <div class="column-item-actions">
                        <button class="btn-action delete" onclick="removeCustomColumn('${colKey}')">åˆ é™¤</button>
                    </div>
                `);
                columnList.append(item);
            });
        }

        // æ·»åŠ è‡ªå®šä¹‰åˆ—
        function addCustomColumn() {
            const cnName = $('#new-column-name-cn').val().trim();
            const enName = $('#new-column-name-en').val().trim();
            
            if (!cnName) {
                alert('è¯·è¾“å…¥ä¸­æ–‡åˆ—å');
                return;
            }
            
            // ç”Ÿæˆåˆ—é”®åï¼ˆä½¿ç”¨ä¸­æ–‡åï¼Œå»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
            const colKey = cnName.replace(/[\/\\]/g, '_');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingCol = customColumns.find(col => {
                const key = col.key || col;
                return key === colKey;
            });
            
            if (existingCol) {
                alert('è¯¥åˆ—å·²å­˜åœ¨');
                return;
            }
            
            // æ£€æŸ¥å›ºå®šåˆ—
            if (FIXED_COLUMNS.includes(colKey)) {
                alert('è¯¥åˆ—åä¸å›ºå®šåˆ—å†²çª');
                return;
            }
            
            // ç”Ÿæˆæ˜¾ç¤ºåç§°
            const displayName = enName ? `${cnName}/${enName}` : cnName;
            
            // æ·»åŠ åˆ°è‡ªå®šä¹‰åˆ—
            const newCol = {
                key: colKey,
                display: displayName
            };
            customColumns.push(newCol);
            localStorage.setItem('customColumns', JSON.stringify(customColumns));
            
            // æ·»åŠ åˆ°å¯è§åˆ—
            if (!visibleColumns.includes(colKey)) {
                visibleColumns.push(colKey);
                localStorage.setItem('visibleColumns', JSON.stringify(visibleColumns));
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            $('#new-column-name-cn').val('');
            $('#new-column-name-en').val('');
            
            renderColumnList();
            reloadTable();
        }

        // åˆ é™¤è‡ªå®šä¹‰åˆ—
        function removeCustomColumn(columnKey) {
            if (FIXED_COLUMNS.includes(columnKey)) {
                alert('å›ºå®šåˆ—æ— æ³•åˆ é™¤');
                return;
            }
            
            const col = customColumns.find(c => (c.key || c) === columnKey);
            const displayName = col ? (col.display || col.key || col) : columnKey;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ—"${displayName}"å—ï¼Ÿ`)) {
                customColumns = customColumns.filter(col => (col.key || col) !== columnKey);
                visibleColumns = visibleColumns.filter(col => col !== columnKey);
                localStorage.setItem('customColumns', JSON.stringify(customColumns));
                localStorage.setItem('visibleColumns', JSON.stringify(visibleColumns));
                renderColumnList();
                reloadTable();
            }
        }

        // åŒæ­¥è¡¨å¤´å’Œè¡¨ä½“çš„æ»šåŠ¨å’Œåˆ—å®½
        function syncScroll() {
            const $scrollBody = $('.dataTables_scrollBody');
            const $scrollHead = $('.dataTables_scrollHead');
            const $scrollHeadInner = $('.dataTables_scrollHeadInner');
            const $scrollBodyInner = $('.dataTables_scrollBody table');
            
            if ($scrollBody.length && $scrollHead.length && papersTable) {
                // ä½¿ç”¨ DataTables API è°ƒæ•´åˆ—å®½ï¼Œç¡®ä¿è¡¨å¤´å’Œè¡¨ä½“åˆ—å®½ä¸€è‡´
                try {
                    papersTable.columns.adjust();
                } catch (e) {
                    console.warn('è°ƒæ•´åˆ—å®½æ—¶å‡ºé”™:', e);
                }
                
                // ç¡®ä¿è¡¨å¤´å’Œè¡¨ä½“çš„è¡¨æ ¼å®½åº¦ä¸€è‡´
                const bodyTable = $scrollBodyInner;
                const headTable = $scrollHeadInner.find('table');
                
                if (bodyTable.length && headTable.length) {
                    // æ–¹æ³•1ï¼šä½¿ç”¨ DataTables API è·å–åˆ—å®½ï¼ˆæœ€å‡†ç¡®ï¼‰
                    try {
                        const columnCount = papersTable.columns().count();
                        for (let i = 0; i < columnCount; i++) {
                            const column = papersTable.column(i);
                            const $bodyCells = bodyTable.find('tbody tr:first-child td').eq(i);
                            const $headCells = headTable.find('thead tr:first-child th').eq(i);
                            
                            if ($bodyCells.length && $headCells.length) {
                                // ä½¿ç”¨ offsetWidth è·å–æ›´å‡†ç¡®çš„å®½åº¦ï¼ˆä¸åŒ…æ‹¬æ»šåŠ¨æ¡ï¼‰
                                const bodyWidth = $bodyCells[0].offsetWidth;
                                
                                if (bodyWidth > 0) {
                                    $headCells.css({
                                        'width': bodyWidth + 'px',
                                        'min-width': bodyWidth + 'px',
                                        'max-width': bodyWidth + 'px',
                                        'box-sizing': 'border-box'
                                    });
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('ä½¿ç”¨ DataTables API åŒæ­¥åˆ—å®½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•:', e);
                    }
                    
                    // æ–¹æ³•2ï¼šç›´æ¥åŒæ­¥ tbody ç¬¬ä¸€è¡Œçš„åˆ—å®½åˆ° theadï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
                    const bodyFirstRow = bodyTable.find('tbody tr:first-child');
                    const headFirstRow = headTable.find('thead tr:first-child');
                    
                    if (bodyFirstRow.length && headFirstRow.length) {
                        const bodyCells = bodyFirstRow.find('td');
                        const headCells = headFirstRow.find('th');
                        
                        if (bodyCells.length === headCells.length) {
                            bodyCells.each(function(cellIndex) {
                                const bodyCell = this;
                                const $headCell = headCells.eq(cellIndex);
                                // ä½¿ç”¨ offsetWidth è·å–æ›´å‡†ç¡®çš„å®½åº¦
                                const bodyWidth = bodyCell.offsetWidth;
                                
                                if (bodyWidth > 0) {
                                    $headCell.css({
                                        'width': bodyWidth + 'px',
                                        'min-width': bodyWidth + 'px',
                                        'max-width': bodyWidth + 'px',
                                        'box-sizing': 'border-box'
                                    });
                                }
                            });
                        }
                    }
                    
                    // æ–¹æ³•3ï¼šåŒæ­¥è¡¨å¤´è¡Œçš„åˆ—å®½ï¼ˆé¢å¤–ä¿é™©ï¼‰
                    const bodyHeaderRows = bodyTable.find('thead tr');
                    const headHeaderRows = headTable.find('thead tr');
                    
                    if (bodyHeaderRows.length === headHeaderRows.length) {
                        bodyHeaderRows.each(function(rowIndex) {
                            const $bodyRow = $(this);
                            const $headRow = headHeaderRows.eq(rowIndex);
                            const bodyCells = $bodyRow.find('th, td');
                            const headCells = $headRow.find('th, td');
                            
                            if (bodyCells.length === headCells.length) {
                                bodyCells.each(function(cellIndex) {
                                    const bodyCell = this;
                                    const $headCell = headCells.eq(cellIndex);
                                    const bodyWidth = bodyCell.offsetWidth;
                                    
                                    if (bodyWidth > 0) {
                                        $headCell.css({
                                            'width': bodyWidth + 'px',
                                            'min-width': bodyWidth + 'px',
                                            'max-width': bodyWidth + 'px',
                                            'box-sizing': 'border-box'
                                        });
                                    }
                                });
                            }
                        });
                    }
                    
                    // ç¡®ä¿è¡¨å¤´è¡¨æ ¼æ€»å®½åº¦ä¸è¡¨ä½“ä¸€è‡´
                    const bodyWidth = bodyTable[0].offsetWidth;
                    const headWidth = headTable[0].offsetWidth;
                    
                    if (bodyWidth && headWidth && Math.abs(bodyWidth - headWidth) > 1) {
                        headTable.css('width', bodyWidth + 'px');
                        $scrollHeadInner.css('width', bodyWidth + 'px');
                    }
                }
                
                // è¡¨ä½“æ»šåŠ¨æ—¶ï¼ŒåŒæ­¥è¡¨å¤´ï¼ˆä½¿ç”¨ requestAnimationFrame ç¡®ä¿æµç•…ï¼‰
                $scrollBody.off('scroll.sync').on('scroll.sync', function() {
                    const scrollLeft = this.scrollLeft;
                    requestAnimationFrame(function() {
                        $scrollHead[0].scrollLeft = scrollLeft;
                        $scrollHeadInner[0].scrollLeft = scrollLeft;
                    });
                });
                
                // è¡¨å¤´æ»šåŠ¨æ—¶ï¼ŒåŒæ­¥è¡¨ä½“
                $scrollHead.off('scroll.sync').on('scroll.sync', function() {
                    const scrollLeft = this.scrollLeft;
                    requestAnimationFrame(function() {
                        $scrollBody[0].scrollLeft = scrollLeft;
                    });
                });
                
                // scrollHeadInner æ»šåŠ¨æ—¶ï¼ŒåŒæ­¥è¡¨ä½“
                $scrollHeadInner.off('scroll.sync').on('scroll.sync', function() {
                    const scrollLeft = this.scrollLeft;
                    requestAnimationFrame(function() {
                        $scrollBody[0].scrollLeft = scrollLeft;
                    });
                });
            }
        }

        // é‡æ–°åŠ è½½è¡¨æ ¼
        let isReloading = false; // é˜²æ­¢æ— é™å¾ªç¯
        
        function reloadTable() {
            if (isReloading) {
                console.warn('è¡¨æ ¼æ­£åœ¨é‡æ–°åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                return;
            }
            
            isReloading = true;
            let $table = $('#papers-table');
            
            // æ£€æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
            if ($table.length === 0) {
                console.error('è¡¨æ ¼å…ƒç´ ä¸å­˜åœ¨ï¼å°è¯•é‡æ–°åˆ›å»º...');
                // å°è¯•ä»çˆ¶å®¹å™¨ä¸­æŸ¥æ‰¾æˆ–é‡æ–°åˆ›å»º
                const $container = $('#table-container, .table-container, #main-content').first();
                if ($container.length > 0) {
                    $container.append('<table id="papers-table" class="display"><thead><tr></tr></thead><tbody></tbody></table>');
                    $table = $('#papers-table');
                } else {
                    console.error('æ— æ³•æ‰¾åˆ°è¡¨æ ¼å®¹å™¨ï¼Œæ— æ³•é‡æ–°åˆ›å»ºè¡¨æ ¼ï¼');
                    isReloading = false;
                    return;
                }
            }
            
            // ä¿å­˜è¡¨æ ¼çš„çˆ¶å®¹å™¨å’Œä½ç½®ï¼Œä»¥ä¾¿ä¹‹åæ¢å¤
            const $parent = $table.parent();
            const tableIndex = $table.index();
            
            // å¦‚æœè¡¨æ ¼å·²åˆå§‹åŒ–ï¼Œå…ˆé”€æ¯
            if (papersTable) {
                try {
                    papersTable.destroy(true); // true å‚æ•°è¡¨ç¤ºå®Œå…¨æ¸…ç†
                    papersTable = null;
                } catch (e) {
                    console.warn('é”€æ¯è¡¨æ ¼æ—¶å‡ºé”™:', e);
                    papersTable = null;
                }
            }
            
            // æ¸…ç†æ‰€æœ‰ DataTables ç›¸å…³çš„ DOM ç»“æ„
            // DataTables çš„ç»“æ„é€šå¸¸æ˜¯ï¼š
            // .dataTables_wrapper
            //   .dataTables_scrollHead
            //     .dataTables_scrollHeadInner
            //       table (åŸå§‹è¡¨æ ¼çš„å‰¯æœ¬ï¼Œç”¨äºè¡¨å¤´)
            //   .dataTables_scrollBody
            //     table#papers-table (åŸå§‹è¡¨æ ¼)
            //   .dataTables_scrollFoot (å¦‚æœæœ‰)
            
            // å…³é”®ï¼šåœ¨æ¸…ç†ä¹‹å‰ï¼Œå…ˆä¿å­˜è¡¨æ ¼çš„å¼•ç”¨å¹¶æŠŠå®ƒä» DataTables ç»“æ„ä¸­ç§»å‡º
            const $scrollBody = $table.closest('.dataTables_scrollBody');
            const $wrapper = $table.closest('.dataTables_wrapper');
            const $container = $('.table-container');
            
            // å¦‚æœè¡¨æ ¼åœ¨æ»šåŠ¨ä½“ä¸­ï¼ˆscrollX æ¨¡å¼ï¼‰ï¼Œéœ€è¦å…ˆæŠŠå®ƒç§»å‡ºæ¥
            if ($scrollBody.length > 0) {
                console.log('è¡¨æ ¼åœ¨ scrollBody ä¸­ï¼Œå…ˆç§»å‡ºè¡¨æ ¼');
                // ä½¿ç”¨ detach() ä» DOM ä¸­ç§»é™¤ä½†ä¿ç•™ jQuery å¯¹è±¡å’Œæ‰€æœ‰æ•°æ®
                $table.detach();
                // ç«‹å³æŠŠè¡¨æ ¼æ”¾å›å®¹å™¨ï¼Œé¿å…ä¸¢å¤±
                if ($container.length > 0) {
                    // ç¡®ä¿å®¹å™¨ä¸­æ²¡æœ‰é‡å¤çš„è¡¨æ ¼
                    $container.find('#papers-table').remove();
                    $container.append($table);
                    console.log('è¡¨æ ¼å·²æ”¾å›å®¹å™¨');
                }
                // ç°åœ¨å¯ä»¥å®‰å…¨åœ°ç§»é™¤ wrapperï¼ˆè¡¨æ ¼å·²ç»ä¸åœ¨å…¶ä¸­äº†ï¼‰
                if ($wrapper.length > 0) {
                    $wrapper.remove();
                }
            } else if ($wrapper.length > 0) {
                console.log('è¡¨æ ¼åœ¨ wrapper ä¸­ï¼Œç›´æ¥è§£åŒ…');
                // å¦‚æœè¡¨æ ¼åœ¨ wrapper ä¸­ä½†ä¸åœ¨ scrollBody ä¸­ï¼Œç›´æ¥è§£åŒ…
                $table.unwrap();
            }
            
            // ç°åœ¨è¡¨æ ¼å·²ç»ä¸åœ¨ DataTables ç»“æ„ä¸­äº†ï¼Œå¯ä»¥å®‰å…¨åœ°æ¸…ç†æ‰€æœ‰ DataTables å…ƒç´ 
            // ç§»é™¤æ‰€æœ‰å‰©ä½™çš„ DataTables ç›¸å…³å…ƒç´ ï¼ˆç¡®ä¿æ¸…ç†å¹²å‡€ï¼‰
            $('.dataTables_wrapper').remove();
            $('.dataTables_scrollHead').remove();
            $('.dataTables_scrollBody').remove();
            $('.dataTables_scrollFoot').remove();
            
            // é‡æ–°è·å–è¡¨æ ¼å…ƒç´ ï¼Œç¡®ä¿å®ƒè¿˜åœ¨ DOM ä¸­
            $table = $('#papers-table');
            if ($table.length === 0) {
                console.error('è¡¨æ ¼åœ¨æ¸…ç†è¿‡ç¨‹ä¸­è¢«åˆ é™¤ï¼å°è¯•æ¢å¤...');
                // å°è¯•åœ¨ .table-container ä¸­æ¢å¤è¡¨æ ¼
                const $container = $('.table-container');
                if ($container.length > 0) {
                    // ç§»é™¤å®¹å™¨ä¸­çš„ loading å’Œ error å…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç„¶åæ·»åŠ è¡¨æ ¼
                    $container.find('#papers-table').remove(); // ç¡®ä¿æ²¡æœ‰é‡å¤
                    $container.append('<table id="papers-table" class="display"><thead><tr></tr></thead><tbody></tbody></table>');
                    $table = $('#papers-table');
                    console.log('è¡¨æ ¼å·²æ¢å¤');
                } else if ($parent.length > 0) {
                    // å¦‚æœæ‰¾ä¸åˆ°å®¹å™¨ï¼Œå°è¯•åœ¨åŸæ¥çš„çˆ¶å…ƒç´ ä¸­æ¢å¤
                    $parent.append('<table id="papers-table" class="display"><thead><tr></tr></thead><tbody></tbody></table>');
                    $table = $('#papers-table');
                    console.log('è¡¨æ ¼å·²åœ¨åŸçˆ¶å…ƒç´ ä¸­æ¢å¤');
                } else {
                    console.error('æ— æ³•æ¢å¤è¡¨æ ¼ï¼æ‰¾ä¸åˆ°åˆé€‚çš„å®¹å™¨');
                    isReloading = false;
                    return;
                }
            }
            
            // ç§»é™¤ DataTables ç›¸å…³çš„ç±»å’Œå±æ€§
            $table.removeClass('dataTable');
            $table.removeAttr('role');
            $table.removeAttr('style'); // ç§»é™¤å¯èƒ½å½±å“æ˜¾ç¤ºçš„æ ·å¼
            
            // æ¸…ç† thead å’Œ tbody
            $table.find('thead').empty();
            $table.find('tbody').empty();
            
            // æ¢å¤åˆå§‹çš„è¡¨æ ¼ç»“æ„
            if ($table.find('thead').length === 0) {
                $table.prepend('<thead><tr><!-- è¡¨å¤´å°†ç”±DataTablesåŠ¨æ€ç”Ÿæˆ --></tr></thead>');
            } else {
                $table.find('thead').html('<tr><!-- è¡¨å¤´å°†ç”±DataTablesåŠ¨æ€ç”Ÿæˆ --></tr>');
            }
            
            if ($table.find('tbody').length === 0) {
                $table.append('<tbody><!-- æ•°æ®å°†é€šè¿‡DataTablesåŠ¨æ€åŠ è½½ --></tbody>');
            } else {
                $table.find('tbody').html('<!-- æ•°æ®å°†é€šè¿‡DataTablesåŠ¨æ€åŠ è½½ -->');
            }
            
            // ç¡®ä¿è¡¨æ ¼å¯è§
            $table.show().css({
                'display': 'table',
                'visibility': 'visible',
                'opacity': '1'
            });
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿æ¸…ç†å®Œæˆ
            setTimeout(function() {
                loadPapersTable();
                // é‡ç½®æ ‡å¿—ï¼Œå…è®¸ä¸‹æ¬¡é‡æ–°åŠ è½½
                setTimeout(function() {
                    isReloading = false;
                }, 1000);
            }, 100);
        }

        // åŠ è½½è®ºæ–‡è¡¨æ ¼æ•°æ®
        function loadPapersTable() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            $('#loading').show();
            $('#papers-table').hide();
            $('#error').hide();
            
            // æŒ‰é’®ç¦ç”¨ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            const $refreshBtn = $('#btn-refresh');
            const originalText = $refreshBtn.html();
            $refreshBtn.html('ğŸ”„ åˆ·æ–°ä¸­...').prop('disabled', true);

            // ä»åç«¯è·å–è®ºæ–‡åˆ—è¡¨
            fetch('/api/papers/list')
                .then(response => response.json())
                .then(data => {
                    $('#loading').hide();
                    $refreshBtn.html(originalText).prop('disabled', false);
                    
                    if (data.success) {
                        papersData = data.papers || [];
                        
                        console.log('åŠ è½½çš„è®ºæ–‡æ•°æ®:', papersData.length, 'ç¯‡');
                        console.log('æ•°æ®ç¤ºä¾‹:', papersData.slice(0, 3));
                        
                        // é¢å¤–æ£€æŸ¥ source ä¸º note çš„æ•°æ®
                        const noteCount = papersData.filter(p => p.source === 'note').length;
                        console.log('å…¶ä¸­ç¬”è®°æ¡æ•°:', noteCount);
                        $('#paper-count').text(`å…± ${papersData.length} ç¯‡è®ºæ–‡`);
                        
                        // æ„å»ºåˆ—é…ç½®
                        const columns = buildColumns();
                        const tableData = buildTableData(papersData);
                        
                        console.log('åˆ—é…ç½®æ•°é‡:', columns.length);
                        console.log('è¡¨æ ¼æ•°æ®è¡Œæ•°:', tableData.length);
                        
                        // ç¡®ä¿è¡¨æ ¼å®¹å™¨å­˜åœ¨ä¸”æ²¡æœ‰è¢«åˆå§‹åŒ–
                        const $table = $('#papers-table');
                        
                        // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–
                        if ($.fn.DataTable.isDataTable($table)) {
                            try {
                                console.log('é”€æ¯å·²æœ‰è¡¨æ ¼');
                                $table.DataTable().destroy();
                            } catch (e) {
                                console.warn('é”€æ¯å·²æœ‰è¡¨æ ¼æ—¶å‡ºé”™:', e);
                            }
                        }
                        
                        // ç¡®ä¿è¡¨æ ¼ç»“æ„å®Œæ•´
                        if ($table.find('thead').length === 0) {
                            $table.prepend('<thead><tr><!-- è¡¨å¤´å°†ç”±DataTablesåŠ¨æ€ç”Ÿæˆ --></tr></thead>');
                        }
                        if ($table.find('tbody').length === 0) {
                            $table.append('<tbody><!-- æ•°æ®å°†é€šè¿‡DataTablesåŠ¨æ€åŠ è½½ --></tbody>');
                        }
                        
                        // ç¡®ä¿è¡¨æ ¼å¯è§
                        $table.show();
                        $('#error').hide();
                        
                        // å³ä½¿æ•°æ®ä¸ºç©ºï¼Œä¹Ÿè®© DataTables å¤„ç†ï¼Œå®ƒä¼šæ˜¾ç¤ºâ€œæš‚æ— æ•°æ®â€
                        if (!tableData) {
                            console.error('è¡¨æ ¼æ•°æ®æ„å»ºå¤±è´¥');
                            $('#error').text('æ•°æ®å¤„ç†é”™è¯¯').show();
                            $table.hide();
                            return;
                        }
                        
                        // æ£€æŸ¥åˆ—é…ç½®æ˜¯å¦ä¸ºç©º
                        if (!columns || columns.length === 0) {
                            console.error('åˆ—é…ç½®ä¸ºç©º');
                            $('#error').text('åˆ—é…ç½®é”™è¯¯').show();
                            $table.hide();
                            return;
                        }
                        
                        console.log('å¼€å§‹åˆå§‹åŒ–DataTables...');
                        
                        // åˆå§‹åŒ–DataTables
                        try {
                            // ç¡®ä¿è¡¨æ ¼å®¹å™¨å¯è§ä¸”ç»“æ„å®Œæ•´
                            $table.css({
                                'display': 'table',
                                'visibility': 'visible',
                                'opacity': '1'
                            });
                            
                            // ç¡®ä¿è¡¨æ ¼ç»“æ„å®Œæ•´
                            if ($table.find('thead').length === 0) {
                                $table.prepend('<thead><tr></tr></thead>');
                            }
                            if ($table.find('tbody').length === 0) {
                                $table.append('<tbody></tbody>');
                            }
                            
                            papersTable = $table.DataTable({
                            data: tableData,
                            columns: columns,
                            language: {
                                search: 'æœç´¢:',
                                lengthMenu: 'æ˜¾ç¤º _MENU_ æ¡è®°å½•',
                                info: 'æ˜¾ç¤ºç¬¬ _START_ è‡³ _END_ é¡¹ç»“æœï¼Œå…± _TOTAL_ é¡¹',
                                infoEmpty: 'æ˜¾ç¤ºç¬¬ 0 è‡³ 0 é¡¹ç»“æœï¼Œå…± 0 é¡¹',
                                infoFiltered: '(ä» _MAX_ æ¡è®°å½•ä¸­ç­›é€‰)',
                                paginate: {
                                    first: 'é¦–é¡µ',
                                    previous: 'ä¸Šä¸€é¡µ',
                                    next: 'ä¸‹ä¸€é¡µ',
                                    last: 'æœ«é¡µ'
                                },
                                emptyTable: 'æš‚æ— æ•°æ®',
                                zeroRecords: 'æ²¡æœ‰åŒ¹é…çš„è®°å½•'
                            },
                            pageLength: 25,
                            order: [[0, 'asc']],
                            dom: '<"top"lf>rt<"bottom"ip>',
                            scrollX: false,              // ç¦ç”¨æ¨ªå‘æ»šåŠ¨
                            scrollCollapse: false,       // ä¸æŠ˜å ç©ºè¡Œ
                            autoWidth: true,             // ä½¿ç”¨è‡ªåŠ¨å®½åº¦ï¼Œè®©è¡¨æ ¼é€‚åº”å®¹å™¨
                            fixedColumns: false,         // ä¸ä½¿ç”¨å›ºå®šåˆ—
                            scrollY: false,              // ä¸ä½¿ç”¨çºµå‘æ»šåŠ¨ï¼ˆä½¿ç”¨åˆ†é¡µï¼‰
                            columnDefs: [
                                {
                                    targets: '_all',
                                    className: 'text-left'
                                }
                            ],
                            deferRender: false,  // ç«‹å³æ¸²æŸ“æ‰€æœ‰è¡Œï¼Œç¡®ä¿åˆ—å®½è®¡ç®—å‡†ç¡®
                            initComplete: function(settings, json) {
                                console.log('DataTables initComplete å›è°ƒæ‰§è¡Œ');
                                console.log('æ•°æ®è¡Œæ•°:', json ? json.data.length : 'N/A');
                                
                                // ç¡®ä¿è¡¨æ ¼å¯è§
                                const $wrapper = $('.dataTables_wrapper');
                                if ($wrapper.length) {
                                    $wrapper.show().css({
                                        'display': 'block',
                                        'visibility': 'visible',
                                        'opacity': '1'
                                    });
                                } else {
                                    console.error('DataTables wrapper æœªåˆ›å»ºï¼');
                                }
                                
                                // æ¨ªå‘æ»šåŠ¨å·²ç¦ç”¨ï¼Œæ— éœ€æ£€æŸ¥æ»šåŠ¨å®¹å™¨
                                
                                // ç¡®ä¿åŸå§‹è¡¨æ ¼å¯è§
                                $table.show().css({
                                    'display': 'table',
                                    'visibility': 'visible',
                                    'opacity': '1'
                                });
                                
                                 // æ¨ªå‘æ»šåŠ¨å·²ç¦ç”¨ï¼Œæ— éœ€åŒæ­¥
                            },
                            drawCallback: function(settings) {
                                console.log('DataTables drawCallback å›è°ƒæ‰§è¡Œ');
                                const api = this.api();
                                const rows = api.rows({page: 'current'}).nodes().length;
                                console.log('å½“å‰é¡µè¡Œæ•°:', rows);
                                
                                 // æ¨ªå‘æ»šåŠ¨å·²ç¦ç”¨ï¼Œæ— éœ€åŒæ­¥
                            }
                        });
                        
                         // æ¨ªå‘æ»šåŠ¨å·²ç¦ç”¨ï¼Œæ— éœ€ç›‘å¬æ»šåŠ¨äº‹ä»¶
                        
                        console.log('DataTablesåˆå§‹åŒ–æˆåŠŸï¼Œå®ä¾‹:', papersTable);
                        
                        // æ£€æŸ¥è¡¨æ ¼æ˜¯å¦çœŸçš„æ˜¾ç¤ºäº†
                        setTimeout(function() {
                            // é‡æ–°è·å–è¡¨æ ¼å…ƒç´ ï¼Œç¡®ä¿åœ¨ä½œç”¨åŸŸå†…
                            const $tableCheck = $('#papers-table');
                            const isVisible = $tableCheck.is(':visible');
                            const scrollBody = $('.dataTables_scrollBody');
                            const scrollWrapper = $('.dataTables_wrapper');
                            const scrollHead = $('.dataTables_scrollHead');
                            const hasRows = scrollBody.find('tbody tr').length > 0 || $tableCheck.find('tbody tr').length > 0;
                            
                            const status = { 
                                isVisible, 
                                hasRows, 
                                tableRows: $tableCheck.find('tbody tr').length,
                                scrollWrapperExists: scrollWrapper.length > 0,
                                scrollWrapperVisible: scrollWrapper.is(':visible'),
                                tableDataLength: tableData.length,
                                columnsLength: columns.length
                            };
                            
                            console.log('è¡¨æ ¼çŠ¶æ€æ£€æŸ¥:', status);
                            
                            // å¦‚æœåŒ…è£…å™¨ä¸å­˜åœ¨ï¼Œè¯´æ˜ DataTables åˆå§‹åŒ–å¤±è´¥
                            if (!scrollWrapper.length) {
                                console.error('DataTables åŒ…è£…å™¨æœªåˆ›å»ºï¼Œåˆå§‹åŒ–å¯èƒ½å¤±è´¥ï¼');
                                console.error('è¡¨æ ¼å…ƒç´ :', $tableCheck[0]);
                                console.error('è¡¨æ ¼çˆ¶å…ƒç´ :', $tableCheck.parent()[0]);
                                console.error('è¡¨æ ¼æ˜¯å¦å­˜åœ¨:', $tableCheck.length > 0);
                                console.error('è¡¨æ ¼æ˜¾ç¤ºçŠ¶æ€:', $tableCheck.is(':visible'));
                                // ä¸è¿›è¡Œé‡æ–°åˆå§‹åŒ–ï¼Œé¿å…æ— é™å¾ªç¯
                                return;
                            }
                            
                            // å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰ç›¸å…³å…ƒç´ 
                            if (!isVisible) {
                                console.warn('è¡¨æ ¼ä¸å¯è§ï¼Œå¼ºåˆ¶æ˜¾ç¤º');
                                $tableCheck.show().css({
                                    'display': 'table',
                                    'visibility': 'visible',
                                    'opacity': '1'
                                });
                            }
                            
                            if (scrollWrapper.length > 0) {
                                if (!scrollWrapper.is(':visible')) {
                                    console.warn('DataTablesåŒ…è£…å™¨ä¸å¯è§ï¼Œå¼ºåˆ¶æ˜¾ç¤º');
                                }
                                scrollWrapper.show().css('display', 'block');
                            }
                            
                            // æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®æ¸²æŸ“
                            if (!hasRows && tableData.length > 0) {
                                console.warn('è¡¨æ ¼æ²¡æœ‰è¡Œæ•°æ®ï¼Œä½†tableDataä¸ä¸ºç©º');
                                console.warn('tableDataç¤ºä¾‹ï¼ˆç¬¬ä¸€è¡Œï¼‰:', tableData[0]);
                                console.warn('åˆ—é…ç½®ç¤ºä¾‹ï¼ˆç¬¬ä¸€åˆ—ï¼‰:', columns[0]);
                                console.warn('tableDataé•¿åº¦:', tableData.length);
                                console.warn('columnsé•¿åº¦:', columns.length);
                                
                                if (papersTable && !isReloading) {
                                    try {
                                        // æ£€æŸ¥è¡¨æ ¼å®ä¾‹çŠ¶æ€
                                        const api = papersTable;
                                        const currentData = api.rows().data().toArray();
                                        console.warn('å½“å‰è¡¨æ ¼æ•°æ®è¡Œæ•°:', currentData.length);
                                        
                                        // å¦‚æœå½“å‰æ²¡æœ‰æ•°æ®ï¼Œé‡æ–°æ·»åŠ 
                                        if (currentData.length === 0) {
                                            console.log('è¡¨æ ¼æ•°æ®ä¸ºç©ºï¼Œé‡æ–°æ·»åŠ æ•°æ®...');
                                            api.clear();
                                            api.rows.add(tableData);
                                            api.draw(false);
                                            console.log('é‡æ–°ç»˜åˆ¶å®Œæˆ');
                                            
                                            // å†æ¬¡æ£€æŸ¥
                                            setTimeout(function() {
                                                const $tableCheck2 = $('#papers-table');
                                                const newHasRows = $tableCheck2.find('tbody tr').length > 0;
                                                console.log('é‡æ–°ç»˜åˆ¶åè¡Œæ•°:', $tableCheck2.find('tbody tr').length);
                                                if (!newHasRows && !isReloading) {
                                                    console.error('é‡æ–°ç»˜åˆ¶åä»ç„¶æ²¡æœ‰è¡Œæ•°æ®ï¼');
                                                    // ä¸å†è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–ï¼Œé¿å…æ— é™å¾ªç¯
                                                    console.error('è¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥æ•°æ®æ ¼å¼');
                                                }
                                            }, 300);
                                        } else {
                                            console.warn('è¡¨æ ¼å·²æœ‰æ•°æ®ï¼Œä½†DOMä¸­æ²¡æœ‰è¡Œï¼Œå¯èƒ½æ˜¯æ¸²æŸ“é—®é¢˜');
                                            api.draw(false);
                                        }
                                    } catch (e) {
                                        console.error('é‡æ–°ç»˜åˆ¶å¤±è´¥:', e);
                                        console.error('é”™è¯¯å †æ ˆ:', e.stack);
                                    }
                                } else {
                                    if (isReloading) {
                                        console.warn('è¡¨æ ¼æ­£åœ¨é‡æ–°åŠ è½½ä¸­ï¼Œè·³è¿‡æ•°æ®æ£€æŸ¥');
                                    } else {
                                        console.error('papersTable å®ä¾‹ä¸å­˜åœ¨ï¼');
                                    }
                                }
                            }
                        }, 500);
                        
                        } catch (initError) {
                            console.error('DataTablesåˆå§‹åŒ–å¤±è´¥:', initError);
                            console.error('é”™è¯¯å †æ ˆ:', initError.stack);
                            $('#error').text('è¡¨æ ¼åˆå§‹åŒ–å¤±è´¥: ' + initError.message).show();
                            $table.hide();
                        }
                    } else {
                        $('#loading').hide();
                        $('#error').text('åŠ è½½è®ºæ–‡åˆ—è¡¨å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯')).show();
                        $('#papers-table').hide();
                    }
                })
                .catch(error => {
                    $('#loading').hide();
                    $('#btn-refresh').html('ğŸ”„ åˆ·æ–°').prop('disabled', false);
                    $('#error').text('è·å–è®ºæ–‡åˆ—è¡¨å‡ºé”™: ' + error.message).show();
                    $('#papers-table').hide();
                    console.error('è·å–è®ºæ–‡åˆ—è¡¨å‡ºé”™:', error);
                });
        }

        // æ„å»ºåˆ—é…ç½®
        function buildColumns() {
            const columns = [];
            
            visibleColumns.forEach((colKey, index) => {
                const colName = getColumnDisplayName(colKey);
                
                // ç¡®ä¿ colName æ˜¯å­—ç¬¦ä¸²
                if (!colName || typeof colName !== 'string') {
                    console.warn('åˆ—åæ— æ•ˆ:', colKey, colName);
                    return; // è·³è¿‡æ— æ•ˆåˆ—
                }
                
                if (colKey === 'attachment_path') {
                    columns.push({
                        title: colName || 'attachment_path',
                        orderable: false,
                        width: getColumnWidth(colKey),  // ä½¿ç”¨ç»Ÿä¸€çš„åˆ—å®½å‡½æ•°
                        render: function(data, type, row) {
                            if (type === 'display') {
                                // paper_idåœ¨æœ€åä¸€åˆ—ï¼ˆåªè¯»æ¨¡å¼ï¼‰
                                const paperIdIndex = row.length - 1;
                                const paperId = row[paperIdIndex];
                                const paper = papersData.find(p => p.paper_id === paperId);
                                const filePath = paper?.attachment_path || paper?.metadata?.attachment_path || '';
                                
                                if (filePath) {
                                    return `<div class="abstract-cell has-content" style="border-color: #ffd700;" ondblclick="openFileLocation('${filePath.replace(/\\/g, '\\\\')}')" title="åŒå‡»æ‰“å¼€æ–‡ä»¶æ‰€åœ¨ä½ç½®">
                                        <span class="check-icon" style="color: #ffd700;">âœ“</span>
                                    </div>`;
                                }
                            }
                            return `<span style="color: rgba(255, 255, 255, 0.4);">-</span>`;
                        }
                    });
                } else if (colKey === 'think_points') {
                    columns.push({
                        title: colName || 'think_points',
                        orderable: false,
                        width: getColumnWidth(colKey),
                        render: function(data, type, row) {
                            if (type === 'display') {
                                const paperIdIndex = row.length - 1;
                                const paperId = row[paperIdIndex];
                                const hasData = data && data !== '-' && 
                                               (Array.isArray(data) ? data.length > 0 : (data !== '[]' && data !== 'null' && data.trim() !== ''));
                                if (hasData) {
                                    return `<div class="abstract-cell has-content" style="border-color: var(--neon-orange);" onclick="openAbstractModal('${paperId}', 'think')" title="åŒå‡»æŸ¥çœ‹å¤§è„‘æ€è€ƒç‚¹">
                                        <span class="status-icon">ğŸ’¡</span>
                                    </div>`;
                                }
                            }
                            return '<span style="color: rgba(255,255,255,0.2);">-</span>';
                        }
                    });
                } else if (colKey === 'contextual_summary') {
                    columns.push({
                        title: colName || 'contextual_summary',
                        orderable: false,
                        width: getColumnWidth(colKey),
                        render: function(data, type, row) {
                            if (type === 'display') {
                                const paperIdIndex = row.length - 1;
                                const paperId = row[paperIdIndex];
                                const hasData = data && data !== '-' && data.trim() !== '' && data !== 'null';
                                if (hasData) {
                                    return `<div class="abstract-cell has-content" style="border-color: var(--neon-purple);" onclick="openAbstractModal('${paperId}', 'summary')" title="åŒå‡»æŸ¥çœ‹å…³è”èƒŒæ™¯æ€»ç»“">
                                        <span class="status-icon">ğŸ§©</span>
                                    </div>`;
                                }
                            }
                            return '<span style="color: rgba(255,255,255,0.2);">-</span>';
                        }
                    });
                } else if (colKey === 'title') {
                    // æ ‡é¢˜åˆ—ï¼šå¦‚æœæœ‰URLï¼Œæ˜¾ç¤ºä¸ºå¯ç‚¹å‡»é“¾æ¥
                    const width = getColumnWidth(colKey);
                    columns.push({
                        title: colName || 'title',
                        orderable: true,
                        width: width || '250px',
                        render: function(data, type, row) {
                            const paperIdIndex = row.length - 1;
                            const paperId = row[paperIdIndex];
                            const paper = papersData.find(p => p.paper_id === paperId);
                            const url = paper?.url || '';
                            
                            if (url && type === 'display') {
                                return `<a href="${url}" target="_blank" class="title-link" title="ç‚¹å‡»æ‰“å¼€åŸæ–‡">${data}</a>`;
                            }
                            return data || '-';
                        }
                    });
                } else if (colKey === 'abstract') {
                    // æ‘˜è¦åˆ—ç‰¹æ®Šå¤„ç†ï¼šæ˜¾ç¤ºå›¾æ ‡ï¼ŒåŒå‡»å¯æŸ¥çœ‹
                    const width = getColumnWidth(colKey);
                    columns.push({
                        title: colName || 'abstract',
                        orderable: false,
                        width: width || '100px',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                // paper_idåœ¨æœ€åä¸€åˆ—
                                const paperIdIndex = row.length - 1;
                                const paperId = row[paperIdIndex];
                                const hasAbstract = data && data !== '-' && data.trim() !== '';
                                
                                if (hasAbstract) {
                                    return `<div class="abstract-cell has-content" data-paper-id="${paperId}" ondblclick="openAbstractModal('${paperId}')" title="åŒå‡»æŸ¥çœ‹æ‘˜è¦">
                                        <span class="check-icon">âœ“</span>
                                    </div>`;
                                }
                            }
                            return '<span style="color: rgba(255,255,255,0.2);">-</span>';
                        }
                    });
                } else if (colKey === 'content') {
                    // å†…å®¹åˆ—ï¼šé€šå¸¸ç”¨äºç¬”è®°ï¼Œåªæ˜¾ç¤ºå›¾æ ‡å’Œå­—æ•°
                    columns.push({
                        title: colName || 'content',
                        orderable: false,
                        width: '100px',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                const paperIdIndex = row.length - 1;
                                const paperId = row[paperIdIndex];
                                const hasContent = data && data !== '-' && data.trim() !== '';
                                if (hasContent) {
                                    const length = data.length;
                                    return `<div class="abstract-cell has-content" style="border-color: var(--neon-cyan); width: auto; padding: 0 10px;" onclick="openAbstractModal('${paperId}', true)" title="æŸ¥çœ‹å®Œæ•´å†…å®¹">
                                        <span class="check-icon" style="color: var(--neon-cyan); margin-right: 5px;">ğŸ“„</span>
                                        <span style="font-size: 10px; color: var(--neon-cyan); opacity: 0.8;">${length}å­—</span>
                                    </div>`;
                                }
                            }
                            return '<span style="color: rgba(255,255,255,0.2);">-</span>';
                        }
                    });
                } else if (colKey === 'source') {
                    columns.push({
                        title: colName || 'source',
                        orderable: true,
                        width: '100px',
                        render: function(data, type, row) {
                            let color = 'rgba(255,255,255,0.6)';
                            if (data === 'note') color = 'var(--neon-green)';
                            if (data === 'email') color = 'var(--neon-cyan)';
                            if (data === 'pdf') color = 'var(--neon-purple)';
                            return `<span style="color: ${color}; font-weight: 600; text-transform: uppercase; font-size: 11px;">${data || 'unknown'}</span>`;
                        }
                    });
                } else {
                    // åªè¯»æ¨¡å¼ï¼Œæ‰€æœ‰åˆ—éƒ½ä¸å¯ç¼–è¾‘
                    const width = getColumnWidth(colKey);
                    columns.push({
                        title: colName || colKey,  // ç¡®ä¿titleæ˜¯å­—ç¬¦ä¸²
                        orderable: colKey !== 'abstract',
                        width: width || '150px',  // ä½¿ç”¨ç»Ÿä¸€çš„åˆ—å®½å‡½æ•°
                        render: function(data, type, row) {
                            // åªè¯»æ¨¡å¼ï¼Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                            return data || '-';
                        }
                    });
                }
            });
            
            // æ·»åŠ "æ“ä½œ"åˆ—ï¼ˆåŒ…å«åˆ é™¤æŒ‰é’®ï¼‰
            columns.push({
                title: 'actions',
                orderable: false,
                width: getColumnWidth('æ“ä½œ'),  // ä½¿ç”¨ç»Ÿä¸€çš„åˆ—å®½å‡½æ•°
                render: function(data, type, row) {
                    // paper_idåœ¨æœ€åä¸€åˆ—
                    const paperIdIndex = row.length - 1;
                    const paperId = row[paperIdIndex];
                    return `<button class="btn-action delete" onclick="deletePaper('${paperId}')" title="åˆ é™¤æ­¤è®ºæ–‡">åˆ é™¤</button>`;
                }
            });
            
            // æ·»åŠ éšè—çš„paper_idåˆ—ï¼ˆå¿…é¡»åœ¨æœ€åï¼‰
            columns.push({
                title: 'paper_id',
                visible: false,
                width: '0px'  // éšè—åˆ—ä¹Ÿéœ€è¦è®¾ç½®widthï¼Œé¿å…DataTablesè§£æé”™è¯¯
            });
            
            console.log('æ„å»ºå®Œæˆï¼Œæ€»åˆ—æ•°:', columns.length);
            // éªŒè¯æ‰€æœ‰åˆ—é…ç½®
            columns.forEach((col, idx) => {
                if (!col.title || typeof col.title !== 'string') {
                    console.error('åˆ—é…ç½®é”™è¯¯ - ç´¢å¼•:', idx, 'é…ç½®:', col);
                }
                if (col.width !== undefined && typeof col.width !== 'string') {
                    console.error('åˆ—å®½åº¦é…ç½®é”™è¯¯ - ç´¢å¼•:', idx, 'width:', col.width, 'ç±»å‹:', typeof col.width);
                }
            });
            return columns;
        }

        // æ„å»ºè¡¨æ ¼æ•°æ®
        function buildTableData(papers) {
            console.log('æ„å»ºè¡¨æ ¼æ•°æ®ï¼Œè®ºæ–‡æ•°é‡:', papers.length, 'å¯è§åˆ—æ•°:', visibleColumns.length);
            const result = papers.map(paper => {
                const row = [];
                visibleColumns.forEach(colKey => {
                    if (colKey === 'attachment_path') {
                        row.push(''); // è¿™äº›åˆ—ç”±renderå‡½æ•°ç”Ÿæˆ
                    } else if (colKey === 'abstract') {
                        // æ‘˜è¦åˆ—ï¼šä¼ é€’å®Œæ•´æ‘˜è¦å†…å®¹ï¼ˆä¸æˆªæ–­ï¼‰ï¼Œç”±renderå‡½æ•°å¤„ç†æ˜¾ç¤º
                        let value = getFieldValue(paper, colKey);
                        row.push(value || '');
                    } else {
                        let value = getFieldValue(paper, colKey);
                        row.push(value || '-');
                    }
                });
                row.push(''); // æ“ä½œåˆ—çš„å ä½æ•°æ®ï¼ˆç”±renderå‡½æ•°ç”Ÿæˆï¼‰
                row.push(paper.paper_id); // æ·»åŠ paper_idç”¨äºæ“ä½œï¼ˆéšè—åˆ—ï¼‰
                return row;
            });
            const expectedCols = visibleColumns.length + 2; // å¯è§åˆ— + æ“ä½œåˆ— + paper_id
            console.log('è¡¨æ ¼æ•°æ®æ„å»ºå®Œæˆï¼Œè¡Œæ•°:', result.length, 'æ¯è¡Œåˆ—æ•°:', result[0] ? result[0].length : 0, 'æœŸæœ›åˆ—æ•°:', expectedCols);
            if (result[0] && result[0].length !== expectedCols) {
                console.error('åˆ—æ•°ä¸åŒ¹é…ï¼æ•°æ®è¡Œæœ‰', result[0].length, 'åˆ—ï¼Œä½†æœŸæœ›', expectedCols, 'åˆ—');
            }
            return result;
        }

        // è·å–å­—æ®µå€¼
        function getFieldValue(paper, colKey) {
            let value = '';
            
            // ç›´æ¥ä½¿ç”¨colKeyä½œä¸ºå­—æ®µåï¼ˆå·²ç»æ˜¯æ•°æ®åº“å­—æ®µåï¼‰
            if (colKey === 'authors' && Array.isArray(paper[colKey])) {
                value = paper[colKey].join(', ');
            } else if (colKey === 'keywords' && Array.isArray(paper[colKey])) {
                value = paper[colKey].join(', ');
            } else if (colKey in paper) {
                // æ ‡å‡†å­—æ®µ
                value = paper[colKey] || '';
            } else {
                // è‡ªå®šä¹‰åˆ—ï¼ˆä»metadataä¸­è·å–ï¼‰
                const metadata = paper.metadata || {};
                value = metadata[colKey] || '';
            }
            
            return value || '';
        }

        // è·å–å­—æ®µå
        function getFieldName(colKey) {
            const fieldMap = {
                'æ ‡é¢˜': 'title',
                'æ ‡ç­¾': 'tag',
                'ä½œè€…': 'authors',
                'æ‘˜è¦': 'abstract',
                'å†…å®¹': 'content',
                'å…³é”®è¯': 'keywords'
            };
            return fieldMap[colKey] || colKey.toLowerCase();
        }

        // è·å–åˆ—å®½åº¦ï¼ˆä½¿ç”¨å›ºå®šåƒç´ å€¼ï¼Œç¡®ä¿åˆ—å®½åˆé€‚ä¸”èƒ½åœ¨ä¸€è¡Œæ˜¾ç¤ºï¼‰
        function getColumnWidth(colKey) {
            const widthMap = {
                'title': '200px',           // æ ‡é¢˜åˆ—
                'tag': '120px',            // æ ‡ç­¾åˆ—
                'think_points': '80px',     // Thinkç‚¹åˆ—
                'contextual_summary': '80px', // æ€»ç»“åˆ—
                'abstract': '70px',        // æ‘˜è¦åˆ—æ˜¾ç¤ºå›¾æ ‡
                'content': '70px',         // å†…å®¹åˆ—æ˜¾ç¤ºå›¾æ ‡
                'attachment_path': '100px', // PDFæ ‡è¯†åˆ—
                'æ“ä½œ': '80px'              // æ“ä½œåˆ—
            };
            return widthMap[colKey] || '150px'; 
        }

        // ç¼–è¾‘åŠŸèƒ½å·²ç§»é™¤ï¼Œä»¥ä¸‹å‡½æ•°ä¿ç•™ä½†ä¸å†ä½¿ç”¨
        function editCell(cell) {
            const $cell = $(cell);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç¼–è¾‘çŠ¶æ€ï¼ˆåŒ…å«inputæˆ–textareaå…ƒç´ ï¼‰
            if ($cell.find('input, textarea').length > 0) {
                return; // å¦‚æœå·²ç»åœ¨ç¼–è¾‘ï¼Œä¸é‡å¤è§¦å‘
            }
            
            const paperId = $cell.data('paper-id');
            const field = $cell.data('field');
            let currentValue = $cell.text().trim();
            
            // å¤„ç†"ç‚¹å‡»ç¼–è¾‘"æç¤ºæ–‡æœ¬
            if (currentValue === 'ç‚¹å‡»ç¼–è¾‘' || currentValue === '-') {
                currentValue = '';
            }
            
            const isLongText = field === 'abstract';
            
            let input;
            if (isLongText) {
                input = $('<textarea rows="3"></textarea>');
            } else {
                input = $('<input type="text">');
            }
            
            input.val(currentValue);
            input.css({
                width: '100%',
                minWidth: '200px',
                minHeight: '32px',
                padding: '4px 8px'
            });
            
            $cell.html(input);
            input.focus();
            input.select();
            
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢åŒå‡»è§¦å‘
            input.on('dblclick', function(e) {
                e.stopPropagation();
            });
            
            const saveEdit = function() {
                const newValue = input.val().trim();
                updatePaperField(paperId, field, newValue);
                // æ¢å¤ä¸ºå¯ç¼–è¾‘çš„span
                if (newValue) {
                    $cell.text(newValue);
                } else {
                    $cell.text(''); // ç©ºå­—ç¬¦ä¸²ï¼Œè®©:emptyä¼ªç±»ç”Ÿæ•ˆæ˜¾ç¤º"ç‚¹å‡»ç¼–è¾‘"
                }
                // ç¡®ä¿ä¿æŒå¯ç¼–è¾‘çŠ¶æ€å’Œå±æ€§
                $cell.attr('onclick', `editCell(this)`);
                $cell.attr('data-paper-id', paperId);
                $cell.attr('data-field', field);
            };
            
            const cancelEdit = function() {
                // æ¢å¤ä¸ºå¯ç¼–è¾‘çš„spanï¼Œä¿æŒåŸå§‹å€¼
                if (currentValue) {
                    $cell.text(currentValue);
                } else {
                    $cell.text(''); // ç©ºå­—ç¬¦ä¸²ï¼Œè®©:emptyä¼ªç±»ç”Ÿæ•ˆæ˜¾ç¤º"ç‚¹å‡»ç¼–è¾‘"
                }
                // ç¡®ä¿ä¿æŒå¯ç¼–è¾‘çŠ¶æ€å’Œå±æ€§
                $cell.attr('onclick', `editCell(this)`);
                $cell.attr('data-paper-id', paperId);
                $cell.attr('data-field', field);
            };
            
            input.on('blur', saveEdit);
            input.on('keydown', function(e) {
                if (e.key === 'Enter' && !isLongText) {
                    e.preventDefault();
                    input.blur(); // è§¦å‘bluräº‹ä»¶ï¼Œä¿å­˜ç¼–è¾‘
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }

        // åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰“å¼€æ–‡ä»¶ä½ç½®
        function openFileLocation(path) {
            if (!path) return;
            
            fetch('/api/system/open_folder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path: path })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æç¤ºç”¨æˆ·å·²åœ¨åå°æ‰“å¼€
                    alert('æ–‡ä»¶å¤¹å·²åœ¨åå°æ‰“å¼€å¹¶å®šä½æ–‡ä»¶');
                } else {
                    alert('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('æ‰“å¼€æ–‡ä»¶å¤¹å‡ºé”™:', error);
                alert('ç³»ç»Ÿé”™è¯¯: ' + error.message);
            });
        }

        // æ‰“å¼€æ‘˜è¦æŸ¥çœ‹æ¨¡æ€æ¡†ï¼ˆåªè¯»ï¼‰
        function openAbstractModal(paperId, type = 'abstract') {
            const paper = papersData.find(p => p.paper_id === paperId);
            if (!paper) {
                alert('æœªæ‰¾åˆ°è¯¥è®ºæ–‡');
                return;
            }
            
            let title = 'æ‘˜è¦æŸ¥çœ‹';
            let text = paper.abstract || 'æš‚æ— æ‘˜è¦';
            
            if (type === 'content') {
                title = 'å†…å®¹æŸ¥çœ‹';
                text = paper.content || 'æš‚æ— å†…å®¹';
            } else if (type === 'think') {
                title = 'ğŸ’¡ å¤§è„‘æ€è€ƒç‚¹ (Think Points)';
                const points = paper.think_points;
                if (Array.isArray(points)) {
                    text = points.map((p, i) => `${i+1}. ${p}`).join('\n\n');
                } else if (typeof points === 'string') {
                    try {
                        const parsed = JSON.parse(points);
                        text = Array.isArray(parsed) ? parsed.map((p, i) => `${i+1}. ${p}`).join('\n\n') : points;
                    } catch(e) { text = points; }
                } else {
                    text = 'å°šæœªç”Ÿæˆæ€è€ƒç‚¹ã€‚';
                }
            } else if (type === 'summary') {
                title = 'ğŸ§© å…³è”èƒŒæ™¯æ€»ç»“';
                text = paper.contextual_summary || 'å°šæœªç”Ÿæˆå…³è”æ€»ç»“ã€‚';
            }
            
            const $modal = $('#abstract-modal');
            const $abstractDiv = $('#abstract-textarea');
            const $modalTitle = $modal.find('h3');
            
            if ($modalTitle.length) $modalTitle.text(title);
            $abstractDiv.text(text);
            $modal.data('paper-id', paperId);
            $modal.addClass('active');
        }

        // å…³é—­æ‘˜è¦æŸ¥çœ‹æ¨¡æ€æ¡†
        function closeAbstractModal() {
            const $modal = $('#abstract-modal');
            $modal.removeClass('active');
        }

        // åˆ é™¤è®ºæ–‡
        function deletePaper(paperId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡è®ºæ–‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            fetch('/api/papers/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    paper_id: paperId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
                    papersData = papersData.filter(p => p.paper_id !== paperId);
                    
                    // æ›´æ–°è®ºæ–‡æ•°é‡
                    $('#paper-count').text(`å…± ${papersData.length} ç¯‡è®ºæ–‡`);
                    
                    // é‡æ–°åŠ è½½è¡¨æ ¼
                    reloadTable();
                    
                    console.log('åˆ é™¤æˆåŠŸ');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            });
        }

        // æ›´æ–°è®ºæ–‡å­—æ®µ
        function updatePaperField(paperId, field, value) {
            fetch('/api/papers/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    paper_id: paperId,
                    field: field,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    const paper = papersData.find(p => p.paper_id === paperId);
                    if (paper) {
                        if (['title', 'tag', 'authors', 'abstract', 'keywords'].includes(field)) {
                            paper[field] = value;
                        } else {
                            // è‡ªå®šä¹‰å­—æ®µå­˜å‚¨åœ¨metadataä¸­
                            if (!paper.metadata) {
                                paper.metadata = {};
                            }
                            paper.metadata[field] = value;
                        }
                    }
                    console.log('æ›´æ–°æˆåŠŸ');
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('æ›´æ–°å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            });
        }

        // å¯¼å‡ºCSVï¼ˆå¯¼å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰å­—æ®µï¼‰
        function exportToCSV() {
            if (!papersData || papersData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // å®šä¹‰æ‰€æœ‰æ•°æ®åº“å­—æ®µï¼ˆæ ‡å‡†å­—æ®µï¼Œä½¿ç”¨æ•°æ®åº“å­—æ®µåï¼‰
            const standardFields = [
                { key: 'paper_id', label: 'paper_id' },
                { key: 'title', label: 'title' },
                { key: 'authors', label: 'authors' },
                { key: 'abstract', label: 'abstract' },
                { key: 'keywords', label: 'keywords' },
                { key: 'year', label: 'year' },
                { key: 'journal', label: 'journal' },
                { key: 'doi', label: 'doi' },
                { key: 'url', label: 'url' },
                { key: 'source', label: 'source' },
                { key: 'source_id', label: 'source_id' },
                { key: 'attachment_path', label: 'attachment_path' },
                { key: 'zotero_key', label: 'zotero_key' },
                { key: 'obsidian_note_path', label: 'obsidian_note_path' },
                { key: 'created_at', label: 'created_at' },
                { key: 'updated_at', label: 'updated_at' }
            ];
            
            // æ”¶é›†æ‰€æœ‰metadataä¸­çš„è‡ªå®šä¹‰å­—æ®µï¼ˆä»æ‰€æœ‰è®ºæ–‡ä¸­æ”¶é›†ï¼‰
            const customFieldsSet = new Set();
            papersData.forEach(paper => {
                const metadata = paper.metadata || {};
                if (metadata && typeof metadata === 'object') {
                    Object.keys(metadata).forEach(key => {
                        // æ’é™¤å·²ç»åœ¨æ ‡å‡†å­—æ®µä¸­çš„å­—æ®µ
                        if (!standardFields.find(f => f.key === key)) {
                            customFieldsSet.add(key);
                        }
                    });
                }
            });
            
            console.log('æ”¶é›†åˆ°çš„è‡ªå®šä¹‰å­—æ®µ:', Array.from(customFieldsSet));
            
            // å°†è‡ªå®šä¹‰å­—æ®µè½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const customFields = Array.from(customFieldsSet).sort().map(key => ({
                key: key,
                label: key  // ä½¿ç”¨å­—æ®µåä½œä¸ºæ ‡ç­¾
            }));
            
            // åˆå¹¶æ‰€æœ‰å­—æ®µ
            const allFields = [...standardFields, ...customFields];
            const headers = allFields.map(f => f.label);
            
            console.log('å¯¼å‡ºCSVçš„å­—æ®µåˆ—è¡¨:', headers);
            
            // æ„å»ºCSVå†…å®¹
            let csvContent = headers.join(',') + '\n';
            
            papersData.forEach(paper => {
                const row = [];
                allFields.forEach(field => {
                    let value = '';
                    
                    if (field.key === 'paper_id') {
                        value = paper.paper_id || '';
                    } else if (field.key === 'title') {
                        value = paper.title || paper.paper_title || '';
                    } else if (field.key === 'authors') {
                        // authorså¯èƒ½æ˜¯æ•°ç»„æˆ–å­—ç¬¦ä¸²
                        if (Array.isArray(paper.authors)) {
                            value = paper.authors.join('; ');
                        } else if (typeof paper.authors === 'string') {
                            value = paper.authors;
                        } else {
                            value = '';
                        }
                    } else if (field.key === 'abstract') {
                        value = paper.abstract || '';
                    } else if (field.key === 'keywords') {
                        // keywordså¯èƒ½æ˜¯æ•°ç»„æˆ–å­—ç¬¦ä¸²
                        if (Array.isArray(paper.keywords)) {
                            value = paper.keywords.join('; ');
                        } else if (typeof paper.keywords === 'string') {
                            value = paper.keywords;
                        } else {
                            value = '';
                        }
                    } else if (field.key === 'attachment_path') {
                        // PDFè·¯å¾„ï¼šæ˜¾ç¤ºç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äºdatabaseç›®å½•ï¼‰
                        const pdfPath = paper.attachment_path || paper.paper_path || '';
                        if (pdfPath) {
                            // æå–ç›¸å¯¹è·¯å¾„ï¼ˆdatabase/æ–‡ä»¶åï¼‰
                            const parts = pdfPath.replace(/\\/g, '/').split('/');
                            const dbIndex = parts.indexOf('database');
                            if (dbIndex >= 0 && dbIndex < parts.length - 1) {
                                value = 'database/' + parts.slice(dbIndex + 1).join('/');
                            } else {
                                value = pdfPath;
                            }
                        }
                    } else if (field.key === 'created_at' || field.key === 'updated_at') {
                        // æ—¶é—´å­—æ®µï¼Œç›´æ¥ä½¿ç”¨åŸå§‹å€¼
                        value = paper[field.key] || '';
                    } else if (standardFields.find(f => f.key === field.key)) {
                        // å…¶ä»–æ ‡å‡†å­—æ®µ
                        value = paper[field.key] || '';
                    } else {
                        // è‡ªå®šä¹‰å­—æ®µï¼ˆä»metadataä¸­è·å–ï¼‰
                        const metadata = paper.metadata || {};
                        if (metadata && typeof metadata === 'object') {
                            const fieldValue = metadata[field.key];
                            if (fieldValue !== undefined && fieldValue !== null) {
                                // å¦‚æœæ˜¯å¯¹è±¡æˆ–æ•°ç»„ï¼Œè½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                                if (typeof fieldValue === 'object' && !Array.isArray(fieldValue)) {
                                    value = JSON.stringify(fieldValue);
                                } else if (Array.isArray(fieldValue)) {
                                    value = fieldValue.join('; ');
                                } else {
                                    value = String(fieldValue);
                                }
                            }
                        }
                    }
                    
                    // CSVè½¬ä¹‰ï¼šå¦‚æœåŒ…å«é€—å·ã€å¼•å·æˆ–æ¢è¡Œç¬¦ï¼Œéœ€è¦ç”¨å¼•å·åŒ…è£¹ï¼Œå¹¶è½¬ä¹‰å¼•å·
                    const stringValue = String(value || '');
                    if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\r')) {
                        value = '"' + stringValue.replace(/"/g, '""') + '"';
                    } else {
                        value = stringValue;
                    }
                    row.push(value);
                });
                csvContent += row.join(',') + '\n';
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' }); // æ·»åŠ BOMä»¥æ”¯æŒExcelä¸­æ–‡
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `papers_all_data_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ‰“å¼€CSVä¸Šä¼ æ¨¡æ€æ¡†
        function openCSVUploadModal() {
            $('#csv-upload-modal').addClass('active');
            $('#csv-file-input').val('');
            $('#csv-file-name').text('');
            $('#csv-upload-status').html('');
            $('#btn-upload-csv').prop('disabled', true);
        }

        // å…³é—­CSVä¸Šä¼ æ¨¡æ€æ¡†
        function closeCSVUploadModal() {
            $('#csv-upload-modal').removeClass('active');
        }

        // åˆå§‹åŒ–CSVä¸Šä¼ æ¨¡æ€æ¡†
        function initCSVUploadModal() {
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶ - ç«‹å³è¿›è¡Œæ¯”è¾ƒ
            $('#csv-file-input').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    $('#csv-file-name').text('å·²é€‰æ‹©: ' + file.name);
                    $('#btn-upload-csv').prop('disabled', true).text('æ¯”è¾ƒä¸­...');
                    $('#csv-upload-status').html('<div style="color: rgba(0, 217, 255, 0.8);">æ­£åœ¨æ¯”è¾ƒCSVæ–‡ä»¶ä¸æ•°æ®åº“...</div>');
                    
                    // ç«‹å³è¿›è¡Œæ¯”è¾ƒ
                    compareCSVFile(file);
                } else {
                    $('#csv-file-name').text('');
                    $('#csv-upload-status').html('');
                    $('#btn-upload-csv').prop('disabled', true).text('ä¸Šä¼ ');
                }
            });
            
            // å…³é—­æŒ‰é’®
            $('#csv-upload-modal-close').on('click', closeCSVUploadModal);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            $('#csv-upload-modal').on('click', function(e) {
                if (e.target === this) {
                    closeCSVUploadModal();
                }
            });
        }
        
        // æ¯”è¾ƒCSVæ–‡ä»¶ï¼ˆä¸æ›´æ–°æ•°æ®åº“ï¼‰- è°ƒç”¨åç«¯API
        async function compareCSVFile(file) {
            try {
                const formData = new FormData();
                formData.append('csv_file', file);
                
                const response = await fetch('/api/papers/compare_csv', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let statusHtml = '<div style="color: rgba(0, 217, 255, 0.9);">';
                    statusHtml += `ğŸ“Š æ¯”è¾ƒå®Œæˆ<br>`;
                    statusHtml += `å…± ${data.total_rows || 0} è¡Œæ•°æ®<br>`;
                    statusHtml += `å‘ç° ${data.total_differences || 0} æ¡è®°å½•æœ‰å·®å¼‚<br><br>`;
                    
                    // æ˜¾ç¤ºæ–°åˆ—
                    if (data.new_columns && data.new_columns.length > 0) {
                        statusHtml += `<div style="color: #fbbf24; margin-top: 10px;">
                            ğŸ“‹ æ£€æµ‹åˆ° ${data.new_columns.length} ä¸ªæ–°åˆ—ï¼š<br>`;
                        data.new_columns.forEach(col => {
                            statusHtml += `&nbsp;&nbsp;â€¢ ${col.name || col}<br>`;
                        });
                        statusHtml += `</div>`;
                    }
                    
                    // æ˜¾ç¤ºå·®å¼‚è¯¦æƒ…ï¼ˆæœ€å¤šæ˜¾ç¤ºå‰10æ¡ï¼‰
                    if (data.differences && data.differences.length > 0) {
                        statusHtml += `<div style="margin-top: 15px; max-height: 300px; overflow-y: auto; border: 1px solid rgba(0, 217, 255, 0.3); padding: 10px; border-radius: 6px;">`;
                        statusHtml += `<strong style="color: rgba(0, 217, 255, 0.9);">å·®å¼‚è¯¦æƒ…ï¼š</strong><br>`;
                        
                        const showCount = Math.min(10, data.differences.length);
                        for (let i = 0; i < showCount; i++) {
                            const diff = data.differences[i];
                            statusHtml += `<div style="margin-top: 8px; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">`;
                            statusHtml += `<strong>${diff.title || diff.paper_id}</strong><br>`;
                            diff.differences.forEach(fieldDiff => {
                                statusHtml += `&nbsp;&nbsp;â€¢ <span style="color: #fbbf24;">${fieldDiff.field}</span>: `;
                                const oldVal = String(fieldDiff.old_value || '').substring(0, 30);
                                const newVal = String(fieldDiff.new_value || '').substring(0, 30);
                                statusHtml += `<span style="color: #f87171;">"${oldVal}${String(fieldDiff.old_value || '').length > 30 ? '...' : ''}"</span> â†’ `;
                                statusHtml += `<span style="color: #4ade80;">"${newVal}${String(fieldDiff.new_value || '').length > 30 ? '...' : ''}"</span><br>`;
                            });
                            statusHtml += `</div>`;
                        }
                        
                        if (data.differences.length > 10) {
                            statusHtml += `<div style="margin-top: 8px; color: rgba(255, 255, 255, 0.6); font-size: 12px;">... è¿˜æœ‰ ${data.differences.length - 10} æ¡å·®å¼‚æœªæ˜¾ç¤º</div>`;
                        }
                        statusHtml += `</div>`;
                    } else {
                        statusHtml += `<div style="color: #4ade80; margin-top: 10px;">âœ“ æœªå‘ç°å·®å¼‚ï¼Œæ•°æ®ä¸æ•°æ®åº“ä¸€è‡´</div>`;
                    }
                    
                    statusHtml += '</div>';
                    $('#csv-upload-status').html(statusHtml);
                    
                    // å¯ç”¨ä¸Šä¼ æŒ‰é’®
                    $('#btn-upload-csv').prop('disabled', false).text('ç¡®è®¤ä¸Šä¼ ');
                } else {
                    $('#csv-upload-status').html(`<div style="color: #f87171;">æ¯”è¾ƒå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`);
                    $('#btn-upload-csv').prop('disabled', true).text('ä¸Šä¼ ');
                }
            } catch (error) {
                console.error('æ¯”è¾ƒCSVå¤±è´¥:', error);
                $('#csv-upload-status').html(`<div style="color: #f87171;">æ¯”è¾ƒå¤±è´¥: ${error.message}</div>`);
                $('#btn-upload-csv').prop('disabled', true).text('ä¸Šä¼ ');
            }
        }

        // è¯»å–CSVæ–‡ä»¶å¹¶æ¯”è¾ƒå·®å¼‚ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
        function compareCSVWithDatabase(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        if (lines.length < 2) {
                            reject(new Error('CSVæ–‡ä»¶è‡³å°‘éœ€è¦è¡¨å¤´å’Œæ•°æ®è¡Œ'));
                            return;
                        }
                        
                        // è§£æCSVï¼ˆç®€å•å®ç°ï¼Œå¤„ç†å¼•å·å’Œé€—å·ï¼‰
                        const parseCSVLine = (line) => {
                            const result = [];
                            let current = '';
                            let inQuotes = false;
                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];
                                if (char === '"') {
                                    if (inQuotes && line[i + 1] === '"') {
                                        current += '"';
                                        i++; // è·³è¿‡ä¸‹ä¸€ä¸ªå¼•å·
                                    } else {
                                        inQuotes = !inQuotes;
                                    }
                                } else if (char === ',' && !inQuotes) {
                                    result.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            result.push(current.trim());
                            return result;
                        };
                        
                        // è§£æè¡¨å¤´
                        const headers = parseCSVLine(lines[0]);
                        const headerMap = {};
                        headers.forEach((h, i) => {
                            headerMap[h] = i;
                        });
                        
                        // å­—æ®µæ˜ å°„
                        const fieldMapping = {
                            'æ ‡é¢˜/Title': 'title',
                            'æ ‡é¢˜': 'title',
                            'Title': 'title',
                            'æ ‡ç­¾/Tag': 'tag',
                            'æ ‡ç­¾': 'tag',
                            'Tag': 'tag',
                            'ä½œè€…/Authors': 'authors',
                            'ä½œè€…': 'authors',
                            'Authors': 'authors',
                            'æ¥æº/Source': 'source',
                            'æ¥æº': 'source',
                            'Source': 'source',
                            'æ‘˜è¦/Abstract': 'abstract',
                            'æ‘˜è¦': 'abstract',
                            'Abstract': 'abstract',
                            'å…³é”®è¯/Keywords': 'keywords',
                            'å…³é”®è¯': 'keywords',
                            'Keywords': 'keywords',
                            'å…¨æ–‡PDF/Full PDF': 'pdf_path',
                            'å…¨æ–‡PDF': 'pdf_path',
                            'Full PDF': 'pdf_path'
                        };
                        
                        // æ„å»ºæ•°æ®åº“å­—æ®µåˆ°CSVåˆ—çš„æ˜ å°„
                        const dbFieldToCSVCol = {};
                        Object.keys(fieldMapping).forEach(csvHeader => {
                            const dbField = fieldMapping[csvHeader];
                            if (headerMap.hasOwnProperty(csvHeader)) {
                                dbFieldToCSVCol[dbField] = headerMap[csvHeader];
                            }
                        });
                        
                        // åˆ›å»ºè®ºæ–‡æŸ¥æ‰¾ç´¢å¼•ï¼ˆåŸºäºæ ‡é¢˜å’ŒPDFè·¯å¾„ï¼‰
                        const paperIndex = {};
                        papersData.forEach(paper => {
                            const key = (paper.title || paper.paper_title || '') + '|' + (paper.attachment_path || paper.paper_path || '');
                            paperIndex[key] = paper;
                        });
                        
                        // è§£ææ•°æ®è¡Œå¹¶æ¯”è¾ƒå·®å¼‚
                        const differences = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const values = parseCSVLine(line);
                            if (values.length !== headers.length) {
                                console.warn(`CSVç¬¬${i + 1}è¡Œåˆ—æ•°ä¸åŒ¹é…ï¼Œè·³è¿‡`);
                                continue;
                            }
                            
                            // è·å–æ ‡é¢˜å’ŒPDFè·¯å¾„ç”¨äºåŒ¹é…
                            const titleCol = dbFieldToCSVCol['title'];
                            const pdfCol = dbFieldToCSVCol['pdf_path'];
                            const title = titleCol !== undefined ? values[titleCol] : '';
                            let pdfPath = pdfCol !== undefined ? values[pdfCol] : '';
                            
                            // å¤„ç†PDFè·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„è½¬ç»å¯¹è·¯å¾„ï¼‰
                            if (pdfPath && pdfPath.startsWith('database/')) {
                                pdfPath = pdfPath; // ä¿æŒç›¸å¯¹è·¯å¾„ï¼Œåç«¯ä¼šå¤„ç†
                            }
                            
                            // æŸ¥æ‰¾åŒ¹é…çš„è®ºæ–‡
                            const matchKey = title + '|' + pdfPath;
                            const existingPaper = paperIndex[matchKey];
                            
                            if (!existingPaper) {
                                // å°è¯•é€šè¿‡æ ‡é¢˜å•ç‹¬åŒ¹é…
                                const titleMatch = papersData.find(p => 
                                    (p.title || p.paper_title || '').trim() === title.trim()
                                );
                                if (titleMatch) {
                                    differences.push({
                                        paper_id: titleMatch.paper_id,
                                        row_index: i + 1,
                                        changes: {}
                                    });
                                    // ç»§ç»­æ¯”è¾ƒå­—æ®µå·®å¼‚
                                    Object.keys(dbFieldToCSVCol).forEach(dbField => {
                                        const csvColIndex = dbFieldToCSVCol[dbField];
                                        if (csvColIndex !== undefined) {
                                            const csvValue = values[csvColIndex] || '';
                                            let dbValue = '';
                                            
                                            if (dbField === 'title') {
                                                dbValue = titleMatch.title || titleMatch.paper_title || '';
                                            } else if (dbField === 'authors') {
                                                dbValue = Array.isArray(titleMatch.authors) 
                                                    ? titleMatch.authors.join(', ') 
                                                    : (titleMatch.authors || '');
                                            } else if (dbField === 'keywords') {
                                                dbValue = Array.isArray(titleMatch.keywords) 
                                                    ? titleMatch.keywords.join(', ') 
                                                    : (titleMatch.keywords || '');
                                            } else if (dbField === 'pdf_path') {
                                                dbValue = titleMatch.attachment_path || titleMatch.paper_path || '';
                                                // è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„è¿›è¡Œæ¯”è¾ƒ
                                                if (dbValue) {
                                                    const parts = dbValue.replace(/\\/g, '/').split('/');
                                                    const dbIndex = parts.indexOf('database');
                                                    if (dbIndex >= 0) {
                                                        dbValue = 'database/' + parts.slice(dbIndex + 1).join('/');
                                                    }
                                                }
                                            } else {
                                                dbValue = titleMatch[dbField] || '';
                                            }
                                            
                                            // æ¯”è¾ƒå€¼æ˜¯å¦ä¸åŒ
                                            if (csvValue.trim() !== dbValue.trim()) {
                                                differences[differences.length - 1].changes[dbField] = csvValue.trim();
                                            }
                                        }
                                    });
                                    
                                    // æ£€æµ‹æ–°åˆ—ï¼ˆä¸åœ¨fieldMappingä¸­çš„åˆ—ï¼‰
                                    headers.forEach((header, colIndex) => {
                                        if (!fieldMapping.hasOwnProperty(header) && values[colIndex]) {
                                            const csvValue = values[colIndex].trim();
                                            if (csvValue) {
                                                // æ£€æŸ¥metadataä¸­æ˜¯å¦æœ‰è¿™ä¸ªå­—æ®µ
                                                const metadata = titleMatch.metadata || {};
                                                const dbValue = metadata[header] || '';
                                                
                                                // å¦‚æœCSVä¸­æœ‰å€¼ä½†æ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œæˆ–è€…å€¼ä¸åŒï¼Œåˆ™æ ‡è®°ä¸ºå·®å¼‚
                                                if (csvValue !== dbValue) {
                                                    differences[differences.length - 1].changes[header] = csvValue;
                                                }
                                            }
                                        }
                                    });
                                }
                                continue;
                            }
                            
                            // æ¯”è¾ƒå­—æ®µå·®å¼‚
                            const changes = {};
                            
                            // æ¯”è¾ƒå·²çŸ¥å­—æ®µ
                            Object.keys(dbFieldToCSVCol).forEach(dbField => {
                                const csvColIndex = dbFieldToCSVCol[dbField];
                                if (csvColIndex !== undefined) {
                                    const csvValue = values[csvColIndex] || '';
                                    let dbValue = '';
                                    
                                    if (dbField === 'title') {
                                        dbValue = existingPaper.title || existingPaper.paper_title || '';
                                    } else if (dbField === 'authors') {
                                        dbValue = Array.isArray(existingPaper.authors) 
                                            ? existingPaper.authors.join(', ') 
                                            : (existingPaper.authors || '');
                                    } else if (dbField === 'keywords') {
                                        dbValue = Array.isArray(existingPaper.keywords) 
                                            ? existingPaper.keywords.join(', ') 
                                            : (existingPaper.keywords || '');
                                    } else if (dbField === 'pdf_path') {
                                        dbValue = existingPaper.attachment_path || existingPaper.paper_path || '';
                                        // è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„è¿›è¡Œæ¯”è¾ƒ
                                        if (dbValue) {
                                            const parts = dbValue.replace(/\\/g, '/').split('/');
                                            const dbIndex = parts.indexOf('database');
                                            if (dbIndex >= 0) {
                                                dbValue = 'database/' + parts.slice(dbIndex + 1).join('/');
                                            }
                                        }
                                    } else {
                                        dbValue = existingPaper[dbField] || '';
                                    }
                                    
                                    // æ¯”è¾ƒå€¼æ˜¯å¦ä¸åŒ
                                    if (csvValue.trim() !== dbValue.trim()) {
                                        changes[dbField] = csvValue.trim();
                                    }
                                }
                            });
                            
                            // æ£€æµ‹æ–°åˆ—ï¼ˆä¸åœ¨fieldMappingä¸­çš„åˆ—ï¼‰
                            headers.forEach((header, colIndex) => {
                                if (!fieldMapping.hasOwnProperty(header) && values[colIndex]) {
                                    const csvValue = values[colIndex].trim();
                                    if (csvValue) {
                                        // æ£€æŸ¥metadataä¸­æ˜¯å¦æœ‰è¿™ä¸ªå­—æ®µ
                                        const metadata = existingPaper.metadata || {};
                                        const dbValue = metadata[header] || '';
                                        
                                        // å¦‚æœCSVä¸­æœ‰å€¼ä½†æ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œæˆ–è€…å€¼ä¸åŒï¼Œåˆ™æ ‡è®°ä¸ºå·®å¼‚
                                        if (csvValue !== dbValue) {
                                            changes[header] = csvValue; // ä½¿ç”¨åˆ—åä½œä¸ºkey
                                        }
                                    }
                                }
                            });
                            
                            // å¦‚æœæœ‰å·®å¼‚ï¼Œæ·»åŠ åˆ°å·®å¼‚åˆ—è¡¨
                            if (Object.keys(changes).length > 0) {
                                differences.push({
                                    paper_id: existingPaper.paper_id,
                                    row_index: i + 1,
                                    changes: changes
                                });
                            }
                        }
                        
                        // æ£€æµ‹æ–°åˆ—ï¼ˆä¸åœ¨fieldMappingä¸­çš„åˆ—ï¼‰
                        const newColumns = [];
                        headers.forEach(header => {
                            if (!fieldMapping.hasOwnProperty(header)) {
                                newColumns.push({
                                    name: header,
                                    display: header
                                });
                            }
                        });
                        
                        resolve({
                            total_rows: lines.length - 1,
                            differences: differences,
                            headers: headers,
                            new_columns: newColumns  // è¿”å›æ–°åˆ—ä¿¡æ¯
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }

        // ä¸Šä¼ CSVï¼ˆåç«¯å¤„ç†æ¯”è¾ƒå’Œæ›´æ–°ï¼‰
        // æ¸…ç†æ— ç”¨PDFæ–‡ä»¶
        async function cleanupUnusedPDFs() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ— ç”¨çš„PDFæ–‡ä»¶å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤databaseç›®å½•ä¸­ä¸åœ¨æ•°æ®åº“attachment_pathå­—æ®µä¸­çš„PDFæ–‡ä»¶ã€‚\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            const btn = document.getElementById('btn-cleanup-pdfs');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'æ¸…ç†ä¸­...';
            
            try {
                const response = await fetch('/api/papers/cleanup_unused_pdfs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const deletedCount = data.deleted_files?.length || 0;
                    const totalSize = data.total_size_mb || 0;
                    let message = `æ¸…ç†å®Œæˆï¼\n\nå·²åˆ é™¤ ${deletedCount} ä¸ªæ— ç”¨PDFæ–‡ä»¶`;
                    if (totalSize > 0) {
                        message += `\né‡Šæ”¾ç©ºé—´: ${totalSize.toFixed(2)} MB`;
                    }
                    
                    if (data.deleted_files && data.deleted_files.length > 0) {
                        message += `\n\nåˆ é™¤çš„æ–‡ä»¶ï¼š\n${data.deleted_files.slice(0, 10).join('\n')}`;
                        if (data.deleted_files.length > 10) {
                            message += `\n... è¿˜æœ‰ ${data.deleted_files.length - 10} ä¸ªæ–‡ä»¶`;
                        }
                    }
                    
                    alert(message);
                } else {
                    alert(`æ¸…ç†å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ¸…ç†PDFå¤±è´¥:', error);
                alert(`æ¸…ç†å¤±è´¥: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function uploadCSV() {
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©CSVæ–‡ä»¶');
                return;
            }
            
            $('#btn-upload-csv').prop('disabled', true).text('ä¸Šä¼ ä¸­...');
            $('#csv-upload-status').html('<div style="color: rgba(0, 217, 255, 0.8);">æ­£åœ¨ä¸Šä¼ CSVæ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ¯”è¾ƒå¹¶æ›´æ–°æ•°æ®åº“...</div>');
            
            try {
                // ç›´æ¥ä¸Šä¼ æ–‡ä»¶ï¼Œåç«¯ä¼šç”Ÿæˆæ ‡å‡†CSVå¹¶æ¯”è¾ƒ
                const formData = new FormData();
                formData.append('csv_file', file);
                
                const response = await fetch('/api/papers/upload_csv', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let statusHtml = `<div style="color: #4ade80;">
                        âœ… åŒæ­¥æˆåŠŸï¼<br>
                        æ›´æ–°äº† ${data.updated || 0} æ¡è®°å½•<br>
                        ${data.skipped || 0} æ¡è®°å½•è·³è¿‡`;
                    
                    // å¤„ç†æ–°åˆ—
                    if (data.new_columns && data.new_columns.length > 0) {
                        statusHtml += `<br><br>ğŸ“‹ æ£€æµ‹åˆ° ${data.new_columns.length} ä¸ªæ–°åˆ—ï¼š<br>`;
                        data.new_columns.forEach(col => {
                            statusHtml += `&nbsp;&nbsp;â€¢ ${col.name || col}<br>`;
                        });
                        statusHtml += `</div>`;
                    } else {
                        statusHtml += `</div>`;
                    }
                    
                    $('#csv-upload-status').html(statusHtml);
                    
                    // é‡æ–°åŠ è½½è¡¨æ ¼
                    setTimeout(function() {
                        loadPapersTable();
                        closeCSVUploadModal();
                    }, 2000);
                } else {
                    $('#csv-upload-status').html(`<div style="color: #f87171;">ä¸Šä¼ å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`);
                    $('#btn-upload-csv').prop('disabled', false).text('ä¸Šä¼ ');
                }
            } catch (error) {
                console.error('å¤„ç†å¤±è´¥:', error);
                $('#csv-upload-status').html(`<div style="color: #f87171;">å¤„ç†å¤±è´¥: ${error.message}</div>`);
                $('#btn-upload-csv').prop('disabled', false).text('ä¸Šä¼ ');
            }
        }
    </script>
</body>
</html>

