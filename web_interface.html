<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Summarizer - Â≠¶ÊúØËÆ∫ÊñáËá™Âä®ÊÄªÁªìÁ≥ªÁªü</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-cyan: #00d9ff;
            --neon-purple: #7b2cbf;
            --neon-green: #0f0;
            --neon-red: #ff0054;
            --neon-orange: #ffaa00;
            --dark-bg: #0a0e27;
            --dark-panel: rgba(10, 20, 40, 0.7);
            --dark-border: #00d9ff;
            --panel-left-bg: rgba(10, 20, 40, 0.7);
            --panel-center-bg: rgba(10, 20, 40, 0.7);
            --panel-right-bg: rgba(10, 20, 40, 0.7);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark-bg);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* ËÉåÊôØÁΩëÊ†ºÊïàÊûú */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 16px;
            background: var(--dark-bg);
            position: relative;
            z-index: 1;
            padding: 12px;
        }

        .panel {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            border: 2px solid var(--dark-border);
            background: var(--dark-panel);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3),
                        inset 0 0 20px rgba(0, 217, 255, 0.05);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        /* Âä®ÊÄÅÈúìËôπÂÖâËæπÁºòÊïàÊûú */
        .panel::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--neon-cyan), var(--neon-purple), var(--neon-cyan));
            border-radius: 12px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .panel:hover::before {
            opacity: 0.5;
            animation: borderGlow 2s infinite;
        }

        @keyframes borderGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        /* Â∑¶‰æßÈù¢Êùø - Êù•Ê∫ê */
        .left-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            background: var(--panel-left-bg);
            overflow: hidden;
        }

        .queue-status-bar {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .queue-label {
            margin-right: 8px;
        }

        .queue-count {
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 15px;
            text-shadow: 0 0 5px rgba(0, 217, 255, 0.5);
        }

        .queue-count.active {
            color: #ff9d00;
            text-shadow: 0 0 8px rgba(255, 157, 0, 0.6);
        }

        /* ‰∏≠Èó¥Èù¢Êùø - ÂØπËØù */
        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel-center-bg);
        }

        .center-panel .panel-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* Âè≥‰æßÈù¢Êùø - ÁîüÊàê */
        .right-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            background: var(--panel-right-bg);
        }

        .panel-header {
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 2px;
            color: var(--neon-cyan);
            margin: 0;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .settings-btn {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 18px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
        }

        .settings-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
            transform: translateY(-1px);
        }

        .settings-btn:active {
            transform: translateY(0);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            background: transparent;
        }

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° - Á¥†Ëâ≤Ê§≠ÂúÜÈïøÊù° */
        .panel-content::-webkit-scrollbar {
            width: 10px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .panel-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
            background-clip: padding-box;
        }

        /* Firefox ÊªöÂä®Êù°Ê†∑Âºè */
        .panel-content {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        /* ËøêË°åÈÄâÈ°πÂå∫Âüü */
        .run-options {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-bottom: 2px solid var(--dark-border);
            border-radius: 0 0 8px 8px;
            margin-bottom: 0;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .run-options.collapsed {
            max-height: 0;
            padding: 0;
            border-bottom: none;
            opacity: 0;
            margin: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .collapse-arrow-btn {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 30px;
            background: rgba(0, 217, 255, 0.3);
            border: 2px solid var(--neon-cyan);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            color: var(--neon-cyan);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 5;
            padding: 0;
            box-shadow: 0 -2px 8px rgba(0, 217, 255, 0.3);
        }

        .collapse-arrow-btn:hover {
            background: rgba(0, 217, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 217, 255, 0.4);
        }

        /* Áªü‰∏ÄÁöÑ‰ªªÂä°ÈòüÂàóÂå∫Âüü */
        .task-queue-section {
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--dark-border);
            border-bottom: 1px solid var(--dark-border);
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: calc(100vh - 500px);
            flex-shrink: 0;
            min-height: 100px;
        }

        /* ÂΩìrun-optionsÊäòÂè†Êó∂ÔºåÂ¢ûÂä†task-queue-sectionÁöÑÈ´òÂ∫¶ */
        .run-options.collapsed ~ .task-queue-section {
            max-height: calc(100vh - 250px);
        }

        .task-queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(0, 217, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .task-queue-tabs {
            display: flex;
            gap: 8px;
        }

        .task-tab {
            background: transparent;
            border: 1px solid rgba(0, 217, 255, 0.3);
            color: rgba(255, 255, 255, 0.6);
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Rajdhani', sans-serif;
        }

        .task-tab:hover {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .task-tab.active {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            box-shadow: 0 0 8px rgba(0, 217, 255, 0.3);
        }

        .task-queue-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .task-queue-panel {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }

        .task-queue-panel.active {
            display: flex;
        }

        .clear-files-btn {
            background: transparent;
            border: 1px solid rgba(255, 0, 84, 0.5);
            color: var(--neon-red);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Rajdhani', sans-serif;
        }

        .clear-files-btn:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            box-shadow: 0 0 8px rgba(255, 0, 84, 0.3);
        }

        .file-status-list {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }

        .file-status-empty {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            padding: 20px;
        }

        /* ÂæÖÂ§ÑÁêÜÊñáÁ´†ÂàóË°®Âå∫Âüü */
        .paper-processing-list {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè */
        .task-queue-panel::-webkit-scrollbar,
        .file-status-list::-webkit-scrollbar,
        .paper-processing-list::-webkit-scrollbar {
            width: 8px;
        }

        .task-queue-panel::-webkit-scrollbar-track,
        .file-status-list::-webkit-scrollbar-track,
        .paper-processing-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .task-queue-panel::-webkit-scrollbar-thumb,
        .file-status-list::-webkit-scrollbar-thumb,
        .paper-processing-list::-webkit-scrollbar-thumb {
            background: rgba(0, 217, 255, 0.3);
            border-radius: 4px;
        }

        .task-queue-panel::-webkit-scrollbar-thumb:hover,
        .file-status-list::-webkit-scrollbar-thumb:hover,
        .paper-processing-list::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 217, 255, 0.5);
        }

        .paper-processing-empty {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            padding: 20px;
        }

        .paper-processing-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .paper-processing-item:hover {
            border-color: var(--neon-cyan);
            background: rgba(0, 217, 255, 0.1);
        }

        .paper-processing-item.relevant {
            border-color: rgba(0, 255, 100, 0.5);
        }

        .paper-processing-item-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--neon-cyan);
            margin-bottom: 6px;
            line-height: 1.4;
            background: rgba(0, 217, 255, 0.15);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid var(--neon-cyan);
        }

        .paper-processing-item-title-cn {
            font-size: 13px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 6px;
            line-height: 1.4;
            background: rgba(0, 255, 136, 0.15);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #00ff88;
        }

        .paper-processing-item-title-bilingual {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }

        .paper-processing-item-explanation {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .paper-processing-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .paper-action-btn {
            flex: 1;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Rajdhani', sans-serif;
            border: 1px solid;
        }

        .paper-action-btn.interested {
            background: rgba(0, 255, 100, 0.1);
            border-color: rgba(0, 255, 100, 0.5);
            color: var(--neon-green);
        }

        .paper-action-btn.interested:hover {
            background: rgba(0, 255, 100, 0.2);
            border-color: var(--neon-green);
            box-shadow: 0 0 8px rgba(0, 255, 100, 0.3);
        }

        .paper-action-btn.not-interested {
            background: rgba(255, 0, 84, 0.1);
            border-color: rgba(255, 0, 84, 0.5);
            color: var(--neon-red);
        }

        .paper-action-btn.not-interested:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            box-shadow: 0 0 8px rgba(255, 0, 84, 0.3);
        }

        .paper-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .paper-action-btn.processing {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .paper-action-btn.not-interested.disabled-gray {
            background: rgba(128, 128, 128, 0.1);
            border-color: rgba(128, 128, 128, 0.3);
            color: rgba(255, 255, 255, 0.4);
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* AgentÂØºÂÖ•ÂºÄÂÖ≥Ê†∑Âºè */
        .agent-import-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .agent-import-toggle input[type="checkbox"] {
            width: 40px;
            height: 20px;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .agent-import-toggle input[type="checkbox"]:checked {
            background: rgba(0, 217, 255, 0.3);
            border-color: var(--neon-cyan);
        }

        .agent-import-toggle input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            top: 1px;
            left: 1px;
            transition: all 0.3s;
        }

        .agent-import-toggle input[type="checkbox"]:checked::before {
            left: 21px;
            background: var(--neon-cyan);
            box-shadow: 0 0 8px rgba(0, 217, 255, 0.5);
        }

        .toggle-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }

        .file-status-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            position: relative;
        }

        .file-status-item:hover {
            border-color: var(--neon-cyan);
            background: rgba(0, 217, 255, 0.1);
        }

        .file-status-item.uploading {
            border-color: rgba(0, 217, 255, 0.5);
            animation: pulse-border 2s infinite;
        }

        .file-status-item.parsing {
            border-color: rgba(255, 170, 0, 0.5);
            animation: pulse-border 2s infinite;
        }

        .file-status-item.processing {
            border-color: rgba(123, 44, 191, 0.5);
            animation: pulse-border 2s infinite;
        }

        .file-status-item.completed {
            border-color: rgba(0, 255, 0, 0.5);
        }

        .file-status-item.failed {
            border-color: rgba(255, 0, 84, 0.5);
        }

        @keyframes pulse-border {
            0%, 100% {
                box-shadow: 0 0 4px rgba(0, 217, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 12px rgba(0, 217, 255, 0.6);
            }
        }

        .file-status-icon {
            font-size: 20px;
            flex-shrink: 0;
            width: 24px;
            text-align: center;
        }

        .file-status-icon.uploading::after {
            content: '‚è≥';
        }

        .file-status-icon.parsing::after {
            content: 'üîç';
        }

        .file-status-icon.processing::after {
            content: '‚öôÔ∏è';
        }

        .file-status-icon.completed::after {
            content: '‚úì';
            color: var(--neon-green);
        }

        .file-status-icon.failed::after {
            content: '‚úó';
            color: var(--neon-red);
        }

        .file-status-info {
            flex: 1;
            min-width: 0;
        }

        .file-status-name {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-status-details {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .file-status-badge.uploading {
            background: rgba(0, 217, 255, 0.2);
            color: var(--neon-cyan);
        }

        .file-status-badge.parsing {
            background: rgba(255, 170, 0, 0.2);
            color: var(--neon-orange);
        }

        .file-status-badge.processing {
            background: rgba(123, 44, 191, 0.2);
            color: var(--neon-purple);
        }

        .file-status-badge.completed {
            background: rgba(0, 255, 0, 0.2);
            color: var(--neon-green);
        }

        .file-status-badge.failed {
            background: rgba(255, 0, 84, 0.2);
            color: var(--neon-red);
        }

        .file-status-progress {
            flex-shrink: 0;
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .file-status-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
            border-radius: 2px;
            transition: width 0.3s;
            animation: progress-shimmer 2s infinite;
        }

        @keyframes progress-shimmer {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 100% 0;
            }
        }

        .file-status-item.completed .file-status-progress-bar {
            background: var(--neon-green);
            width: 100%;
            animation: none;
        }

        .file-status-item.failed .file-status-progress-bar {
            background: var(--neon-red);
            width: 100%;
            animation: none;
        }

        .expand-arrow-btn {
            width: 100%;
            height: 24px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-top: none;
            border-bottom: 1px solid var(--dark-border);
            border-radius: 0 0 8px 8px;
            color: var(--neon-cyan);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            padding: 0;
        }

        .expand-arrow-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 217, 255, 0.3);
        }

        .expand-arrow-btn.hidden {
            display: none;
        }

        .option-group {
            margin-bottom: 15px;
        }

        .option-group label {
            display: block;
            font-size: 12px;
            color: var(--neon-cyan);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-option {
            position: relative;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--neon-cyan);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option input[type="radio"]:checked {
            background: var(--neon-cyan);
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        .radio-option input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: var(--dark-bg);
            border-radius: 50%;
        }

        .radio-option span {
            margin-left: 8px;
            color: #fff;
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 10px 15px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--neon-cyan);
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .file-select-button {
            width: 100%;
            padding: 10px 15px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
            position: relative;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .file-select-button:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
            transform: translateY(-1px);
        }

        .file-select-button:active {
            transform: translateY(0);
        }

        #file-select-text {
            pointer-events: none;
        }

        .file-drop-zone {
            width: 100%;
            min-height: 150px;
            border: 2px dashed var(--neon-cyan);
            border-radius: 8px;
            background: rgba(0, 217, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            margin-bottom: 10px;
        }

        .file-drop-zone:hover {
            border-color: var(--neon-purple);
            background: rgba(0, 217, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .file-drop-zone.drag-over {
            border-color: var(--neon-green);
            background: rgba(0, 255, 100, 0.1);
            box-shadow: 0 0 30px rgba(0, 255, 100, 0.5);
        }

        .file-drop-content {
            text-align: center;
            padding: 20px;
            pointer-events: none;  /* ËÆ©ÂÜÖÂÆπ‰∏çÈòªÊ≠¢ÁÇπÂáª‰∫ã‰ª∂ */
        }

        .file-drop-icon {
            font-size: 48px;
            margin-bottom: 10px;
            color: var(--neon-cyan);
        }

        .file-drop-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--neon-cyan);
            margin-bottom: 8px;
        }

        .file-drop-hint {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .pdf-drop-zone {
            width: 100%;
            min-height: 120px;
            border: 2px dashed var(--neon-cyan);
            border-radius: 8px;
            background: rgba(0, 217, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .pdf-drop-zone:hover {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        .pdf-drop-zone.drag-over {
            background: rgba(0, 217, 255, 0.15);
            border-color: var(--neon-green);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
        }

        .pdf-drop-content {
            text-align: center;
            padding: 20px;
            pointer-events: none;
        }

        .pdf-drop-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .pdf-drop-text {
            font-size: 16px;
            color: var(--neon-cyan);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .pdf-drop-hint {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .date-inputs {
            display: flex;
            gap: 10px;
        }

        .date-inputs input {
            flex: 1;
        }

        .run-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            border: 2px solid var(--neon-cyan);
            border-radius: 8px;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .run-button::before {
            content: '‚ñ∂';
            margin-right: 8px;
        }

        .run-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.8);
        }

        .run-button:active {
            transform: translateY(0);
        }


        .run-button.running {
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-red));
            animation: pulse 2s infinite;
        }

        .run-button.waiting {
            background: linear-gradient(135deg, var(--neon-orange), var(--neon-red));
            animation: pulse 2s infinite;
        }

        .run-button.waiting::before {
            content: '‚è∏';
        }

        .run-button.waiting:hover {
            background: linear-gradient(135deg, var(--neon-green), var(--neon-cyan));
        }

        .run-button.waiting:hover::before {
            content: '‚ñ∂';
        }

        .email-button {
            width: 100%;
            padding: 12px;
            background: rgba(0, 217, 255, 0.1);
            border: 2px solid var(--neon-cyan);
            border-radius: 8px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        .email-button:hover {
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
            transform: translateY(-2px);
        }

        .email-button:active {
            transform: translateY(0);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(123, 44, 191, 0.5); }
            50% { box-shadow: 0 0 40px rgba(123, 44, 191, 0.8), 0 0 60px rgba(123, 44, 191, 0.6); }
        }

        /* ËÆ∫ÊñáÂàóË°® */
        .paper-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .paper-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.2);
        }

        .paper-item:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
            transform: translateX(5px);
        }

        .paper-item[data-link]:hover {
            cursor: pointer;
        }

        .paper-item:not([data-link]) {
            cursor: default;
        }

        .paper-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .paper-title {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            line-height: 1.4;
        }

        .paper-status {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-left: 10px;
        }

        .paper-status.success {
            color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green);
            animation: glow 2s infinite;
        }

        .paper-status.error {
            color: var(--neon-red);
            text-shadow: 0 0 10px var(--neon-red);
        }

        .paper-status.pending {
            color: var(--neon-cyan);
            animation: spin 2s linear infinite;
        }

        @keyframes glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .paper-toggle {
            background: none;
            border: none;
            color: var(--neon-cyan);
            cursor: pointer;
            font-size: 11px;
            padding: 5px 10px;
            margin-top: 8px;
            transition: all 0.3s;
        }

        .paper-toggle:hover {
            color: var(--neon-purple);
            text-shadow: 0 0 10px var(--neon-purple);
        }

        .paper-abstract {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 20, 40, 0.6);
            border-left: 3px solid var(--neon-cyan);
            font-size: 13px;
            line-height: 1.6;
            color: var(--neon-cyan);
            display: none;
        }

        .paper-abstract.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .paper-abstract-editable {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 20, 40, 0.6);
            border-left: 3px solid var(--neon-cyan);
            font-size: 13px;
            line-height: 1.6;
            color: var(--neon-cyan);
            display: none;
        }

        .paper-abstract-editable.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .paper-abstract-editable textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s;
        }

        .paper-abstract-editable textarea:focus {
            outline: none;
            border-color: var(--neon-purple);
            box-shadow: 0 0 10px rgba(123, 44, 191, 0.5);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Êó•ÂøóÂå∫Âüü */
        .log-container {
            flex: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            padding-bottom: 10px;
        }

        .log-entry {
            background: rgba(0, 20, 40, 0.6);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .log-status {
            color: var(--neon-green);
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 0 10px var(--neon-green);
        }

        .log-content {
            color: var(--neon-cyan);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .log-entry.info .log-content {
            color: var(--neon-cyan);
        }

        .log-entry.success .log-content {
            color: var(--neon-green);
        }

        .log-entry.error .log-content {
            color: var(--neon-red);
            text-shadow: 0 0 10px var(--neon-red);
        }

        .log-entry.warning .log-content {
            color: var(--neon-orange);
            text-shadow: 0 0 10px var(--neon-orange);
        }

        .log-entry.agent_started .log-content {
            color: var(--neon-cyan);
        }

        .log-entry.agent_final_answer .log-content {
            color: var(--neon-green);
        }

        .log-progress {
            color: var(--neon-orange);
            text-shadow: 0 0 10px var(--neon-orange);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(0, 217, 255, 0.2);
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        /* MarkdownÊ†∑Âºè */
        .log-entry.agent_started p,
        .log-entry.agent_final_answer p {
            margin: 0.5em 0;
        }

        /* ÂØπËØùÊéßÂà∂Ê†è */
        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
            margin-top: auto;
        }

        .chat-controls-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* ËÅîÁΩëÊåâÈíÆÊ†∑Âºè */
        .web-search-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            height: 35px;
            background: rgba(100, 100, 100, 0.2);
            border: 1px solid rgba(150, 150, 150, 0.3);
            border-radius: 8px;
            color: #888;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            box-sizing: border-box;
        }

        .web-search-btn i {
            font-style: normal;
        }

        .web-search-btn.active {
            background: rgba(0, 217, 255, 0.15);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
        }

        /* Ê®°ÂºèÂàáÊç¢ÂºÄÂÖ≥Ê†∑Âºè */
        .mode-switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            height: 35px;
        }

        .mode-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid rgba(0, 217, 255, 0.4);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .mode-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 12px;
            height: 12px;
            background: var(--neon-cyan);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 5px rgba(0, 217, 255, 0.5);
        }

        .mode-switch.active {
            background: rgba(191, 0, 255, 0.2);
            border-color: rgba(191, 0, 255, 0.4);
        }

        .mode-switch.active::after {
            left: calc(100% - 14px);
            background: var(--neon-purple);
            box-shadow: 0 0 5px rgba(191, 0, 255, 0.5);
        }

        .mode-label {
            transition: color 0.3s;
            cursor: pointer;
        }

        .mode-label.active {
            color: var(--neon-cyan);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 217, 255, 0.3);
        }

        .mode-label.active.explore {
            color: var(--neon-purple);
            text-shadow: 0 0 5px rgba(191, 0, 255, 0.3);
        }

        /* ÂØπËØùËæìÂÖ•Âå∫Âüü */
        .chat-input-container {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.6);
            border-top: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(5px);
            margin: 0 10px 10px 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            width: 100%;
        }

        .chat-input {
            flex: 1;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
            color: var(--neon-cyan);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: none;
            outline: none;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
            min-height: 60px;
        }

        .chat-input:focus {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
            background: rgba(0, 30, 50, 0.9);
        }

        .chat-input::placeholder {
            color: rgba(0, 217, 255, 0.5);
        }

        .chat-send-btn {
            width: 45px;
            height: 35px;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid var(--neon-cyan);
            border-radius: 8px;
            color: var(--neon-cyan);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
            flex-shrink: 0;
            margin-left: auto;
        }

        .chat-send-btn:hover {
            background: rgba(0, 217, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
            transform: translateY(-2px);
        }

        .chat-send-btn:active {
            transform: translateY(0);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-icon {
            font-weight: bold;
            text-shadow: 0 0 10px var(--neon-cyan);
        }

        /* ÂØπËØùÊ∂àÊÅØÊ†∑Âºè */
        .chat-message {
            background: rgba(0, 20, 40, 0.6);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
            animation: fadeIn 0.3s;
        }

        .chat-message.user {
            background: rgba(0, 50, 100, 0.6);
            border-color: rgba(0, 217, 255, 0.5);
        }

        .chat-message.assistant {
            background: rgba(0, 30, 60, 0.6);
            border-color: rgba(0, 255, 200, 0.3);
        }

        .chat-message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .chat-message.user .chat-message-header {
            color: var(--neon-cyan);
        }

        .chat-message.assistant .chat-message-header {
            color: var(--neon-green);
        }

        .chat-message-content {
            color: rgba(255, 255, 255, 0.9);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .chat-message.thinking {
            opacity: 0.7;
            font-style: italic;
            color: rgba(0, 217, 255, 0.7);
        }

        .log-entry.agent_started strong,
        .log-entry.agent_final_answer strong {
            font-weight: 600;
        }

        .log-entry.agent_started code,
        .log-entry.agent_final_answer code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry.agent_started pre,
        .log-entry.agent_final_answer pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .log-entry.agent_started pre code,
        .log-entry.agent_final_answer pre code {
            background: transparent;
            padding: 0;
        }

        .log-entry.agent_started ul,
        .log-entry.agent_final_answer ul,
        .log-entry.agent_started ol,
        .log-entry.agent_final_answer ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .log-entry.agent_started li,
        .log-entry.agent_final_answer li {
            margin: 0.25em 0;
        }

        .log-timestamp {
            color: rgba(0, 217, 255, 0.6);
            font-size: 12px;
            display: block;
            text-align: left;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 217, 255, 0.2);
        }

        /* ËæìÂá∫Êñá‰ª∂ÂàóË°® */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .paper-result-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .file-list-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .file-list-header {
            margin-bottom: 15px;
        }

        .file-list-header h3 {
            font-size: 16px;
            color: var(--neon-cyan);
            margin: 0;
            font-weight: 600;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .paper-result-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .paper-result-item:hover {
            background: rgba(0, 217, 255, 0.15);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
            transform: translateX(5px);
        }

        .paper-result-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .paper-result-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .paper-result-score {
            color: var(--neon-cyan);
            font-weight: 600;
        }

        .paper-result-score.high-value {
            color: var(--neon-green);
        }

        .file-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .file-item:hover {
            background: rgba(0, 217, 255, 0.15);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        .file-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .file-item-icon {
            font-size: 24px;
            line-height: 1;
        }

        .file-item-info {
            flex: 1;
        }

        .file-item-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 6px;
            word-break: break-word;
        }

        .file-item-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .file-item-type {
            color: var(--neon-cyan);
        }

        .file-item-size {
            color: rgba(255, 255, 255, 0.5);
        }

        .file-item-time {
            color: rgba(255, 255, 255, 0.4);
        }

        .file-item-actions {
            display: flex;
            gap: 8px;
        }

        .file-action-btn {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: var(--neon-cyan);
        }

        .file-action-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.4);
        }

        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(0, 217, 255, 0.2), 
                transparent);
            transition: left 0.5s;
        }

        .file-item:hover {
            background: rgba(0, 217, 255, 0.15);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
            transform: translateX(5px);
        }

        .file-item:hover::before {
            left: 100%;
        }

        .file-name {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }

        .file-info {
            font-size: 11px;
            color: rgba(0, 217, 255, 0.6);
        }

        .file-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 16px;
        }

        /* ÊïÖÈöúÊïàÊûú */
        .glitch {
            position: relative;
            animation: glitch-anim 5s infinite;
        }

        @keyframes glitch-anim {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }

        /* ÈöêËóèÈÄâÈ°π */
        .hidden {
            display: none !important;
        }

        /* ËÆæÁΩÆÂºπÁ™ó */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex !important;
            justify-content: center;
            align-items: center;
        }

        .settings-content {
            background: var(--dark-panel);
            border: 2px solid var(--neon-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            position: relative;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--neon-cyan);
            margin: 0;
            text-transform: uppercase;
        }

        .settings-close {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .settings-close:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .settings-body {
            padding: 20px;
        }

        .model-list {
            margin-bottom: 20px;
        }

        .model-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid var(--neon-cyan);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .model-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .model-item-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--neon-cyan);
        }

        .model-item-actions {
            display: flex;
            gap: 10px;
        }

        .btn-test, .btn-delete {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-test {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .btn-test:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        .btn-delete {
            background: rgba(255, 0, 84, 0.1);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .btn-delete:hover {
            background: rgba(255, 0, 84, 0.2);
        }

        .btn-collapse {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 4px;
            color: var(--neon-cyan);
            font-size: 12px;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 30px;
        }

        .btn-collapse:hover {
            background: rgba(0, 217, 255, 0.1);
        }

        .model-title-input {
            background: transparent !important;
            border: none !important;
            border-bottom: 1px solid var(--neon-cyan) !important;
            color: var(--neon-cyan) !important;
            font-family: 'Rajdhani', sans-serif !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            padding: 4px 8px !important;
            flex: 1;
            transition: all 0.3s;
        }

        .model-title-input:focus {
            outline: none;
            border-bottom-color: var(--neon-purple) !important;
            box-shadow: 0 2px 0 rgba(123, 44, 191, 0.5) !important;
        }

        .model-item-content {
            animation: slideDown 0.3s ease;
        }

        .default-model-radio {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
        }

        .default-model-radio input[type="radio"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--neon-cyan);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0;
        }

        .default-model-radio input[type="radio"]:checked {
            background: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .default-model-radio input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: var(--dark-bg);
            border-radius: 50%;
        }

        .default-model-radio .radio-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
        }

        .default-model-radio:hover .radio-label {
            color: var(--neon-cyan);
        }

        .enable-model-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
        }

        .enable-model-checkbox input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--neon-cyan);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0;
        }

        .enable-model-checkbox input[type="checkbox"]:checked {
            background: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .enable-model-checkbox input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--dark-bg);
            font-size: 12px;
            font-weight: bold;
        }

        .enable-model-checkbox .checkbox-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
        }

        .enable-model-checkbox:hover .checkbox-label {
            color: var(--neon-cyan);
        }

        .model-form-group {
            margin-bottom: 15px;
        }

        .model-form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 5px;
            font-family: 'Rajdhani', sans-serif;
        }

        .model-form-group input,
        .model-form-group select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
        }

        .model-form-group input:focus,
        .model-form-group select:focus {
            outline: none;
            border-color: var(--neon-cyan);
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .btn-add-model {
            width: 100%;
            padding: 12px;
            background: rgba(0, 217, 255, 0.1);
            border: 2px dashed var(--neon-cyan);
            border-radius: 8px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .btn-add-model:hover {
            background: rgba(0, 217, 255, 0.2);
            border-style: solid;
        }

        .settings-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-save {
            padding: 10px 20px;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save:hover {
            background: rgba(0, 217, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .test-status {
            display: inline-block;
            margin-left: 10px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .test-status.success {
            background: rgba(0, 255, 0, 0.2);
            color: #0f0;
        }

        .test-status.error {
            background: rgba(255, 0, 84, 0.2);
            color: var(--neon-red);
        }

        .test-status.testing {
            background: rgba(255, 170, 0, 0.2);
            color: var(--neon-orange);
        }

        /* ÈÇÆ‰ª∂‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü */
        .email-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .email-modal.active {
            display: flex !important;
            justify-content: center;
            align-items: center;
        }

        .email-settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .email-settings-modal.active {
            display: flex !important;
        }

        .email-settings-content {
            background: var(--dark-panel);
            border: 2px solid var(--neon-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            display: flex;
            flex-direction: column;
        }

        .email-settings-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-settings-header h3 {
            margin: 0;
            color: var(--neon-cyan);
            font-size: 18px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
        }

        .email-settings-close {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .email-settings-close:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .email-settings-body {
            padding: 20px;
        }

        .email-settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
        }

        .form-group .input-field {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-family: 'Rajdhani', sans-serif;
        }

        .form-group .input-field:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .form-hint {
            background: rgba(0, 217, 255, 0.05);
            border-left: 3px solid var(--neon-cyan);
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .form-hint p {
            margin: 0 0 8px 0;
            color: var(--neon-cyan);
            font-size: 13px;
            font-weight: 600;
        }

        .form-hint ul {
            margin: 0;
            padding-left: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            line-height: 1.6;
        }

        .form-hint li {
            margin-bottom: 4px;
        }

        .email-settings-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .email-content {
            background: var(--dark-panel);
            border: 2px solid var(--neon-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            position: relative;
        }

        .email-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-header h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--neon-cyan);
            margin: 0;
            text-transform: uppercase;
        }

        .email-close {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .email-close:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .email-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .email-summary {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid var(--neon-cyan);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .email-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .email-summary-item:last-child {
            margin-bottom: 0;
        }

        .email-summary-label {
            color: var(--neon-cyan);
            font-weight: 600;
        }

        .email-list {
            margin-top: 20px;
        }

        .email-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .email-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .email-item-subject {
            font-size: 16px;
            font-weight: 600;
            color: var(--neon-cyan);
        }

        .email-item-date {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .email-pagination {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 16px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin: 0 10px;
        }

        .email-item-papers {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .email-item-papers-title {
            font-size: 12px;
            color: var(--neon-cyan);
            margin-bottom: 8px;
        }

        .email-paper-item {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--neon-cyan);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            position: relative;
        }

        /* ÊñáÁ´†Áä∂ÊÄÅÈ¢úËâ≤Ê†áËÆ∞ */
        .email-paper-item.status-pending {
            border-left-color: rgba(0, 217, 255, 0.5);  /* ÈùíËâ≤ - ÂæÖÂ§ÑÁêÜ */
            background: rgba(0, 217, 255, 0.05);
        }

        .email-paper-item.status-processing {
            border-left-color: rgba(255, 170, 0, 0.8);  /* Ê©ôËâ≤ - Â§ÑÁêÜ‰∏≠ */
            background: rgba(255, 170, 0, 0.1);
            animation: pulse-border 2s infinite;
        }

        .email-paper-item.status-processed {
            border-left-color: rgba(0, 255, 100, 0.6);  /* ÁªøËâ≤ - Â∑≤Â§ÑÁêÜ */
            background: rgba(0, 255, 100, 0.05);
        }

        .email-paper-item.status-synchronized {
            border-left-color: rgba(123, 44, 191, 0.8);  /* Á¥´Ëâ≤ - Â∑≤ÂêåÊ≠• */
            background: rgba(123, 44, 191, 0.05);
        }

        .email-paper-status-badge {
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .email-paper-status-badge.pending {
            background: rgba(0, 217, 255, 0.2);
            color: var(--neon-cyan);
        }

        .email-paper-status-badge.processing {
            background: rgba(255, 170, 0, 0.2);
            color: var(--neon-orange);
        }

        .email-paper-status-badge.processed {
            background: rgba(0, 255, 100, 0.2);
            color: var(--neon-green);
        }

        .email-paper-status-badge.synchronized {
            background: rgba(123, 44, 191, 0.2);
            color: var(--neon-purple);
        }

        /* Á¨îËÆ∞ÂàóË°®Áä∂ÊÄÅÈ¢úËâ≤ */
        .status-pending {
            color: var(--neon-cyan) !important;
        }

        .status-processed {
            color: var(--neon-green) !important;
        }

        .status-synchronized {
            color: var(--neon-purple) !important;
        }

        .status-processing {
            color: #ffaa00 !important;
        }

        .email-paper-item:last-child {
            margin-bottom: 0;
        }

        .email-paper-title {
            font-size: 13px;
            color: #fff;
            margin-bottom: 4px;
        }

        .email-paper-title-link {
            font-size: 13px;
            color: var(--neon-cyan);
            text-decoration: none;
            display: block;
            transition: all 0.3s;
        }

        .email-paper-title-link:hover {
            color: #fff;
            text-decoration: underline;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .email-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .email-footer-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-settings {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            color: var(--neon-cyan);
        }

        .btn-settings:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.4);
        }

        .email-settings-footer .btn-test,
        .email-settings-footer .btn-save {
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid;
        }

        .email-settings-footer .btn-test {
            background: rgba(0, 217, 255, 0.1);
            border-color: rgba(0, 217, 255, 0.3);
            color: var(--neon-cyan);
        }

        .email-settings-footer .btn-test:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.4);
        }

        .email-settings-footer .btn-test:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .email-settings-footer .btn-save {
            background: rgba(0, 255, 100, 0.1);
            border-color: rgba(0, 255, 100, 0.3);
            color: var(--neon-green);
        }

        .email-settings-footer .btn-save:hover {
            background: rgba(0, 255, 100, 0.2);
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 255, 100, 0.4);
        }

        .email-settings-footer .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-update {
            padding: 10px 20px;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-update:hover {
            background: rgba(0, 217, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .btn-update:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Á¨îËÆ∞ÂØºÂÖ•ÊµÅÁ®ãÂ∏ÉÂ±Ä */
        .note-flow-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .note-flow-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .note-flow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }

        .note-flow-label {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }

        .note-flow-count {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--neon-cyan);
        }

        .note-flow-arrow {
            font-size: 24px;
            color: rgba(0, 217, 255, 0.3);
            font-weight: bold;
        }

        .note-flow-switch-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
        }

        .note-flow-switch-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #note-synchronized-count {
            color: var(--neon-purple) !important;
        }

        #note-processed-count {
            color: var(--neon-green) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â∑¶‰æßÈù¢Êùø - Êù•Ê∫ê -->
        <div class="left-panel panel">
            <div class="panel-header">
                <h2>Êù•Ê∫ê</h2>
                <div class="header-buttons">
                    <button class="settings-btn" id="note-btn" onclick="openNoteModal()" title="Á¨îËÆ∞ÂØºÂÖ•">üìì</button>
                    <button class="settings-btn" id="email-btn" onclick="openEmailModal()" title="ÈÇÆÁÆ±Á≥ªÁªü">üìß</button>
                </div>
            </div>
            <button class="expand-arrow-btn hidden" id="expand-arrow-btn" title="Â±ïÂºÄÈÄâÈ°π">
                <span>‚ñº</span>
            </button>
            <div class="run-options">
                <div class="option-group">
                    <label>Á†îÁ©∂ÊñπÂêëÂÖ≥ÈîÆËØç</label>
                    <input type="text" class="input-field" id="keywords" 
                           placeholder="‰æãÂ¶Ç: Êú∫Âô®‰∫∫Â≠¶„ÄÅÊéßÂà∂ÁêÜËÆ∫„ÄÅÈÅ•Êìç‰Ωú„ÄÅÊú∫Âô®‰∫∫Âä®ÂäõÂ≠¶„ÄÅÂäõÊéß„ÄÅÊú∫Âô®Â≠¶‰π†" 
                           value="Êú∫Âô®‰∫∫Â≠¶„ÄÅÊéßÂà∂ÁêÜËÆ∫„ÄÅÈÅ•Êìç‰Ωú„ÄÅÊú∫Âô®‰∫∫Âä®ÂäõÂ≠¶„ÄÅÂäõÊéß„ÄÅÊú∫Âô®Â≠¶‰π†">
                </div>
                <div class="option-group">
                    <label>‰∏ä‰º†Êñá‰ª∂</label>
                    <div class="file-drop-zone" id="file-drop-zone">
                        <input type="file" id="file-input" accept=".csv,.pdf" multiple style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10;">
                        <div class="file-drop-content">
                            <div class="file-drop-icon">üìÅ</div>
                            <div class="file-drop-text">ËØ∑ÈÄâÊã©Êñá‰ª∂</div>
                            <div class="file-drop-hint">ÊîØÊåÅ CSV Âíå PDF Ê†ºÂºèÔºåÁÇπÂáªÈÄâÊã©Êñá‰ª∂ÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§ÑÔºàÊîØÊåÅÂ§öÈÄâÔºâ</div>
                        </div>
                    </div>
                    <div id="file-list-display" style="margin-top: 8px; color: rgba(255, 255, 255, 0.7); font-size: 12px;">
                        Êú™ÈÄâÊã©Êñá‰ª∂
                    </div>
                </div>
                <button class="collapse-arrow-btn" id="collapse-arrow-btn" title="ÊäòÂè†ÈÄâÈ°π">
                    <span>‚ñ≤</span>
                </button>
            </div>
            <!-- Áªü‰∏ÄÁöÑ‰ªªÂä°ÈòüÂàóÂå∫Âüü -->
            <div class="task-queue-section" id="task-queue-section" style="display: none;">
                <div class="task-queue-header">
                    <div class="task-queue-tabs">
                        <button class="task-tab active" id="tab-files" data-tab="files">Â∑≤‰∏ä‰º†Êñá‰ª∂</button>
                        <button class="task-tab" id="tab-papers" data-tab="papers">ÂæÖÂ§ÑÁêÜÊñáÁ´†</button>
                    </div>
                    <button class="clear-files-btn" id="clear-files-btn" title="Ê∏ÖÁ©∫Êñá‰ª∂ÂàóË°®" style="display: none;">Ê∏ÖÁ©∫</button>
                </div>
                <div class="task-queue-content">
                    <!-- Â∑≤‰∏ä‰º†Êñá‰ª∂ÂàóË°® -->
                    <div class="task-queue-panel active" id="panel-files">
                        <div class="file-status-list" id="file-status-list">
                            <div class="file-status-empty">ÊöÇÊó†‰∏ä‰º†Êñá‰ª∂</div>
                        </div>
                    </div>
                    <!-- ÂæÖÂ§ÑÁêÜÊñáÁ´†ÂàóË°® -->
                    <div class="task-queue-panel" id="panel-papers">
                        <div class="paper-processing-list" id="paper-processing-list">
                            <div class="paper-processing-empty">ÊöÇÊó†ÂæÖÂ§ÑÁêÜÊñáÁ´†</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-content">
                <div class="paper-list" id="paper-list">
                </div>
            </div>
            <!-- ‰ªªÂä°ÈòüÂàóÁä∂ÊÄÅÊ†è -->
            <div class="queue-status-bar" id="queue-status-bar">
                <div class="queue-status-info">
                    <span class="queue-label">Agent ‰ªªÂä°ÈòüÂàó:</span>
                    <span class="queue-count" id="queue-count">0</span>
                </div>
                <div class="queue-status-hint" id="queue-status-hint" style="font-size: 11px; opacity: 0.8;">
                    Á©∫Èó≤
                </div>
            </div>
        </div>

        <!-- ‰∏≠Èó¥Èù¢Êùø - ÂØπËØù -->
        <div class="center-panel panel">
            <div class="panel-header">
                <h2>ÂØπËØù</h2>
                <div class="header-buttons">
                    <button class="settings-btn" id="database-btn" title="Êï∞ÊçÆÂ∫ìÁ≥ªÁªü" onclick="openDatabasePage()">üìä</button>
                    <button class="settings-btn" id="settings-btn" title="Ê®°ÂûãËÆæÁΩÆ" onclick="openSettingsModal()">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="log-container" id="log-container">
                    <div class="log-entry info">
                        <span class="log-timestamp">[Á≥ªÁªü]</span>
                        Á≥ªÁªüÂ∞±Áª™ÔºåÁ≠âÂæÖÂºÄÂßãÂ§ÑÁêÜ...
                    </div>
                </div>
                <!-- ÂØπËØùËæìÂÖ•Âå∫Âüü -->
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            id="chat-input" 
                            class="chat-input" 
                            placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢òÔºåÊåâÂõûËΩ¶ÊàñÁÇπÂáªÊåâÈíÆÂèëÈÄÅ..."
                            rows="3"
                        ></textarea>
                    </div>
                    <div class="chat-controls">
                        <div class="chat-controls-left">
                            <div class="web-search-btn" id="web-search-btn" title="ÁÇπÂáªÂàáÊç¢ËÅîÁΩëÊ®°Âºè">
                                üåê ËÅîÁΩë
                            </div>
                            <div class="mode-switch-container">
                                <span class="mode-label active" id="label-query">Êü•ËØ¢</span>
                                <div class="mode-switch" id="mode-switch"></div>
                                <span class="mode-label" id="label-explore">Êé¢Á¥¢</span>
                            </div>
                        </div>
                        <button id="chat-send-btn" class="chat-send-btn" title="ÂèëÈÄÅ (Enter)">
                            <span class="send-icon">‚Üµ</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Âè≥‰æßÈù¢Êùø - ÁîüÊàê -->
        <div class="right-panel panel">
            <div class="panel-header">
                <h2>ÁîüÊàê</h2>
            </div>
            <div class="panel-content">
                <!-- ËÆ∫ÊñáÂàóË°®Âå∫Âüü -->
                <div class="paper-result-list" id="paper-result-list">
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 40px 20px;">
                        Á≠âÂæÖÂ§ÑÁêÜËÆ∫Êñá...
                    </div>
                </div>
                <!-- Êñá‰ª∂ÂàóË°®Âå∫Âüü -->
                <div class="file-list-section" id="file-list-section" style="display: none;">
                    <div class="file-list-header">
                        <h3>ÁîüÊàêÁöÑÊñá‰ª∂</h3>
                    </div>
                    <div class="file-list" id="file-list">
                        <!-- Êñá‰ª∂ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IOËøûÊé•
        let socket = null;
        let isRunning = false;
        let isWaitingConfirmation = false;
        let confirmationPapers = {};  // Â≠òÂÇ®Á≠âÂæÖÁ°ÆËÆ§ÁöÑËÆ∫ÊñáÊï∞ÊçÆ

        // DOMÂÖÉÁ¥†
        const modeRadios = document.querySelectorAll('input[name="mode"]');
        const localOptions = document.getElementById('local-options');
        const remoteOptions = document.getElementById('remote-options');
        const pdfOptions = document.getElementById('pdf-options');
        const runBtn = document.getElementById('run-btn'); // ÂèØËÉΩ‰∏çÂ≠òÂú®ÔºàÂ∑≤Âà†Èô§ÂºÄÂßãËøêË°åÊåâÈíÆÔºâ
        const collapseArrowBtn = document.getElementById('collapse-arrow-btn');
        const expandArrowBtn = document.getElementById('expand-arrow-btn');
        const runOptions = document.querySelector('.run-options');
        const paperList = document.getElementById('paper-list');
        const logContainer = document.getElementById('log-container');

        // ËÆæÁΩÆÈªòËÆ§Êó•ÊúüÔºàÊò®Â§©Âíå‰ªäÂ§©Ôºâ
        function setDefaultDates() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            // Ê†ºÂºèÂåñ‰∏∫ YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            if (startDateInput) {
                startDateInput.value = formatDate(yesterday);
            }
            if (endDateInput) {
                endDateInput.value = formatDate(today);
            }
        }
        
        // ÂàùÂßãÂåñÊó∂ËÆæÁΩÆÈªòËÆ§Êó•Êúü
        setDefaultDates();
        
        // Ê®°ÂºèÂàáÊç¢ÂáΩÊï∞
        function updateModeDisplay() {
            const checkedMode = document.querySelector('input[name="mode"]:checked');
            if (checkedMode) {
                // ÂÖàÈöêËóèÊâÄÊúâÈÄâÈ°π
                localOptions.classList.add('hidden');
                remoteOptions.classList.add('hidden');
                pdfOptions.classList.add('hidden');
                
                // Ê†πÊçÆÈÄâ‰∏≠ÁöÑÊ®°ÂºèÊòæÁ§∫ÂØπÂ∫îÈÄâÈ°π
                if (checkedMode.value === 'local') {
                    localOptions.classList.remove('hidden');
                } else if (checkedMode.value === 'remote') {
                    remoteOptions.classList.remove('hidden');
                } else if (checkedMode.value === 'pdf') {
                    pdfOptions.classList.remove('hidden');
                }
            }
        }
        
        // Ê®°ÂºèÂàáÊç¢‰∫ã‰ª∂ÁõëÂê¨
        modeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                updateModeDisplay();
            });
        });
        
        // ÂàùÂßãÂåñÊó∂Ê†πÊçÆÈªòËÆ§ÈÄâ‰∏≠ÁöÑÊ®°ÂºèËÆæÁΩÆÊòæÁ§∫Áä∂ÊÄÅ
        updateModeDisplay();

        // ÊäòÂè†ÊåâÈíÆÂäüËÉΩ
        function initCollapseButton() {
            if (!collapseArrowBtn || !expandArrowBtn || !runOptions) {
                return;
            }
            
            // Âêë‰∏äÁÆ≠Â§¥ÔºöÊäòÂè†ÈÄâÈ°πÂå∫Âüü
            collapseArrowBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                runOptions.classList.add('collapsed');
                expandArrowBtn.classList.remove('hidden');
            });
            
            // Âêë‰∏ãÁÆ≠Â§¥ÔºöÂ±ïÂºÄÈÄâÈ°πÂå∫Âüü
            expandArrowBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                runOptions.classList.remove('collapsed');
                expandArrowBtn.classList.add('hidden');
            });
        }

        // ÂØπËØùÂäüËÉΩ
        function initChatInput() {
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const webSearchBtn = document.getElementById('web-search-btn');
            const modeSwitch = document.getElementById('mode-switch');
            const labelQuery = document.getElementById('label-query');
            const labelExplore = document.getElementById('label-explore');
            
            let isWebSearchEnabled = false;
            let currentChatMode = 'query'; // 'query' Êàñ 'explore'
            let isSelfExplorationInProgress = false; // ÊòØÂê¶Ê≠£Âú®ËøõË°åËá™ÊàëÊé¢Á¥¢

            // ÈîÅÂÆö/Ëß£ÈîÅÊ®°ÂºèÂºÄÂÖ≥
            function lockModeSwitch(lock) {
                if (modeSwitch) {
                    modeSwitch.style.pointerEvents = lock ? 'none' : 'auto';
                    modeSwitch.style.opacity = lock ? '0.5' : '1';
                }
                if (labelQuery) {
                    labelQuery.style.pointerEvents = lock ? 'none' : 'auto';
                    labelQuery.style.opacity = lock ? '0.5' : '1';
                }
                if (labelExplore) {
                    labelExplore.style.pointerEvents = lock ? 'none' : 'auto';
                    labelExplore.style.opacity = lock ? '0.5' : '1';
                }
            }

            if (webSearchBtn) {
                webSearchBtn.addEventListener('click', () => {
                    isWebSearchEnabled = !isWebSearchEnabled;
                    webSearchBtn.classList.toggle('active', isWebSearchEnabled);
                    addLog('info', `ËÅîÁΩëÊ®°ÂºèÂ∑≤${isWebSearchEnabled ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`);
                });
            }

            // Ëß¶ÂèëagentËá™ÊàëÊé¢Á¥¢
            function triggerSelfExploration() {
                if (isSelfExplorationInProgress) {
                    console.log('Ëá™ÊàëÊé¢Á¥¢Â∑≤Âú®ËøõË°å‰∏≠ÔºåË∑≥Ëøá');
                    return;
                }

                isSelfExplorationInProgress = true;
                lockModeSwitch(true); // ÈîÅÂÆöÂºÄÂÖ≥

                // ÊòæÁ§∫ÊÄùËÄÉ‰∏≠Ê∂àÊÅØ
                const thinkingId = addChatMessage('assistant', 'Ê≠£Âú®ËøõË°åËá™ÊàëÊé¢Á¥¢Ôºå‰∏∫ÊÇ®Êé®ËçêÁ†îÁ©∂ÊñπÂêë...', true);
                
                // ÂèëÈÄÅÁ©∫Ê∂àÊÅØ‰ª•Ëß¶ÂèëËá™ÊàëÊé¢Á¥¢ÔºàÂêéÁ´Ø‰ºöÊ£ÄÊµãÂπ∂Ëá™Âä®Ëß¶ÂèëÔºâ
                fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: '',  // Á©∫Ê∂àÊÅØËß¶ÂèëÈ¶ñÊ¨°Êé¢Á¥¢
                        mode: 'explore',
                        web_search_enabled: isWebSearchEnabled
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // ÁßªÈô§ÊÄùËÄÉ‰∏≠Ê∂àÊÅØ
                    removeChatMessage(thinkingId);
                    
                    if (data.success && data.type === 'self_exploration') {
                        // ÊòæÁ§∫Ëá™ÊàëÊé¢Á¥¢ÁªìÊûú
                        addChatMessage('assistant', data.message);
                    } else if (data.success) {
                        // Ê≠£Â∏∏ÂõûÂ§ç
                        addChatMessage('assistant', data.message);
                    } else {
                        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
                        addChatMessage('assistant', `ÈîôËØØ: ${data.error || 'Êú™Áü•ÈîôËØØ'}`);
                    }
                })
                .catch(error => {
                    // ÁßªÈô§ÊÄùËÄÉ‰∏≠Ê∂àÊÅØ
                    removeChatMessage(thinkingId);
                    // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
                    addChatMessage('assistant', `ÁΩëÁªúÈîôËØØ: ${error.message}`);
                })
                .finally(() => {
                    // Ëß£ÈîÅÂºÄÂÖ≥
                    isSelfExplorationInProgress = false;
                    lockModeSwitch(false);
                });
            }

            if (modeSwitch) {
                const toggleMode = () => {
                    // Â¶ÇÊûúÊ≠£Âú®ËøõË°åËá™ÊàëÊé¢Á¥¢ÔºåÈòªÊ≠¢ÂàáÊç¢
                    if (isSelfExplorationInProgress) {
                        addLog('warning', 'Ê≠£Âú®ËøõË°åËá™ÊàëÊé¢Á¥¢ÔºåËØ∑Á®çÂÄô...');
                        return;
                    }

                    const previousMode = currentChatMode;
                    currentChatMode = currentChatMode === 'query' ? 'explore' : 'query';
                    modeSwitch.classList.toggle('active', currentChatMode === 'explore');
                    labelQuery.classList.toggle('active', currentChatMode === 'query');
                    labelExplore.classList.toggle('active', currentChatMode === 'explore');
                    
                    if (currentChatMode === 'explore') {
                        labelExplore.classList.add('explore');
                    } else {
                        labelExplore.classList.remove('explore');
                    }
                    
                    addLog('info', `ÂØπËØùÊ®°ÂºèÂ∑≤ÂàáÊç¢‰∏∫: ${currentChatMode === 'query' ? 'Á†îÁ©∂Âëò (Êü•ËØ¢)' : 'ÂØºÂ∏à (Êé¢Á¥¢)'}`);
                    
                    // Â¶ÇÊûúÂàáÊç¢Âà∞Êé¢Á¥¢Ê®°ÂºèÔºåÁõ¥Êé•Ëß¶ÂèëËá™ÊàëÊé¢Á¥¢ÔºàÂêéÁ´Ø‰ºöÂà§Êñ≠ÊòØÂê¶ÊòØÈ¶ñÊ¨°Ôºâ
                    if (currentChatMode === 'explore' && previousMode === 'query') {
                        console.log('ÂàáÊç¢Âà∞Êé¢Á¥¢Ê®°ÂºèÔºåËß¶ÂèëËá™ÊàëÊé¢Á¥¢');
                        // Âª∂Ëøü‰∏ÄÂ∞èÊÆµÊó∂Èó¥ÔºåÁ°Æ‰øùÊ®°ÂºèÂàáÊç¢ÂÆåÊàê
                        setTimeout(() => {
                            triggerSelfExploration();
                        }, 100);
                    }
                };

                modeSwitch.addEventListener('click', toggleMode);
                labelQuery.addEventListener('click', () => { if (currentChatMode !== 'query' && !isSelfExplorationInProgress) toggleMode(); });
                labelExplore.addEventListener('click', () => { if (currentChatMode !== 'explore' && !isSelfExplorationInProgress) toggleMode(); });
            }
            
            if (!chatInput || !chatSendBtn) {
                return;
            }

            // ÂèëÈÄÅÊ∂àÊÅØÂáΩÊï∞
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) {
                    return;
                }

                // Ê£ÄÊü•ÊòØÂê¶ÊòØËá™ÊàëÊé¢Á¥¢ÂÖ≥ÈîÆËØçÔºàÊé¢Á¥¢Ê®°Âºè‰∏ãÔºâ
                const exploration_keywords = ['Êé¢Á¥¢Êñ∞ÊñπÂêë', '‰∏ã‰∏ÄÊ¨°Êé¢Á¥¢', 'Êñ∞Á†îÁ©∂ÊñπÂêë', 'ÁªßÁª≠Êé¢Á¥¢', '‰∏ã‰∏Ä‰∏™', 'Êñ∞ÊñπÂêë', 'Ëá™ÊàëÊé¢Á¥¢'];
                const isExplorationRequest = currentChatMode === 'explore' && 
                    exploration_keywords.some(keyword => message.includes(keyword));

                // Â¶ÇÊûúÊòØËá™ÊàëÊé¢Á¥¢ËØ∑Ê±ÇÔºåÈîÅÂÆöÂºÄÂÖ≥
                if (isExplorationRequest) {
                    if (isSelfExplorationInProgress) {
                        addLog('warning', 'Ëá™ÊàëÊé¢Á¥¢Â∑≤Âú®ËøõË°å‰∏≠ÔºåËØ∑Á®çÂÄô...');
                        return;
                    }
                    isSelfExplorationInProgress = true;
                    lockModeSwitch(true);
                }

                // Á¶ÅÁî®ËæìÂÖ•Ê°ÜÂíåÊåâÈíÆ
                chatInput.disabled = true;
                chatSendBtn.disabled = true;

                // ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØ
                addChatMessage('user', message);
                
                // ÊòæÁ§∫ÊÄùËÄÉ‰∏≠Ê∂àÊÅØ
                const thinkingId = addChatMessage('assistant', isExplorationRequest ? 'Ê≠£Âú®ËøõË°åËá™ÊàëÊé¢Á¥¢Ôºå‰∏∫ÊÇ®Êé®ËçêÁ†îÁ©∂ÊñπÂêë...' : 'Ê≠£Âú®ÊÄùËÄÉ...', true);

                // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                chatInput.value = '';

                // ÂèëÈÄÅËØ∑Ê±ÇÂà∞ÂêéÁ´Ø
                fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        mode: currentChatMode,
                        web_search_enabled: isWebSearchEnabled
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // ÁßªÈô§ÊÄùËÄÉ‰∏≠Ê∂àÊÅØ
                    removeChatMessage(thinkingId);

                    if (data.success) {
                        // ÊòæÁ§∫Âä©ÊâãÂõûÂ§ç
                        addChatMessage('assistant', data.message);
                        
                        // Â¶ÇÊûúÊòØËá™ÊàëÊé¢Á¥¢ÂìçÂ∫îÔºåËß£ÈîÅÂºÄÂÖ≥
                        if (data.type === 'self_exploration') {
                            isSelfExplorationInProgress = false;
                            lockModeSwitch(false);
                        }
                    } else {
                        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
                        addChatMessage('assistant', `ÈîôËØØ: ${data.error || 'Êú™Áü•ÈîôËØØ'}`);
                        // Â¶ÇÊûú‰πãÂâçÈîÅÂÆö‰∫ÜÔºåÂàôËß£ÈîÅ
                        if (isExplorationRequest) {
                            isSelfExplorationInProgress = false;
                            lockModeSwitch(false);
                        }
                    }
                })
                .catch(error => {
                    // ÁßªÈô§ÊÄùËÄÉ‰∏≠Ê∂àÊÅØ
                    removeChatMessage(thinkingId);
                    // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
                    addChatMessage('assistant', `ÁΩëÁªúÈîôËØØ: ${error.message}`);
                    // Â¶ÇÊûú‰πãÂâçÈîÅÂÆö‰∫ÜÔºåÂàôËß£ÈîÅ
                    if (isExplorationRequest) {
                        isSelfExplorationInProgress = false;
                        lockModeSwitch(false);
                    }
                })
                .finally(() => {
                    // ÈáçÊñ∞ÂêØÁî®ËæìÂÖ•Ê°ÜÂíåÊåâÈíÆ
                    chatInput.disabled = false;
                    chatSendBtn.disabled = false;
                    chatInput.focus();
                    
                    // Â¶ÇÊûú‰∏çÊòØËá™ÊàëÊé¢Á¥¢ËØ∑Ê±ÇÔºåÁ°Æ‰øùËß£ÈîÅÔºàÈò≤Ê≠¢Áä∂ÊÄÅ‰∏ç‰∏ÄËá¥Ôºâ
                    if (!isExplorationRequest && isSelfExplorationInProgress) {
                        isSelfExplorationInProgress = false;
                        lockModeSwitch(false);
                    }
                });
            }

            // ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            chatSendBtn.addEventListener('click', sendMessage);

            // ÂõûËΩ¶ÈîÆÂèëÈÄÅÔºàShift+EnterÊç¢Ë°åÔºâ
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // Ê∑ªÂä†ÂØπËØùÊ∂àÊÅØÂà∞Êó•ÂøóÂÆπÂô®
        function addChatMessage(role, content, isThinking = false) {
            const logContainer = document.getElementById('log-container');
            if (!logContainer) {
                return null;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}${isThinking ? ' thinking' : ''}`;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'chat-message-header';
            headerDiv.textContent = role === 'user' ? 'üë§ ÊÇ®' : 'ü§ñ Âä©Êâã';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);
            
            // ÁîüÊàêÂîØ‰∏ÄIDÁî®‰∫éÂà†Èô§
            const messageId = 'chat-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            messageDiv.id = messageId;
            
            logContainer.appendChild(messageDiv);
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            logContainer.scrollTop = logContainer.scrollHeight;
            
            return messageId;
        }

        // ÁßªÈô§ÂØπËØùÊ∂àÊÅØ
        function removeChatMessage(messageId) {
            if (!messageId) {
                return;
            }
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.remove();
            }
        }

        // ËøûÊé•Socket.IO
        function connectWebSocket() {
            const socketUrl = window.location.origin;
            
            socket = io(socketUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: Infinity
            });

            socket.on('connect', () => {
                addLog('info', 'Socket.IOËøûÊé•Â∑≤Âª∫Á´ã');
            });

            socket.on('message', (data) => {
                handleWebSocketMessage(data);
            });

            socket.on('disconnect', () => {
                addLog('warning', 'Socket.IOËøûÊé•Â∑≤Êñ≠ÂºÄÔºåÂ∞ùËØïÈáçËøû...');
            });

            socket.on('connect_error', (error) => {
                addLog('error', `Socket.IOËøûÊé•ÈîôËØØ: ${error.message || 'ËøûÊé•Â§±Ë¥•'}`);
            });
        }

        // Â§ÑÁêÜWebSocketÊ∂àÊÅØ
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'log':
                    addLog(data.level || 'info', data.message);
                    break;
                case 'paper_added':
                    addPaper(data.paper);
                    break;
                case 'paper_updated':
                    updatePaper(data.paper_id, data.paper);
                    // Â¶ÇÊûúËÆ∫ÊñáÂ§ÑÁêÜÊàêÂäüÔºåÊ∑ªÂä†Âà∞ÁîüÊàêÂàóË°®
                    if (data.paper.status === 'success' && data.paper.score !== undefined && data.paper.score >= 0) {
                        addPaperToResultList(data.paper_id, data.paper);
                    }
                    break;
                case 'paper_removed':
                    removePaper(data.paper_id);
                    removePaperFromResultList(data.paper_id);
                    break;
                case 'file_generated':
                    addFile(data.file);
                    break;
                case 'agent_status':
                    addAgentStatus(data.agent_name, data.status, data.target, data.output, data.message);
                    break;
                case 'status':
                    if (runBtn) {
                        if (data.status === 'running') {
                            isRunning = true;
                            isWaitingConfirmation = false;
                            runBtn.classList.remove('waiting');
                            runBtn.classList.add('running');
                            runBtn.textContent = '‚è∏ ËøêË°å‰∏≠...';
                            runBtn.disabled = true;
                        } else if (data.status === 'waiting_confirmation') {
                            isRunning = false;
                            isWaitingConfirmation = true;
                            runBtn.classList.remove('running');
                            runBtn.classList.add('waiting');
                            runBtn.textContent = '‚è∏ Á≠âÂæÖ‰∫∫Â∑•Á°ÆËÆ§';
                            runBtn.disabled = false;
                        } else if (data.status === 'completed' || data.status === 'idle') {
                            isRunning = false;
                            isWaitingConfirmation = false;
                            runBtn.classList.remove('running', 'waiting');
                            runBtn.textContent = '‚ñ∂ ÂºÄÂßãËøêË°å';
                            runBtn.disabled = false;
                        }
                    }
                    break;
                case 'waiting_confirmation':
                    handleWaitingConfirmation(data.papers);
                    break;
                case 'paper_ready_for_confirmation':
                    handlePaperReadyForConfirmation(data.paper_id, data.paper);
                    break;
                case 'queue_status':
                    updateQueueStatus(data.count);
                    break;
            }
        }

        // Êõ¥Êñ∞‰ªªÂä°ÈòüÂàóÁä∂ÊÄÅÊòæÁ§∫
        function updateQueueStatus(count) {
            const queueCount = document.getElementById('queue-count');
            const queueHint = document.getElementById('queue-status-hint');
            if (queueCount) {
                queueCount.textContent = count;
                if (count > 0) {
                    queueCount.classList.add('active');
                    if (queueHint) queueHint.textContent = 'ÊâßË°å‰∏≠';
                } else {
                    queueCount.classList.remove('active');
                    if (queueHint) queueHint.textContent = 'Á©∫Èó≤';
                }
            }
        }

        // Ê∑ªÂä†Êó•Âøó
        function addLog(level, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            const timestamp = new Date().toLocaleTimeString();
            
            let statusText = '';
            let contentText = '';
            
            // ÂØπ‰∫éagent_startedÂíåagent_final_answerÔºå‰ΩøÁî®markdownÊ∏≤Êüì
            if (level === 'agent_started') {
                statusText = '[ Agent Started ]';
                try {
                    // ‰ΩøÁî®marked.jsÊ∏≤Êüìmarkdown
                    contentText = marked.parse(message);
                } catch (e) {
                    // Â¶ÇÊûúmarkdownËß£ÊûêÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÊôÆÈÄöÊñáÊú¨
                    const messageLines = message.split('\n');
                    contentText = messageLines
                        .map((line, index) => {
                            if (line.trim()) {
                                return escapeHtml(line);
                            }
                            return '';
                        })
                        .filter(line => line)
                        .join('<br>');
                }
            } else if (level === 'agent_final_answer') {
                statusText = '[ Agent Final Answer ]';
                try {
                    // ‰ΩøÁî®marked.jsÊ∏≤Êüìmarkdown
                    contentText = marked.parse(message);
                } catch (e) {
                    // Â¶ÇÊûúmarkdownËß£ÊûêÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÊôÆÈÄöÊñáÊú¨
                    const messageLines = message.split('\n');
                    contentText = messageLines
                        .map((line, index) => {
                            if (line.trim()) {
                                return escapeHtml(line);
                            }
                            return '';
                        })
                        .filter(line => line)
                        .join('<br>');
                }
            } else {
                // ÂÖ∂‰ªñÊ∂àÊÅØÔºöÊ†πÊçÆÂÜÖÂÆπÂà§Êñ≠Áä∂ÊÄÅÂíåÂÜÖÂÆπ
                const messageLines = message.split('\n');
                const firstLine = messageLines[0]?.trim() || '';
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÁä∂ÊÄÅÊ∂àÊÅØÔºàÂ¶Ç Crew:, Task:, Status:Ôºâ
                if (firstLine.includes('Crew:') || firstLine.includes('Task:') || firstLine.includes('Status:') || firstLine.includes('üîÑ') || firstLine.includes('üìã')) {
                    // ÊèêÂèñÁä∂ÊÄÅ‰ø°ÊÅØÔºåÊ†ºÂºèÂåñ‰∏∫Á±ª‰ºº "Crew: Crew | üìã Task: xxx | Status: Executing Task..."
                    const statusParts = [];
                    const contentParts = [];
                    
                    messageLines.forEach(line => {
                        const trimmed = line.trim();
                        if (!trimmed) return;
                        
                        // ÊèêÂèñÁä∂ÊÄÅË°åÔºàÂåÖÂê´ Crew, Task, Status, Tool Á≠âÂÖ≥ÈîÆËØçÔºâ
                        if (trimmed.includes('Crew:') || trimmed.includes('Task:') || trimmed.includes('Status:') || trimmed.includes('Tool:') || trimmed.includes('Tool Args:') || trimmed.includes('üîÑ') || trimmed.includes('üìã')) {
                            // Ê∏ÖÁêÜÊ†ºÂºèÔºåÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ
                            let cleanLine = trimmed;
                            if (cleanLine.includes('üîÑ')) cleanLine = cleanLine.replace('üîÑ', '').trim();
                            if (cleanLine.includes('üìã')) cleanLine = cleanLine.replace('üìã', '').trim();
                            statusParts.push(cleanLine);
                        } else {
                            // ÂÖ∂‰ªñÂÜÖÂÆπ
                            contentParts.push(trimmed);
                        }
                    });
                    
                    // Ê†ºÂºèÂåñÁä∂ÊÄÅÊñáÊú¨
                    if (statusParts.length > 0) {
                        statusText = `[ ${statusParts.join(' | ')} ]`;
                    } else {
                        statusText = `[ ${level.toUpperCase()} ]`;
                    }
                    
                    // ÂÜÖÂÆπÊñáÊú¨
                    contentText = contentParts.length > 0 ? contentParts.map(l => escapeHtml(l)).join('<br>') : '';
                    
                    // Â¶ÇÊûúÁä∂ÊÄÅÂåÖÂê´ "Executing Task"ÔºåÊ∑ªÂä†ËøõÂ∫¶Êù°
                    if (statusText.includes('Executing Task')) {
                        contentText = '<div class="progress-bar"><div class="progress-fill"></div></div>' + contentText;
                    }
                } else {
                    // ÊôÆÈÄöÊ∂àÊÅØ
                    statusText = `[ ${level.toUpperCase()} ]`;
                    contentText = messageLines
                        .map((line, index) => {
                            if (line.trim()) {
                                return escapeHtml(line);
                            }
                            return '';
                        })
                        .filter(line => line)
                        .join('<br>');
                }
            }
            
            entry.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div class="log-status">${statusText}</div>
                <div class="log-content">${contentText}</div>
            `;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // HTMLËΩ¨‰πâÂáΩÊï∞
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Ê∑ªÂä†agentÁä∂ÊÄÅ‰ø°ÊÅØ
        function addAgentStatus(agentName, status, target, output, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${status === 'start' ? 'info' : 'success'}`;
            const timestamp = new Date().toLocaleTimeString();
            
            let statusText = '';
            let contentText = '';
            
            if (status === 'start') {
                statusText = `[ ${agentName} Â∑•‰ΩúÂºÄÂßã ]`;
                if (target) {
                    contentText = escapeHtml(`ÁõÆÊ†áÊñáÁ´†Ôºö${target}`);
                } else {
                    contentText = escapeHtml(message || `${agentName}ÂºÄÂßãÂ∑•‰Ωú`);
                }
            } else if (status === 'end') {
                statusText = `[ ${agentName} Â∑•‰ΩúÁªìÊùü ]`;
                const contentParts = [];
                
                // Â¶ÇÊûúÊúâÁõÆÊ†áËÆ∫ÊñáÔºåÂÖàÊòæÁ§∫ÁõÆÊ†áËÆ∫Êñá
                if (target) {
                    contentParts.push(`ÁõÆÊ†áËÆ∫ÊñáÔºö${escapeHtml(target)}`);
                }
                
                // Â¶ÇÊûúÊúâËæìÂá∫ÔºåÊòæÁ§∫ËæìÂá∫
                if (output) {
                    // ËæìÂá∫‰ø°ÊÅØÂèØËÉΩÂæàÈïøÔºåÂè™ÊòæÁ§∫Ââç200Â≠óÁ¨¶
                    const outputPreview = output.length > 200 ? output.substring(0, 200) + '...' : output;
                    contentParts.push(`ËæìÂá∫Ôºö${escapeHtml(outputPreview)}`);
                }
                
                // Â¶ÇÊûúÈÉΩÊ≤°ÊúâÔºåÊòæÁ§∫ÈªòËÆ§Ê∂àÊÅØ
                if (contentParts.length === 0) {
                    contentText = escapeHtml(message || `${agentName}Â∑•‰ΩúÂÆåÊàê`);
                } else {
                    contentText = contentParts.join('<br>');
                }
            } else {
                statusText = `[ ${agentName} ]`;
                contentText = escapeHtml(message || `${agentName}Áä∂ÊÄÅÔºö${status}`);
            }
            
            entry.innerHTML = `
                <div class="log-status">${statusText}</div>
                <div class="log-content">${contentText}</div>
                <div style="font-size: 10px; color: rgba(255, 255, 255, 0.5); margin-top: 5px;">${timestamp}</div>
            `;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Ê∑ªÂä†ËÆ∫Êñá
        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        // ÁªüËÆ°ÂäüËÉΩÂ∑≤ÁßªÈô§

        function addPaper(paper) {
            // ÁßªÈô§"Â§ÑÁêÜ‰∏≠..."ÊèêÁ§∫
            if (paperList.children.length === 1) {
                const firstChild = paperList.firstElementChild;
                if (firstChild && firstChild.textContent.includes('Â§ÑÁêÜ‰∏≠...')) {
                    paperList.removeChild(firstChild);
                }
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÔºàÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†Ôºâ
            const existingPaper = document.getElementById(`paper-${paper.id}`);
            if (existingPaper) {
                return;
            }

            const paperItem = document.createElement('div');
            paperItem.className = 'paper-item';
            paperItem.id = `paper-${paper.id}`;
            // ‰øùÂ≠òÈìæÊé•Âà∞dataÂ±ûÊÄß
            if (paper.link) {
                paperItem.setAttribute('data-link', paper.link);
            }
            // ‰øùÂ≠òÁä∂ÊÄÅÂà∞dataÂ±ûÊÄßÔºå‰æø‰∫éÊéíÂ∫è
            paperItem.setAttribute('data-status', paper.status || 'pending');
            // ‰øùÂ≠òÊ†áÈ¢òÂà∞dataÂ±ûÊÄßÔºå‰æø‰∫éÊêúÁ¥¢
            paperItem.setAttribute('data-title', paper.title.toLowerCase());
            
            paperItem.innerHTML = `
                <div class="paper-header">
                    <div class="paper-title" title="${escapeHtml(paper.title)}">${escapeHtml(paper.title)}</div>
                    <div class="paper-status pending">‚è≥</div>
                </div>
                <button class="paper-toggle" onclick="event.stopPropagation(); toggleAbstract('${paper.id}')" style="display: none;">
                    ‚ñº Êü•ÁúãÊëòË¶Å
                </button>
                <div class="paper-abstract" id="abstract-${paper.id}"></div>
            `;
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºöÂú®Êñ∞Á™óÂè£ÊâìÂºÄËÆ∫ÊñáÈìæÊé•
            if (paper.link) {
                paperItem.addEventListener('click', function(e) {
                    // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊëòË¶ÅÂàáÊç¢ÊåâÈíÆ„ÄÅÊëòË¶ÅÂå∫ÂüüÊàñÂèØÁºñËæëÊëòË¶ÅÂå∫ÂüüÔºå‰∏çÊâìÂºÄÈìæÊé•
                    if (e.target.closest('.paper-toggle') || 
                        e.target.closest('.paper-abstract') || 
                        e.target.closest('.paper-abstract-editable')) {
                        return;
                    }
                    // Âú®Êñ∞Á™óÂè£ÊâìÂºÄÈìæÊé•
                    window.open(paper.link, '_blank');
                });
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÈìæÊé•ÔºåÁßªÈô§ÊåáÈíàÊ†∑Âºè
                paperItem.style.cursor = 'default';
            }
            
            paperList.appendChild(paperItem);
        }

        // Â§ÑÁêÜÁ≠âÂæÖÁ°ÆËÆ§Ê∂àÊÅØÔºàÊâπÈáèÊ®°ÂºèÔºåÂ∑≤ÂºÉÁî®Ôºâ
        function handleWaitingConfirmation(papers) {
            confirmationPapers = papers;
            isWaitingConfirmation = true;
            
            // ‰∏∫ÊØèÁØáËÆ∫ÊñáÊ∑ªÂä†ÂèØÁºñËæëÁöÑÊëòË¶ÅÊ°Ü
            for (const [paperId, paperData] of Object.entries(papers)) {
                addEditableAbstractToPaper(paperId, paperData);
            }
            
            addLog('info', `Á≠âÂæÖ‰∫∫Â∑•Á°ÆËÆ§ ${Object.keys(papers).length} ÁØáËÆ∫ÊñáÁöÑÊëòË¶Å`);
        }
        
        // Â§ÑÁêÜÂçï‰∏™ËÆ∫ÊñáÂáÜÂ§áÁ°ÆËÆ§Ê∂àÊÅØÔºàÂÆûÊó∂Ê®°ÂºèÔºâ
        function handlePaperReadyForConfirmation(paperId, paperData) {
            const paperItem = document.getElementById(`paper-${paperId}`);
            if (!paperItem) {
                return;
            }
            
            // Ê∑ªÂä†ÂèØÁºñËæëÊëòË¶ÅÊ°Ü
            addEditableAbstractToPaper(paperId, paperData);
            
            if (paperData.abstract && paperData.abstract.trim()) {
                addLog('info', `ËÆ∫Êñá "${paperData.title}" ÊëòË¶ÅÂ∑≤ÊèêÂèñÔºåÂèØ‰ª•ÁºñËæëÊëòË¶Å`);
            } else {
                addLog('info', `ËÆ∫Êñá "${paperData.title}" ÊëòË¶ÅÊèêÂèñÂ§±Ë¥•ÔºåÂèØ‰ª•ÊâãÂä®Ê∑ªÂä†ÊëòË¶Å`);
            }
        }
        
        // ‰∏∫ËÆ∫ÊñáÊ∑ªÂä†ÂèØÁºñËæëÊëòË¶ÅÊ°ÜÔºàÈÄöÁî®ÂáΩÊï∞Ôºâ
        function addEditableAbstractToPaper(paperId, paperData) {
            const paperItem = document.getElementById(`paper-${paperId}`);
            if (!paperItem) return;
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÂèØÁºñËæëÊëòË¶ÅÊ°Ü
            let editableAbstract = paperItem.querySelector('.paper-abstract-editable');
            if (!editableAbstract) {
                // ÂàõÂª∫ÂèØÁºñËæëÊëòË¶ÅÊ°Ü
                editableAbstract = document.createElement('div');
                editableAbstract.className = 'paper-abstract-editable';
                editableAbstract.id = `abstract-editable-${paperId}`;
                
                const textarea = document.createElement('textarea');
                textarea.id = `abstract-textarea-${paperId}`;
                textarea.value = paperData.abstract || '';
                textarea.placeholder = 'ËØ∑Âú®Ê≠§Â§ÑÁºñËæëÊàñÁ≤òË¥¥ËÆ∫ÊñáÊëòË¶Å...';
                
                editableAbstract.appendChild(textarea);
                
                // ÊèíÂÖ•Âà∞ËÆ∫ÊñáÈ°π‰∏≠ÔºàÂú®ÊëòË¶ÅÂàáÊç¢ÊåâÈíÆ‰πãÂêéÔºâ
                const toggleBtn = paperItem.querySelector('.paper-toggle');
                if (toggleBtn) {
                    toggleBtn.insertAdjacentElement('afterend', editableAbstract);
                } else {
                    const header = paperItem.querySelector('.paper-header');
                    header.insertAdjacentElement('afterend', editableAbstract);
                }
            } else {
                // Êõ¥Êñ∞Áé∞ÊúâÊëòË¶ÅÊ°ÜÁöÑÂÜÖÂÆπ
                // ÈáçË¶ÅÔºöÂ¶ÇÊûúÁî®Êà∑Â∑≤ÁªèÁºñËæëËøáÊëòË¶ÅÔºå‰∏çË¶ÅË¶ÜÁõñÁî®Êà∑ÁºñËæëÁöÑÂÜÖÂÆπ
                const textarea = editableAbstract.querySelector('textarea');
                if (textarea) {
                    // Âè™ÊúâÂΩìÊñ∞Êï∞ÊçÆÊúâÊëòË¶Å‰∏îÂΩìÂâçÊñáÊú¨Ê°Ü‰∏∫Á©∫Êó∂ÔºåÊâçÊõ¥Êñ∞
                    // ÊàñËÄÖÂ¶ÇÊûúÊñ∞Êï∞ÊçÆÁöÑÊëòË¶Å‰∏éÂΩìÂâçÂÜÖÂÆπ‰∏çÂêåÔºåÂèØËÉΩÊòØÁ≥ªÁªüÊõ¥Êñ∞ÔºåÈúÄË¶ÅÊõ¥Êñ∞
                    const currentValue = textarea.value.trim();
                    const newValue = (paperData.abstract || '').trim();
                    
                    // Â¶ÇÊûúÂΩìÂâçÊñáÊú¨Ê°Ü‰∏∫Á©∫Ôºå‰ΩøÁî®Êñ∞Êï∞ÊçÆ
                    // Â¶ÇÊûúÊñ∞Êï∞ÊçÆ‰∏ç‰∏∫Á©∫‰∏î‰∏éÂΩìÂâçÂÜÖÂÆπ‰∏çÂêåÔºåÂèØËÉΩÊòØÁ≥ªÁªüÊõ¥Êñ∞Ôºà‰æãÂ¶ÇÊëòË¶ÅÊèêÂèñÊàêÂäüÔºâÔºåÊõ¥Êñ∞ÂÜÖÂÆπ
                    if (currentValue === '' || (newValue !== '' && newValue !== currentValue)) {
                        textarea.value = newValue;
                    }
                    // Âê¶Âàô‰øùÊåÅÁî®Êà∑ÁºñËæëÁöÑÂÜÖÂÆπ‰∏çÂèò
                }
            }
            
            // ÊòæÁ§∫ÊëòË¶ÅÂàáÊç¢ÊåâÈíÆÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÊòæÁ§∫Ôºâ
            const toggleBtn = paperItem.querySelector('.paper-toggle');
            if (toggleBtn) {
                toggleBtn.style.display = 'block';
                toggleBtn.textContent = '‚ñº Êü•Áúã/ÁºñËæëÊëòË¶Å';
                toggleBtn.onclick = function(e) {
                    e.stopPropagation();
                    toggleEditableAbstract(paperId);
                };
            }
            
            // ÈªòËÆ§Â±ïÂºÄÂèØÁºñËæëÊëòË¶ÅÊ°Ü
            editableAbstract.classList.add('show');
        }
        
        // ÂàáÊç¢ÂèØÁºñËæëÊëòË¶ÅÊòæÁ§∫
        function toggleEditableAbstract(paperId) {
            const editableAbstract = document.getElementById(`abstract-editable-${paperId}`);
            const toggleBtn = editableAbstract ? editableAbstract.previousElementSibling : null;
            
            if (editableAbstract) {
                editableAbstract.classList.toggle('show');
                if (toggleBtn) {
                    toggleBtn.textContent = editableAbstract.classList.contains('show') 
                        ? '‚ñ≤ ÈöêËóèÊëòË¶Å' 
                        : '‚ñº Êü•Áúã/ÁºñËæëÊëòË¶Å';
                }
            }
        }

        // Êõ¥Êñ∞ËÆ∫ÊñáÁä∂ÊÄÅ
        function updatePaper(paperId, paper) {
            const paperItem = document.getElementById(`paper-${paperId}`);
            if (!paperItem) return;

            const statusEl = paperItem.querySelector('.paper-status');
            const toggleBtn = paperItem.querySelector('.paper-toggle');
            const abstractEl = paperItem.querySelector('.paper-abstract');

            // Áä∂ÊÄÅÊò†Â∞Ñ
            const statusMap = {
                'pending': { icon: '‚è≥', class: 'pending', text: 'Á≠âÂæÖÂ§ÑÁêÜ' },
                'analyzing_relevance': { icon: 'üîç', class: 'pending', text: 'Áõ∏ÂÖ≥ÊÄßÂàÜÊûê‰∏≠' },
                'extracting_abstract': { icon: 'üìÑ', class: 'pending', text: 'ÊëòË¶ÅÊèêÂèñ‰∏≠' },
                'abstract_extracted': { icon: '‚úì', class: 'pending', text: 'ÊëòË¶ÅÊèêÂèñÊàêÂäü' },
                'abstract_extraction_failed': { icon: '‚úó', class: 'pending', text: 'ÊëòË¶ÅÊèêÂèñÂ§±Ë¥•' },
                'waiting_confirmation': { icon: '‚úã', class: 'pending', text: 'Á≠âÂæÖ‰∫∫Â∑•Á°ÆËÆ§' },
                'abstract_confirmed': { icon: '‚úì', class: 'pending', text: 'ÊëòË¶ÅÂ∑≤Á°ÆËÆ§' },
                'validating_cleaning': { icon: 'üîé', class: 'pending', text: 'È™åËØÅ‰∏éÊ∏ÖÊ¥ó‰∏≠' },
                'translating': { icon: 'üåê', class: 'pending', text: 'ÁøªËØë‰∏≠' },
                'reviewing': { icon: '‚≠ê', class: 'pending', text: 'ËØÑÂÆ°‰∏≠' },
                'success': { icon: '‚úì', class: 'success', text: 'Â§ÑÁêÜÂÆåÊàê' },
                'error': { icon: '‚úó', class: 'error', text: 'Â§ÑÁêÜÂ§±Ë¥•' }
            };

            // Ëé∑ÂèñÁä∂ÊÄÅ‰ø°ÊÅØ
            const statusInfo = statusMap[paper.status] || statusMap['pending'];
            
            // Êõ¥Êñ∞Áä∂ÊÄÅÂõæÊ†áÂíåÊ†∑Âºè
            statusEl.className = `paper-status ${statusInfo.class}`;
            statusEl.textContent = statusInfo.icon;
            statusEl.setAttribute('title', paper.status_text || statusInfo.text);
            paperItem.setAttribute('data-status', paper.status || 'pending');

            // Â¶ÇÊûúÁä∂ÊÄÅÊñáÊú¨Â≠òÂú®ÔºåÂú®Ê†áÈ¢ò‰∏ãÊñπÊòæÁ§∫Áä∂ÊÄÅÊñáÊú¨
            let statusTextEl = paperItem.querySelector('.paper-status-text');
            if (paper.status_text && paper.status !== 'success' && paper.status !== 'error') {
                if (!statusTextEl) {
                    statusTextEl = document.createElement('div');
                    statusTextEl.className = 'paper-status-text';
                    statusTextEl.style.cssText = 'font-size: 11px; color: rgba(0, 217, 255, 0.7); margin-top: 5px;';
                    const header = paperItem.querySelector('.paper-header');
                    header.insertAdjacentElement('afterend', statusTextEl);
                }
                statusTextEl.textContent = paper.status_text;
                statusTextEl.style.display = 'block';
            } else if (statusTextEl) {
                statusTextEl.style.display = 'none';
            }

            // Â§ÑÁêÜÊàêÂäüÁä∂ÊÄÅ
            if (paper.status === 'success') {
                if (paper.abstract) {
                    toggleBtn.style.display = 'block';
                    abstractEl.textContent = paper.abstract;
                }
            }
            
            // Êõ¥Êñ∞Ê†áÈ¢òÔºàÂ¶ÇÊûúÊèê‰æõ‰∫ÜÊñ∞Ê†áÈ¢òÔºâ
            if (paper.title) {
                const titleEl = paperItem.querySelector('.paper-title');
                if (titleEl) {
                    titleEl.textContent = paper.title;
                    titleEl.setAttribute('title', paper.title);
                    paperItem.setAttribute('data-title', paper.title.toLowerCase());
                }
            }
            
            // Êõ¥Êñ∞ÈìæÊé•ÔºàÂ¶ÇÊûúÊèê‰æõ‰∫ÜÊñ∞ÈìæÊé•Ôºâ
            if (paper.link) {
                paperItem.setAttribute('data-link', paper.link);
            }
            
        }
        
        // Âà†Èô§ËÆ∫Êñá
        function removePaper(paperId) {
            const paperItem = document.getElementById(`paper-${paperId}`);
            if (paperItem) {
                paperItem.remove();
            }
        }

        // ÂàáÊç¢ÊëòË¶ÅÊòæÁ§∫
        function toggleAbstract(paperId) {
            const abstractEl = document.getElementById(`abstract-${paperId}`);
            const toggleBtn = abstractEl.previousElementSibling;
            abstractEl.classList.toggle('show');
            toggleBtn.textContent = abstractEl.classList.contains('show') ? '‚ñ≤ ÈöêËóèÊëòË¶Å' : '‚ñº Êü•ÁúãÊëòË¶Å';
        }
        
        // ÊâìÂºÄËÆ∫ÊñáÈìæÊé•
        function openPaperLink(link) {
            if (link) {
                window.open(link, '_blank');
            }
        }
        
        // Á°ÆËÆ§Âπ∂ÁªßÁª≠ËøêË°å
        function confirmAndContinue() {
            // Êî∂ÈõÜÊâÄÊúâÂèØÁºñËæëÊëòË¶ÅÊ°ÜÁöÑÂÜÖÂÆπÔºàÂåÖÊã¨ÂÆûÊó∂ÊòæÁ§∫ÁöÑÔºâ
            const confirmedPapers = {};
            
            // Êî∂ÈõÜÊâÄÊúâÂèØÁºñËæëÊëòË¶ÅÊ°ÜÔºàÂåÖÊã¨Á©∫ÊëòË¶ÅÔºåÁî®Êà∑ÂèØËÉΩÂ∑≤ÁªèÊâãÂä®Ê∑ªÂä†Ôºâ
            const allTextareas = document.querySelectorAll('textarea[id^="abstract-textarea-"]');
            allTextareas.forEach(textarea => {
                const paperId = textarea.id.replace('abstract-textarea-', '');
                const abstractText = textarea.value.trim();
                // Âç≥‰ΩøÊëòË¶Å‰∏∫Á©∫‰πüÊî∂ÈõÜÔºåÂõ†‰∏∫Áî®Êà∑ÂèØËÉΩÊ≠£Âú®ÁºñËæëÊàñÂ∑≤ÁªèÁ°ÆËÆ§‰∏∫Á©∫
                confirmedPapers[paperId] = abstractText;
            });
            
            // Â¶ÇÊûúÊ≤°ÊúâÊî∂ÈõÜÂà∞‰ªª‰ΩïÊëòË¶ÅÊ°ÜÔºåÂ∞ùËØï‰ªé confirmationPapers ‰∏≠Êî∂ÈõÜ
            if (Object.keys(confirmedPapers).length === 0) {
                for (const paperId of Object.keys(confirmationPapers)) {
                    const textarea = document.getElementById(`abstract-textarea-${paperId}`);
                    if (textarea) {
                        const abstractText = textarea.value.trim();
                        // Âç≥‰ΩøÊëòË¶Å‰∏∫Á©∫‰πüÊî∂ÈõÜ
                        confirmedPapers[paperId] = abstractText;
                    }
                }
            }
            
            // ÂèëÈÄÅÁ°ÆËÆ§ËØ∑Ê±Ç
            fetch('/api/confirm_abstracts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    papers: confirmedPapers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('success', `Â∑≤Á°ÆËÆ§ ${Object.keys(confirmedPapers).length} ÁØáËÆ∫ÊñáÁöÑÊëòË¶ÅÔºåÁªßÁª≠Â§ÑÁêÜ...`);
                    isWaitingConfirmation = false;
                    confirmationPapers = {};
                } else {
                    addLog('error', `Á°ÆËÆ§Â§±Ë¥•: ${data.error}`);
                }
            })
            .catch(error => {
                addLog('error', `Á°ÆËÆ§ËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}`);
            });
        }

        // Ê∑ªÂä†Êñá‰ª∂
        function addFile(file) {
            addLog('success', `Êñá‰ª∂Â∑≤ÁîüÊàê: ${file.name}`);
            
            // ÊòæÁ§∫Êñá‰ª∂ÂàóË°®Âå∫Âüü
            const fileListSection = document.getElementById('file-list-section');
            const fileList = document.getElementById('file-list');
            
            if (!fileListSection || !fileList) {
                return;
            }
            
            // ÊòæÁ§∫Êñá‰ª∂ÂàóË°®Âå∫Âüü
            fileListSection.style.display = 'block';
            
            // ÂàõÂª∫Êñá‰ª∂È°π
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.dataset.filePath = file.path;
            
            // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãËÆæÁΩÆÂõæÊ†á
            const fileIcon = file.type === 'md' ? 'üìÑ' : 'üìä';
            const fileTypeText = file.type === 'md' ? 'Markdown' : 'CSV';
            
            // ËΩ¨‰πâÊñá‰ª∂Ë∑ØÂæÑÂíåÂêçÁß∞‰∏≠ÁöÑÁâπÊÆäÂ≠óÁ¨¶
            const escapedPath = file.path.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const escapedName = file.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            fileItem.innerHTML = `
                <div class="file-item-content">
                    <div class="file-item-icon">${fileIcon}</div>
                    <div class="file-item-info">
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-meta">
                            <span class="file-item-type">${fileTypeText}</span>
                            <span class="file-item-size">${file.size}</span>
                            <span class="file-item-time">${file.time}</span>
                        </div>
                    </div>
                </div>
                <div class="file-item-actions">
                    <button class="file-action-btn" onclick="downloadFile('${escapedPath}', '${escapedName}')" title="‰∏ãËΩΩ">
                        ‚¨áÔ∏è
                    </button>
                    <button class="file-action-btn" onclick="openFile('${escapedPath}')" title="ÊâìÂºÄ">
                        üîç
                    </button>
                </div>
            `;
            
            // Ê∑ªÂä†Âà∞Êñá‰ª∂ÂàóË°®ÔºàÊñ∞Êñá‰ª∂Ê∑ªÂä†Âà∞È°∂ÈÉ®Ôºâ
            fileList.insertBefore(fileItem, fileList.firstChild);
        }

        // ÊâìÂºÄÊñá‰ª∂
        function openFile(filePath) {
            fetch(`/api/open_file?path=${encodeURIComponent(filePath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog('success', `Â∑≤ÊâìÂºÄÊñá‰ª∂: ${filePath}`);
                    } else {
                        addLog('error', `Êó†Ê≥ïÊâìÂºÄÊñá‰ª∂: ${data.error}`);
                    }
                })
                .catch(error => {
                    addLog('error', `ÊâìÂºÄÊñá‰ª∂Â§±Ë¥•: ${error.message}`);
                });
        }

        // ‰∏ãËΩΩÊñá‰ª∂
        function downloadFile(filePath, fileName) {
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const link = document.createElement('a');
            link.href = `/api/download_file?path=${encodeURIComponent(filePath)}`;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            addLog('success', `ÂºÄÂßã‰∏ãËΩΩ: ${fileName}`);
        }

        // ========== ËÆ∫ÊñáÁªìÊûúÂàóË°®ÂäüËÉΩ ==========
        const paperResultList = document.getElementById('paper-result-list');
        const processedPapers = {}; // Â≠òÂÇ®Â∑≤Â§ÑÁêÜÁöÑËÆ∫ÊñáÊï∞ÊçÆ {paper_id: paper_data}

        // Ê∑ªÂä†ËÆ∫ÊñáÂà∞ÁîüÊàêÂàóË°®
        function addPaperToResultList(paperId, paper) {
            // Âè™Ê∑ªÂä†ÊàêÂäüÂ§ÑÁêÜ‰∏îËØÑÂàÜ>=0ÁöÑËÆ∫Êñá
            if (paper.status !== 'success' || paper.score === undefined || paper.score < 0) {
                return;
            }

            // ‰øùÂ≠òËÆ∫ÊñáÊï∞ÊçÆ
            processedPapers[paperId] = paper;

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
            const existingItem = document.getElementById(`result-paper-${paperId}`);
            if (existingItem) {
                updatePaperResultItem(paperId, paper);
                return;
            }

            // ÁßªÈô§"Á≠âÂæÖÂ§ÑÁêÜËÆ∫Êñá..."ÊèêÁ§∫
            if (paperResultList && paperResultList.children.length === 1) {
                const firstChild = paperResultList.firstElementChild;
                if (firstChild && firstChild.textContent.includes('Á≠âÂæÖÂ§ÑÁêÜËÆ∫Êñá...')) {
                    paperResultList.removeChild(firstChild);
                }
            }

            // ÂàõÂª∫ËÆ∫ÊñáÁªìÊûúÈ°π
            const resultItem = document.createElement('div');
            resultItem.className = 'paper-result-item';
            resultItem.id = `result-paper-${paperId}`;
            resultItem.onclick = () => openPaperReviewWindow(paperId, paper);

            const scoreClass = paper.score >= 3.5 ? 'high-value' : '';
            resultItem.innerHTML = `
                <div class="paper-result-title" title="${escapeHtml(paper.title || '')}">
                    ${escapeHtml(paper.title || 'Unknown')}
                </div>
                <div class="paper-result-meta">
                    <span>ËØÑÂàÜ: <span class="paper-result-score ${scoreClass}">${paper.score ? paper.score.toFixed(2) : '0.00'}/4.0</span></span>
                    ${paper.is_high_value ? '<span style="color: var(--neon-green);">‚≠ê È´ò‰ª∑ÂÄº</span>' : ''}
                </div>
            `;

            if (paperResultList) {
                paperResultList.appendChild(resultItem);
            }
        }

        // Êõ¥Êñ∞ËÆ∫ÊñáÁªìÊûúÈ°π
        function updatePaperResultItem(paperId, paper) {
            const resultItem = document.getElementById(`result-paper-${paperId}`);
            if (!resultItem) return;

            processedPapers[paperId] = paper;

            const scoreClass = paper.score >= 3.5 ? 'high-value' : '';
            resultItem.innerHTML = `
                <div class="paper-result-title" title="${escapeHtml(paper.title || '')}">
                    ${escapeHtml(paper.title || 'Unknown')}
                </div>
                <div class="paper-result-meta">
                    <span>ËØÑÂàÜ: <span class="paper-result-score ${scoreClass}">${paper.score ? paper.score.toFixed(2) : '0.00'}/4.0</span></span>
                    ${paper.is_high_value ? '<span style="color: var(--neon-green);">‚≠ê È´ò‰ª∑ÂÄº</span>' : ''}
                </div>
            `;
            resultItem.onclick = () => openPaperReviewWindow(paperId, paper);
        }

        // ‰ªéÁîüÊàêÂàóË°®ÁßªÈô§ËÆ∫Êñá
        function removePaperFromResultList(paperId) {
            const resultItem = document.getElementById(`result-paper-${paperId}`);
            if (resultItem) {
                resultItem.remove();
            }
            delete processedPapers[paperId];

            // Â¶ÇÊûúÊ≤°ÊúâËÆ∫Êñá‰∫ÜÔºåÊòæÁ§∫ÊèêÁ§∫
            if (paperResultList && paperResultList.children.length === 0) {
                paperResultList.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 40px 20px;">Á≠âÂæÖÂ§ÑÁêÜËÆ∫Êñá...</div>';
            }
        }

        // ÊâìÂºÄËÆ∫ÊñáËØÑÂÆ°Á™óÂè£
        function openPaperReviewWindow(paperId, paper) {
            // Ëé∑ÂèñÂÆåÊï¥ÁöÑËÆ∫ÊñáÊï∞ÊçÆÔºàÂåÖÊã¨Â§öÊ®°ÂûãÁªìÊûúÔºâ
            const fullPaper = processedPapers[paperId] || paper;
            
            // ËÆ°ÁÆóÁ™óÂè£Â±Ö‰∏≠‰ΩçÁΩÆ
            const windowWidth = 1200;
            const windowHeight = 800;
            const left = (screen.width - windowWidth) / 2;
            const top = (screen.height - windowHeight) / 2;
            
            // ÂàõÂª∫Êñ∞Á™óÂè£ÔºàÂ±Ö‰∏≠ÊòæÁ§∫Ôºâ
            const reviewWindow = window.open('', '_blank', 
                `width=${windowWidth},height=${windowHeight},` +
                `left=${left},top=${top},` +
                `scrollbars=yes,resizable=yes`);
            if (!reviewWindow) {
                addLog('error', 'Êó†Ê≥ïÊâìÂºÄÊñ∞Á™óÂè£ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÂºπÁ™óËÆæÁΩÆ');
                return;
            }

            // ÊûÑÂª∫HTMLÂÜÖÂÆπ
            const multiModelResults = fullPaper.multi_model_results || {};
            const summaryResult = fullPaper.summary_result || null;
            const modelIds = Object.keys(multiModelResults);
            
            let tabsHtml = '';
            let contentHtml = '';
            let tabIndex = 0;
            
            // Â¶ÇÊûúÊúâÊ±áÊÄªÁªìÊûúÔºåÂÖàÊ∑ªÂä†Ê±áÊÄªÊ†áÁ≠æÈ°µ
            if (summaryResult) {
                const isActive = tabIndex === 0 ? 'active' : '';
                tabsHtml += `<button class="review-tab ${isActive}" onclick="switchReviewTab('summary')">üìä Ê±áÊÄª</button>`;
                
                const isContentActive = tabIndex === 0 ? 'active' : '';
                // ÊûÑÂª∫Ê±áÊÄªÂÜÖÂÆπ
                let summaryContent = '';
                if (summaryResult.consensus_points) {
                    summaryContent += `**ÂÖ±ËØÜË¶ÅÁÇπ**Ôºö\n\n${summaryResult.consensus_points}\n\n`;
                }
                if (summaryResult.divergence_points) {
                    summaryContent += `**ÂàÜÊ≠ßÂàÜÊûê**Ôºö\n\n${summaryResult.divergence_points}\n\n`;
                }
                if (summaryResult.final_review) {
                    summaryContent += `**ÁªºÂêàËØÑÂÆ°Êä•Âëä**Ôºö\n\n${summaryResult.final_review}\n\n`;
                }
                if (summaryResult.final_score_details && Object.keys(summaryResult.final_score_details).length > 0) {
                    summaryContent += `**ÊúÄÁªàËØÑÂàÜËØ¶ÊÉÖ**Ôºö\n\n`;
                    for (const [dim, score] of Object.entries(summaryResult.final_score_details)) {
                        summaryContent += `- ${dim}Ôºö${score.toFixed(2)}/1.0\n`;
                    }
                    summaryContent += `\n`;
                }
                if (summaryResult.model_consistency !== undefined) {
                    summaryContent += `**Ê®°Âûã‰∏ÄËá¥ÊÄß**Ôºö${(summaryResult.model_consistency * 100).toFixed(1)}%\n\n`;
                }
                if (summaryResult.confidence !== undefined) {
                    summaryContent += `**ÁªìÊûúÂèØ‰ø°Â∫¶**Ôºö${(summaryResult.confidence * 100).toFixed(1)}%\n\n`;
                }
                
                contentHtml += `
                    <div class="review-content ${isContentActive}" id="review-content-summary">
                        <div class="review-markdown" id="review-markdown-summary">
                            ${escapeHtml(summaryContent || 'ÊöÇÊó†Ê±áÊÄªÁªìÊûú')}
                        </div>
                    </div>
                `;
                tabIndex++;
            }
            
            // Ê∑ªÂä†ÂêÑ‰∏™Ê®°ÂûãÁöÑÊ†áÁ≠æÈ°µ
            if (modelIds.length > 0) {
                modelIds.forEach((modelId) => {
                    const modelResult = multiModelResults[modelId];
                    const modelName = modelResult.model_name || modelId;
                    const isActive = tabIndex === 0 && !summaryResult ? 'active' : '';
                    tabsHtml += `<button class="review-tab ${isActive}" onclick="switchReviewTab('${modelId}')">${escapeHtml(modelName)}</button>`;
                    
                    const isContentActive = tabIndex === 0 && !summaryResult ? 'active' : '';
                    contentHtml += `
                        <div class="review-content ${isContentActive}" id="review-content-${modelId}">
                            <div class="review-markdown" id="review-markdown-${modelId}">
                                ${escapeHtml(modelResult.review || 'ÊöÇÊó†ËØÑÂÆ°ÁªìÊûú')}
                            </div>
                        </div>
                    `;
                    tabIndex++;
                });
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÂ§öÊ®°ÂûãÁªìÊûúÔºåÊòæÁ§∫Âçï‰∏ÄËØÑÂÆ°ÁªìÊûú
                if (!summaryResult) {
                    tabsHtml = '<button class="review-tab active">ËØÑÂÆ°ÁªìÊûú</button>';
                    contentHtml = `
                        <div class="review-content active">
                            <div class="review-markdown">
                                ${escapeHtml(fullPaper.review || 'ÊöÇÊó†ËØÑÂÆ°ÁªìÊûú')}
                            </div>
                        </div>
                    `;
                }
            }

            // ÂÖàÂ∫èÂàóÂåñJSONÊï∞ÊçÆÔºåÈÅøÂÖçÂú®Ê®°ÊùøÂ≠óÁ¨¶‰∏≤‰∏≠ÂµåÂ•ó${}
            const multiModelResultsJson = JSON.stringify(multiModelResults);
            const summaryResultJson = JSON.stringify(summaryResult);
            const fullPaperReviewJson = JSON.stringify(fullPaper.review || '');
            
            // ‰ΩøÁî®Â≠óÁ¨¶‰∏≤ÊãºÊé•ËÄå‰∏çÊòØÊ®°ÊùøÂ≠óÁ¨¶‰∏≤ÔºåÈÅøÂÖçJSON‰∏≠ÁöÑÁâπÊÆäÂ≠óÁ¨¶ÂØºËá¥ËØ≠Ê≥ïÈîôËØØ
            const htmlContent = '<!DOCTYPE html>\n' +
'<html lang="zh-CN">\n' +
'<head>\n' +
'    <meta charset="UTF-8">\n' +
'    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
'    <title>ËÆ∫ÊñáËØÑÂÆ° - ' + escapeHtml(fullPaper.title || 'Unknown') + '</title>\n' +
'    <script>\n' +
'        // Âä®ÊÄÅÂä†ËΩΩ marked.jsÔºåÈÅøÂÖç document.write Ë≠¶Âëä\n' +
'        (function() {\n' +
'            const script = document.createElement(\'script\');\n' +
'            script.src = \'https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js\';\n' +
'            script.async = true;\n' +
'            document.head.appendChild(script);\n' +
'        })();\n' +
'    <\/script>\n' +
'    <style>\n' +
'        * { margin: 0; padding: 0; box-sizing: border-box; }\n' +
'        body { font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; background: #0a0e27; color: #fff; padding: 20px; overflow-y: auto; }\n' +
'        .review-header { background: rgba(10, 20, 40, 0.7); border: 2px solid #00d9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px; }\n' +
'        .review-title { font-size: 20px; font-weight: 600; color: #00d9ff; margin-bottom: 10px; }\n' +
'        .review-meta { display: flex; gap: 20px; font-size: 14px; color: rgba(255, 255, 255, 0.7); }\n' +
'        .review-meta a { color: #00d9ff; text-decoration: none; }\n' +
'        .review-meta a:hover { text-decoration: underline; }\n' +
'        .review-tabs { display: flex !important; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid rgba(0, 217, 255, 0.3); padding-bottom: 10px; visibility: visible !important; opacity: 1 !important; }\n' +
'        .review-tab { background: rgba(0, 217, 255, 0.1); border: 1px solid #00d9ff; border-radius: 6px; padding: 10px 20px; color: #00d9ff; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; }\n' +
'        .review-tab:hover { background: rgba(0, 217, 255, 0.2); }\n' +
'        .review-tab.active { background: rgba(0, 217, 255, 0.3); border-color: #00d9ff; box-shadow: 0 0 15px rgba(0, 217, 255, 0.4); }\n' +
'        .review-content { display: none; background: rgba(10, 20, 40, 0.7); border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 12px; padding: 30px; min-height: 500px; max-height: calc(100vh - 300px); overflow-y: auto; }\n' +
'        .review-content.active { display: block; }\n' +
'        .review-markdown { line-height: 1.8; color: rgba(255, 255, 255, 0.9); }\n' +
'        .review-markdown h1, .review-markdown h2, .review-markdown h3 { color: #00d9ff; margin-top: 20px; margin-bottom: 10px; }\n' +
'        .review-markdown p { margin-bottom: 15px; }\n' +
'        .review-markdown code { background: rgba(0, 0, 0, 0.3); padding: 2px 6px; border-radius: 3px; font-family: \'Courier New\', monospace; }\n' +
'        .review-markdown pre { background: rgba(0, 0, 0, 0.5); padding: 15px; border-radius: 6px; overflow-x: auto; margin: 15px 0; }\n' +
'        .review-markdown pre code { background: transparent; padding: 0; }\n' +
'        .review-markdown strong { color: #00d9ff; }\n' +
'        .review-markdown ul, .review-markdown ol { margin-left: 20px; margin-bottom: 15px; }\n' +
'        .review-markdown li { margin-bottom: 8px; }\n' +
'        /* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè - ‰∏é‰∏ªUIÈ£éÊ†º‰∏ÄËá¥ */\n' +
'        body::-webkit-scrollbar, .review-content::-webkit-scrollbar { width: 10px; }\n' +
'        body::-webkit-scrollbar-track, .review-content::-webkit-scrollbar-track { background: transparent; }\n' +
'        body::-webkit-scrollbar-thumb, .review-content::-webkit-scrollbar-thumb { background: rgba(0, 217, 255, 0.2); border-radius: 10px; border: 2px solid transparent; background-clip: padding-box; }\n' +
'        body::-webkit-scrollbar-thumb:hover, .review-content::-webkit-scrollbar-thumb:hover { background: rgba(0, 217, 255, 0.3); background-clip: padding-box; }\n' +
'        body { scrollbar-width: thin; scrollbar-color: rgba(0, 217, 255, 0.2) transparent; }\n' +
'        .review-content { scrollbar-width: thin; scrollbar-color: rgba(0, 217, 255, 0.2) transparent; }\n' +
'    </style>\n' +
'</head>\n' +
'<body>\n' +
'    <div class="review-header">\n' +
'        <div class="review-title">' + escapeHtml(fullPaper.title || 'Unknown') + '</div>\n' +
'        <div class="review-meta">\n' +
'            <span>ËØÑÂàÜ: <strong style="color: #00d9ff;">' + (fullPaper.score ? fullPaper.score.toFixed(2) : '0.00') + '/4.0</strong></span>\n' +
(fullPaper.is_high_value ? '            <span style="color: #0f0;">‚≠ê È´ò‰ª∑ÂÄºËÆ∫Êñá</span>\n' : '') +
(fullPaper.link ? '            <span><a href="' + escapeHtml(fullPaper.link) + '" target="_blank">Êü•ÁúãÂéüÊñá</a></span>\n' : '') +
'        </div>\n' +
'    </div>\n' +
(tabsHtml ? '    <div class="review-tabs">' + tabsHtml + '</div>\n' : '') +
contentHtml + '\n' +
'    <script>\n' +
'        const multiModelResults = ' + multiModelResultsJson + ';\n' +
'        const summaryResult = ' + summaryResultJson + ';\n' +
'\n' +
'        function switchReviewTab(tabId) {\n' +
'            document.querySelectorAll(\'.review-content\').forEach(content => {\n' +
'                content.classList.remove(\'active\');\n' +
'            });\n' +
'            document.querySelectorAll(\'.review-tab\').forEach(tab => {\n' +
'                tab.classList.remove(\'active\');\n' +
'            });\n' +
'            const content = document.getElementById(\'review-content-\' + tabId);\n' +
'            if (content) {\n' +
'                content.classList.add(\'active\');\n' +
'            }\n' +
'            event.target.classList.add(\'active\');\n' +
'            if (content && window.marked) {\n' +
'                const markdownEl = content.querySelector(\'.review-markdown\');\n' +
'                if (markdownEl) {\n' +
'                    let reviewText = \'\';\n' +
'                    if (tabId === \'summary\') {\n' +
'                        // ÊòæÁ§∫Ê±áÊÄªÁªìÊûú\n' +
'                        if (summaryResult) {\n' +
'                            if (summaryResult.consensus_points) {\n' +
'                                reviewText += \'**ÂÖ±ËØÜË¶ÅÁÇπ**Ôºö\\n\\n\' + summaryResult.consensus_points + \'\\n\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.divergence_points) {\n' +
'                                reviewText += \'**ÂàÜÊ≠ßÂàÜÊûê**Ôºö\\n\\n\' + summaryResult.divergence_points + \'\\n\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.final_review) {\n' +
'                                reviewText += \'**ÁªºÂêàËØÑÂÆ°Êä•Âëä**Ôºö\\n\\n\' + summaryResult.final_review + \'\\n\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.final_score_details && Object.keys(summaryResult.final_score_details).length > 0) {\n' +
'                                reviewText += \'**ÊúÄÁªàËØÑÂàÜËØ¶ÊÉÖ**Ôºö\\n\\n\';\n' +
'                                for (const [dim, score] of Object.entries(summaryResult.final_score_details)) {\n' +
'                                    reviewText += \'- \' + dim + \'Ôºö\' + score.toFixed(2) + \'/1.0\\n\';\n' +
'                                }\n' +
'                                reviewText += \'\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.model_consistency !== undefined) {\n' +
'                                reviewText += \'**Ê®°Âûã‰∏ÄËá¥ÊÄß**Ôºö\' + (summaryResult.model_consistency * 100).toFixed(1) + \'%\\n\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.confidence !== undefined) {\n' +
'                                reviewText += \'**ÁªìÊûúÂèØ‰ø°Â∫¶**Ôºö\' + (summaryResult.confidence * 100).toFixed(1) + \'%\\n\\n\';\n' +
'                            }\n' +
'                        } else {\n' +
'                            reviewText = \'ÊöÇÊó†Ê±áÊÄªÁªìÊûú\';\n' +
'                        }\n' +
'                    } else if (multiModelResults[tabId]) {\n' +
'                        // ÊòæÁ§∫Âçï‰∏™Ê®°ÂûãÁöÑÁªìÊûú\n' +
'                        reviewText = multiModelResults[tabId].review || \'\';\n' +
'                    } else {\n' +
'                        reviewText = \'ÊöÇÊó†ËØÑÂÆ°ÁªìÊûú\';\n' +
'                    }\n' +
'                    markdownEl.innerHTML = window.marked.parse(reviewText);\n' +
'                }\n' +
'            }\n' +
'        }\n' +
'\n' +
'        window.addEventListener(\'DOMContentLoaded\', () => {\n' +
'            const firstContent = document.querySelector(\'.review-content.active\');\n' +
'            if (firstContent && window.marked) {\n' +
'                const markdownEl = firstContent.querySelector(\'.review-markdown\');\n' +
'                if (markdownEl) {\n' +
'                    let reviewText = \'\';\n' +
'                    if (summaryResult) {\n' +
'                        // ÈªòËÆ§ÊòæÁ§∫Ê±áÊÄªÁªìÊûú\n' +
'                        if (summaryResult.consensus_points) {\n' +
'                            reviewText += \'**ÂÖ±ËØÜË¶ÅÁÇπ**Ôºö\\n\\n\' + summaryResult.consensus_points + \'\\n\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.divergence_points) {\n' +
'                            reviewText += \'**ÂàÜÊ≠ßÂàÜÊûê**Ôºö\\n\\n\' + summaryResult.divergence_points + \'\\n\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.final_review) {\n' +
'                            reviewText += \'**ÁªºÂêàËØÑÂÆ°Êä•Âëä**Ôºö\\n\\n\' + summaryResult.final_review + \'\\n\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.final_score_details && Object.keys(summaryResult.final_score_details).length > 0) {\n' +
'                            reviewText += \'**ÊúÄÁªàËØÑÂàÜËØ¶ÊÉÖ**Ôºö\\n\\n\';\n' +
'                            for (const [dim, score] of Object.entries(summaryResult.final_score_details)) {\n' +
'                                reviewText += \'- \' + dim + \'Ôºö\' + score.toFixed(2) + \'/1.0\\n\';\n' +
'                            }\n' +
'                            reviewText += \'\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.model_consistency !== undefined) {\n' +
'                            reviewText += \'**Ê®°Âûã‰∏ÄËá¥ÊÄß**Ôºö\' + (summaryResult.model_consistency * 100).toFixed(1) + \'%\\n\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.confidence !== undefined) {\n' +
'                            reviewText += \'**ÁªìÊûúÂèØ‰ø°Â∫¶**Ôºö\' + (summaryResult.confidence * 100).toFixed(1) + \'%\\n\\n\';\n' +
'                        }\n' +
'                    } else {\n' +
'                        const firstModelId = Object.keys(multiModelResults)[0];\n' +
'                        if (firstModelId) {\n' +
'                            reviewText = multiModelResults[firstModelId].review || \'\';\n' +
'                        } else {\n' +
'                            reviewText = ' + fullPaperReviewJson + ';\n' +
'                        }\n' +
'                    }\n' +
'                    markdownEl.innerHTML = window.marked.parse(reviewText);\n' +
'                }\n' +
'            }\n' +
'        });\n' +
'    <\/script>\n' +
'<\/body>\n' +
'<\/html>';

            // ‰ΩøÁî®Êõ¥ÂÆâÂÖ®ÁöÑÊñπÂºèÂÜôÂÖ•ÂÜÖÂÆπ
            reviewWindow.document.open();
            reviewWindow.document.write(htmlContent);
            reviewWindow.document.close();
            
            // Á≠âÂæÖ marked.js Âä†ËΩΩÂÆåÊàêÂêéÂÜçÊ∏≤Êüì
            const checkMarked = setInterval(function() {
                if (reviewWindow.marked) {
                    clearInterval(checkMarked);
                    // Ê∏≤ÊüìÊâÄÊúâ Markdown ÂÜÖÂÆπ
                    reviewWindow.document.querySelectorAll('.review-markdown').forEach(function(el) {
                        if (el.textContent && !el.innerHTML.includes('<')) {
                            // Â¶ÇÊûúÂÜÖÂÆπËøòÊòØÁ∫ØÊñáÊú¨ÔºåËØ¥ÊòéËøòÊ≤°Ê∏≤Êüì
                            el.innerHTML = reviewWindow.marked.parse(el.textContent);
                        }
                    });
                }
            }, 100);
            
            // 10ÁßíÂêéÂÅúÊ≠¢Ê£ÄÊü•
            setTimeout(function() {
                clearInterval(checkMarked);
            }, 10000);
        }

        // HTMLËΩ¨‰πâÂáΩÊï∞ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
        if (typeof escapeHtml === 'undefined') {
            window.escapeHtml = function(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
        }

        // ÂºÄÂßãËøêË°åÊàñÁªßÁª≠ËøêË°åÔºàÂ¶ÇÊûúrunBtnÂ≠òÂú®Ôºâ
        if (runBtn) {
            runBtn.addEventListener('click', () => {
            // Â¶ÇÊûúÊ≠£Âú®Á≠âÂæÖÁ°ÆËÆ§ÔºåÂèëÈÄÅÁ°ÆËÆ§ËØ∑Ê±Ç
            if (isWaitingConfirmation) {
                confirmAndContinue();
                return;
            }
            
            if (isRunning) return;

            const mode = document.querySelector('input[name="mode"]:checked').value;
            const keywords = document.getElementById('keywords').value.trim();
            const config = {
                mode: mode,
                keywords: keywords || 'Êú∫Âô®‰∫∫Â≠¶„ÄÅÊéßÂà∂ÁêÜËÆ∫„ÄÅÈÅ•Êìç‰Ωú„ÄÅÊú∫Âô®‰∫∫Âä®ÂäõÂ≠¶„ÄÅÂäõÊéß„ÄÅÊú∫Âô®Â≠¶‰π†'
            };

            if (mode === 'local') {
                const csvFileInput = document.getElementById('csv-file');
                if (!csvFileInput || !csvFileInput.files || csvFileInput.files.length === 0) {
                    addLog('error', 'ËØ∑ÈÄâÊã©CSVÊñá‰ª∂');
                    return;
                }
            } else {
                // Â∞ÜÊó•ÊúüËΩ¨Êç¢‰∏∫Â§©Êï∞
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    startDate.setHours(0, 0, 0, 0);
                    const diffTime = today - startDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    config.start_days = diffDays;
                } else {
                    config.start_days = 1; // ÈªòËÆ§Êò®Â§©
                }
                
                if (endDateInput.value) {
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(0, 0, 0, 0);
                    const diffTime = today - endDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    config.end_days = diffDays;
                } else {
                    config.end_days = 0; // ÈªòËÆ§‰ªäÂ§©
                }
            }

            // Ê∏ÖÁ©∫ÂàóË°®
            if (paperList) {
                paperList.innerHTML = '<div style="text-align: center; color: #666; padding: 40px 20px;">Â§ÑÁêÜ‰∏≠...</div>';
            }
            // Ê≥®ÊÑèÔºöfileList Â∑≤Êîπ‰∏∫ paperResultListÔºå‰ΩÜËøôÈáå‰∏çÈúÄË¶ÅÊ∏ÖÁ©∫ÔºåÂõ†‰∏∫ËÆ∫ÊñáÁªìÊûú‰ºöÂú®Â§ÑÁêÜÂÆåÊàêÂêéËá™Âä®Ê∑ªÂä†

            // ÂèëÈÄÅÂêØÂä®ËØ∑Ê±Ç
            let requestPromise;
            if (mode === 'local') {
                // Êú¨Âú∞CSVÊ®°ÂºèÔºö‰ΩøÁî®FormData‰∏ä‰º†Êñá‰ª∂
                const csvFileInput = document.getElementById('csv-file');
                const formData = new FormData();
                formData.append('csv_file', csvFileInput.files[0]);
                formData.append('config', JSON.stringify(config));
                
                requestPromise = fetch('/api/start', {
                    method: 'POST',
                    body: formData
                });
            } else if (mode === 'pdf') {
                // ËÆ∫ÊñáPDFÊ®°ÂºèÔºö‰ΩøÁî®FormData‰∏ä‰º†PDFÊñá‰ª∂ÔºàÊîØÊåÅÂ§öÊñá‰ª∂Ôºâ
                const pdfFileInput = document.getElementById('pdf-file');
                if (!pdfFileInput.files || pdfFileInput.files.length === 0) {
                    alert('ËØ∑ÂÖàÈÄâÊã©PDFÊñá‰ª∂');
                    isRunning = false;
                    if (runBtn) runBtn.disabled = false;
                    return;
                }
                const formData = new FormData();
                // Ê∑ªÂä†ÊâÄÊúâPDFÊñá‰ª∂
                for (let i = 0; i < pdfFileInput.files.length; i++) {
                    formData.append('pdf_files', pdfFileInput.files[i]);
                }
                formData.append('config', JSON.stringify(config));
                
                requestPromise = fetch('/api/start', {
                    method: 'POST',
                    body: formData
                });
            } else {
                // ÈÇÆÁÆ±Ê®°ÂºèÔºöÂèëÈÄÅJSONÈÖçÁΩÆ
                requestPromise = fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
            }
            
            requestPromise
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('success', '‰ªªÂä°Â∑≤ÂêØÂä®');
                } else {
                    addLog('error', `ÂêØÂä®Â§±Ë¥•: ${data.error}`);
                }
            })
            .catch(error => {
                addLog('error', `ËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}`);
            });
            });
        }

        // ÂàùÂßãÂåñÁªü‰∏ÄÊñá‰ª∂‰∏ä‰º†Â§ÑÁêÜ
        function initFileUploadHandler() {
            const fileInput = document.getElementById('file-input');
            const fileDropZone = document.getElementById('file-drop-zone');
            const fileListDisplay = document.getElementById('file-list-display');
            
            if (!fileInput || !fileDropZone || !fileListDisplay) {
                setTimeout(initFileUploadHandler, 100);
                return;
            }
            
            const fileDropContent = fileDropZone.querySelector('.file-drop-content');
            
            // ÁÇπÂáªÈÄâÊã©Êñá‰ª∂ÔºàÁ°Æ‰øùÁÇπÂáªÊï¥‰∏™Âå∫ÂüüÈÉΩËÉΩËß¶ÂèëÔºâ
            fileDropZone.addEventListener('click', function(e) {
                // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÊñá‰ª∂ËæìÂÖ•Ê°ÜÊú¨Ë∫´ÔºåËß¶ÂèëÊñá‰ª∂ÈÄâÊã©
                if (e.target !== fileInput) {
                    e.preventDefault();
                    e.stopPropagation();
                    fileInput.click();
                }
            });
            
            // Á°Æ‰øùÊñá‰ª∂ËæìÂÖ•Ê°ÜÊú¨Ë∫´‰πüËÉΩËß¶Âèë
            if (fileInput) {
                fileInput.style.pointerEvents = 'auto';
                fileInput.style.cursor = 'pointer';
                fileInput.style.position = 'absolute';
                fileInput.style.top = '0';
                fileInput.style.left = '0';
                fileInput.style.width = '100%';
                fileInput.style.height = '100%';
                fileInput.style.opacity = '0';
                fileInput.style.zIndex = '10';
            }
            
            // Á°Æ‰øùÊñá‰ª∂ËæìÂÖ•Ê°ÜÊú¨Ë∫´‰πüËÉΩËß¶ÂèëÔºà‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÂ§ÑÁêÜÔºåÂõ†‰∏∫Â∑≤ÁªèËÆæÁΩÆ‰∫ÜÊ†∑ÂºèÔºâ
            
            // Êñá‰ª∂ÈÄâÊã©ÂèòÂåñ‰∫ã‰ª∂ÔºàÊîØÊåÅÂ§öÊñá‰ª∂Ôºâ
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                handleFileSelect(files, fileListDisplay, fileDropContent);
                // Ëá™Âä®‰∏ä‰º†Êñá‰ª∂
                if (files && files.length > 0) {
                    uploadFiles(files);
                }
            });
            
            // ÊãñÊãΩ‰∫ã‰ª∂
            fileDropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileDropZone.classList.add('drag-over');
            });
            
            fileDropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileDropZone.classList.remove('drag-over');
            });
            
            fileDropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileDropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    // ËøáÊª§Âá∫CSVÂíåPDFÊñá‰ª∂
                    const validFiles = Array.from(files).filter(file => {
                        const ext = file.name.toLowerCase();
                        return ext.endsWith('.csv') || ext.endsWith('.pdf');
                    });
                    
                    if (validFiles.length > 0) {
                        // ÂàõÂª∫Êñ∞ÁöÑFileListÂØπË±°Âπ∂ËÆæÁΩÆÂà∞input
                        const dataTransfer = new DataTransfer();
                        validFiles.forEach(file => dataTransfer.items.add(file));
                        fileInput.files = dataTransfer.files;
                        handleFileSelect(fileInput.files, fileListDisplay, fileDropContent);
                        // Ëá™Âä®‰∏ä‰º†Êñá‰ª∂
                        uploadFiles(fileInput.files);
                    } else {
                        alert('ËØ∑ÈÄâÊã© CSV Êàñ PDF Êñá‰ª∂');
                    }
                }
            });
        }
        
        // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©ÔºàÊîØÊåÅÂ§öÊñá‰ª∂Ôºâ
        function handleFileSelect(files, fileListDisplay, fileDropContent) {
            if (files && files.length > 0) {
                const fileCount = files.length;
                const fileNames = Array.from(files).map(f => f.name);
                
                if (fileCount === 1) {
                    fileListDisplay.textContent = `Â∑≤ÈÄâÊã©: ${fileNames[0]}`;
                } else {
                    fileListDisplay.textContent = `Â∑≤ÈÄâÊã© ${fileCount} ‰∏™Êñá‰ª∂: ${fileNames.join(', ')}`;
                }
                fileListDisplay.style.color = '#00ff88';
                
                // Êõ¥Êñ∞ÊãñÊãΩÂå∫ÂüüÊòæÁ§∫
                const icon = fileDropContent.querySelector('.file-drop-icon');
                const text = fileDropContent.querySelector('.file-drop-text');
                if (icon) icon.textContent = '‚úì';
                if (text) {
                    if (fileCount === 1) {
                        text.textContent = fileNames[0];
                    } else {
                        text.textContent = `Â∑≤ÈÄâÊã© ${fileCount} ‰∏™Êñá‰ª∂`;
                    }
                    text.style.color = '#00ff88';
                }
            } else {
                fileListDisplay.textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                fileListDisplay.style.color = 'rgba(255, 255, 255, 0.7)';
                
                // ÊÅ¢Â§çÊãñÊãΩÂå∫ÂüüÊòæÁ§∫
                const icon = fileDropContent.querySelector('.file-drop-icon');
                const text = fileDropContent.querySelector('.file-drop-text');
                if (icon) icon.textContent = 'üìÅ';
                if (text) {
                    text.textContent = 'ËØ∑ÈÄâÊã©Êñá‰ª∂';
                    text.style.color = 'var(--neon-cyan)';
                }
            }
        }
        
        // Êñá‰ª∂Áä∂ÊÄÅÁÆ°ÁêÜ
        const fileStatusMap = new Map(); // Â≠òÂÇ®Êñá‰ª∂Áä∂ÊÄÅ {fileName: {status, details, progress}}

        // Ê∑ªÂä†Êñá‰ª∂Âà∞Áä∂ÊÄÅÂàóË°®
        function addFileToStatusList(fileName, file) {
            const fileId = `${fileName}_${Date.now()}`;
            const statusItem = {
                id: fileId,
                fileName: fileName,
                file: file,
                status: 'uploading',
                details: 'ÂáÜÂ§á‰∏ä‰º†...',
                progress: 0,
                timestamp: Date.now()
            };
            
            fileStatusMap.set(fileId, statusItem);
            updateFileStatusDisplay();
            return fileId;
        }

        // Êõ¥Êñ∞Êñá‰ª∂Áä∂ÊÄÅ
        function updateFileStatus(fileId, status, details, progress) {
            const statusItem = fileStatusMap.get(fileId);
            if (statusItem) {
                statusItem.status = status;
                statusItem.details = details || statusItem.details;
                statusItem.progress = progress !== undefined ? progress : statusItem.progress;
                updateFileStatusDisplay();
            }
        }

        // Êõ¥Êñ∞Êñá‰ª∂Áä∂ÊÄÅÊòæÁ§∫
        function updateFileStatusDisplay() {
            const fileStatusList = document.getElementById('file-status-list');
            if (!fileStatusList) return;

            const taskQueueSection = document.getElementById('task-queue-section');
            
            if (fileStatusMap.size === 0) {
                fileStatusList.innerHTML = '<div class="file-status-empty">ÊöÇÊó†‰∏ä‰º†Êñá‰ª∂</div>';
                // Â¶ÇÊûú‰∏§‰∏™ÂàóË°®ÈÉΩ‰∏∫Á©∫ÔºåÈöêËóèÊï¥‰∏™Âå∫Âüü
                if (taskQueueSection && pendingPapers.length === 0) {
                    taskQueueSection.style.display = 'none';
                }
                return;
            }

            // ÊòæÁ§∫‰ªªÂä°ÈòüÂàóÂå∫ÂüüÔºåÂπ∂ÂàáÊç¢Âà∞Êñá‰ª∂Ê†áÁ≠æ
            if (taskQueueSection) {
                taskQueueSection.style.display = 'flex';
                // ÂàáÊç¢Âà∞Êñá‰ª∂Ê†áÁ≠æ
                switchTaskTab('files');
            }

            fileStatusList.innerHTML = '';
            
            // ÊåâÊó∂Èó¥Êà≥ÂÄíÂ∫èÊéíÂàóÔºàÊúÄÊñ∞ÁöÑÂú®‰∏äÔºâ
            const sortedFiles = Array.from(fileStatusMap.values()).sort((a, b) => b.timestamp - a.timestamp);
            
            sortedFiles.forEach(item => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-status-item ${item.status}`;
                fileItem.dataset.fileId = item.id;
                
                const statusLabels = {
                    'uploading': '‰∏ä‰º†‰∏≠',
                    'parsing': 'Ëß£Êûê‰∏≠',
                    'processing': 'Áü•ËØÜÂ∑•Á®ãÂ§ÑÁêÜ‰∏≠',
                    'completed': 'ÂÆåÊàê',
                    'failed': 'Â§±Ë¥•'
                };
                
                fileItem.innerHTML = `
                    <div class="file-status-icon ${item.status}"></div>
                    <div class="file-status-info">
                        <div class="file-status-name" title="${item.fileName}">${item.fileName}</div>
                        <div class="file-status-details">
                            <span class="file-status-badge ${item.status}">${statusLabels[item.status] || item.status}</span>
                            <span>${item.details}</span>
                        </div>
                    </div>
                    <div class="file-status-progress">
                        <div class="file-status-progress-bar" style="width: ${item.progress}%"></div>
                    </div>
                `;
                
                fileStatusList.appendChild(fileItem);
            });
        }

        // Ê∏ÖÁ©∫Êñá‰ª∂Áä∂ÊÄÅÂàóË°®
        function clearFileStatusList() {
            fileStatusMap.clear();
            updateFileStatusDisplay();
        }

        // ‰∏ä‰º†Êñá‰ª∂Âà∞ÂêéÁ´ØËß£Êûê
        function uploadFiles(files) {
            if (!files || files.length === 0) {
                return;
            }
            
            // ÈÄê‰∏™‰∏ä‰º†Êñá‰ª∂
            Array.from(files).forEach((file, index) => {
                const fileId = addFileToStatusList(file.name, file);
                
                addLog('info', `Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂: ${file.name}...`);
                updateFileStatus(fileId, 'uploading', 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...', 10);
                
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/api/upload/parse', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    updateFileStatus(fileId, 'parsing', 'Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºåÂºÄÂßãËß£Êûê...', 30);
                    // Ê£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅ
                    if (!response.ok) {
                        // Â∞ùËØïËß£ÊûêÈîôËØØÂìçÂ∫î
                        return response.json().then(err => {
                            throw new Error(err.error || `HTTPÈîôËØØ: ${response.status}`);
                        }).catch(() => {
                            throw new Error(`HTTPÈîôËØØ: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateFileStatus(fileId, 'processing', 'Ëß£ÊûêÂÆåÊàêÔºåÁü•ËØÜÂ∑•Á®ãÂ§ÑÁêÜ‰∏≠...', 60);
                        addLog('success', `Êñá‰ª∂Ëß£ÊûêÊàêÂäü: ${file.name}`);
                        if (data.message) {
                            addLog('info', data.message);
                        }
                        
                        // ÊòæÁ§∫Ëß£ÊûêÁªìÊûú
                        displayParseResult(data, file.name, fileId);
                        
                        // Êõ¥Êñ∞‰∏∫ÂÆåÊàêÁä∂ÊÄÅ
                        const knowledgeResult = data.data?.knowledge_result;
                        if (knowledgeResult && knowledgeResult.success) {
                            const chunksStored = knowledgeResult.chunks_stored || 0;
                            updateFileStatus(fileId, 'completed', `Â§ÑÁêÜÂÆåÊàêÔºåÂ∑≤Â≠òÂÇ® ${chunksStored} ‰∏™ÊñáÊú¨Âùó`, 100);
                        } else {
                            updateFileStatus(fileId, 'completed', 'Â§ÑÁêÜÂÆåÊàê', 100);
                        }
                    } else {
                        const errorMsg = data.error || 'Êú™Áü•ÈîôËØØ';
                        updateFileStatus(fileId, 'failed', `Â§ÑÁêÜÂ§±Ë¥•: ${errorMsg}`, 100);
                        addLog('error', `Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ${file.name} - ${errorMsg}`);
                    }
                })
                .catch(error => {
                    const errorMsg = error.message || 'Êú™Áü•ÈîôËØØ';
                    updateFileStatus(fileId, 'failed', `‰∏ä‰º†Â§±Ë¥•: ${errorMsg}`, 100);
                    addLog('error', `Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•: ${file.name} - ${errorMsg}`);
                    console.error('Êñá‰ª∂‰∏ä‰º†ÈîôËØØ:', error);
                });
            });
        }
        
        // ÊòæÁ§∫Ëß£ÊûêÁªìÊûú
        function displayParseResult(responseData, fileName, fileId) {
            // responseDataÊòØÂÆåÊï¥ÁöÑÂìçÂ∫îÂØπË±°ÔºåÂåÖÂê´success„ÄÅdata„ÄÅmessageÁ≠âÂ≠óÊÆµ
            const data = responseData.data || {};
            const parseData = data.parse_result || data.data || data;
            const knowledgeResult = data.knowledge_result;
            
            const sourceType = parseData.file_type || parseData.source_type;
            
            if (sourceType === 'csv') {
                addLog('info', `CSVÊñá‰ª∂Ëß£ÊûêÁªìÊûú: ${parseData.total_rows || 0} Ë°å, ${parseData.columns?.length || 0} Âàó`);
                if (parseData.columns) {
                    addLog('info', `Âàó‰ø°ÊÅØ: ${parseData.columns.map(c => c.name).join(', ')}`);
                }
            } else if (sourceType === 'pdf') {
                const metadata = parseData.metadata || {};
                addLog('info', `PDFÊñá‰ª∂Ëß£ÊûêÁªìÊûú: ${parseData.page_count || 0} È°µ`);
                if (metadata.title) {
                    addLog('info', `Ê†áÈ¢ò: ${metadata.title}`);
                }
                if (metadata.authors) {
                    addLog('info', `‰ΩúËÄÖ: ${metadata.authors}`);
                }
            }
            
            // ÊòæÁ§∫Áü•ËØÜÂ∑•Á®ãÂ§ÑÁêÜÁªìÊûú
            if (knowledgeResult) {
                if (knowledgeResult.success) {
                    addLog('success', `‚úì Áü•ËØÜÂ∑•Á®ãÂ§ÑÁêÜÊàêÂäü: Â∑≤Â≠òÂÇ® ${knowledgeResult.chunks_stored || 0} ‰∏™ÊñáÊú¨ÂùóÂà∞Áü•ËØÜÂ∫ì`);
                    addLog('info', `ËÆ∫ÊñáID: ${knowledgeResult.paper_id || 'N/A'}`);
                } else {
                    addLog('error', `‚úó Áü•ËØÜÂ∑•Á®ãÂ§ÑÁêÜÂ§±Ë¥•: ${knowledgeResult.error || 'Êú™Áü•ÈîôËØØ'}`);
                }
            }
        }

        // ÂàùÂßãÂåñÊ∏ÖÁ©∫Êñá‰ª∂ÂàóË°®ÊåâÈíÆ
        function initClearFilesButton() {
            const clearBtn = document.getElementById('clear-files-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    if (fileStatusMap.size > 0) {
                        if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊñá‰ª∂Áä∂ÊÄÅËÆ∞ÂΩïÂêóÔºü')) {
                            clearFileStatusList();
                        }
                    }
                });
            }
        }

        // ÂàùÂßãÂåñ
        // Á°Æ‰øùDOMÂä†ËΩΩÂÆåÊàêÂêéÂÜçÂàùÂßãÂåñ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initFileUploadHandler();
                initCollapseButton();
                initChatInput();
                initClearFilesButton();
                connectWebSocket();
            });
        } else {
            // DOMÂ∑≤ÁªèÂä†ËΩΩÂÆåÊàê
            initFileUploadHandler();
            initCollapseButton();
            initChatInput();
            initClearFilesButton();
            connectWebSocket();
        }
    </script>

    <!-- ËÆæÁΩÆÂºπÁ™ó -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h3>ËÆæÁΩÆ</h3>
                <button class="settings-close" id="settings-close">‚úï</button>
            </div>
            <div class="settings-body">
                <!-- Ê®°ÂûãÈÖçÁΩÆÈÉ®ÂàÜ -->
                <div class="settings-section">
                    <h4 style="color: var(--neon-cyan); margin-bottom: 15px; font-size: 16px;">ü§ñ Ê®°ÂûãÈÖçÁΩÆ</h4>
                    <button class="btn-add-model" id="btn-add-model">+ Ê∑ªÂä†Ê®°Âûã</button>
                    <div class="model-list" id="model-list">
                        <!-- Ê®°ÂûãÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>

                <!-- APIÈÖçÁΩÆÈÉ®ÂàÜ -->
                <div class="settings-section">
                    <h4 style="color: var(--neon-purple); margin-bottom: 15px; font-size: 16px;">üîë Â§ñÈÉ®ÊúçÂä°ÈÖçÁΩÆ</h4>
                    <div class="setting-item">
                        <label>Firecrawl API Key:</label>
                        <input type="password" id="firecrawl-api-key" placeholder="ËæìÂÖ•ÊÇ®ÁöÑ Firecrawl API Key" style="width: 100%; background: rgba(0, 20, 40, 0.6); border: 1px solid rgba(191, 0, 255, 0.3); border-radius: 4px; padding: 8px; color: var(--neon-purple); margin-top: 5px;">
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <button class="btn-save" id="btn-save-models">‰øùÂ≠òÈÖçÁΩÆ</button>
            </div>
        </div>
    </div>

    <script>
        // ËÆæÁΩÆÂºπÁ™óÂäüËÉΩÔºàÁ°Æ‰øùDOMÂ∑≤Âä†ËΩΩÔºâ
        let settingsBtn, settingsModal, settingsClose, btnAddModel, modelList, btnSaveModels;
        let models = [];
        let settingsInitialized = false;

            // ÂÖ®Â±ÄÂáΩÊï∞ÔºöÊâìÂºÄËÆæÁΩÆÂºπÁ™óÔºà‰Ωú‰∏∫Â§áÈÄâÊñπÊ°àÔºâ
        window.openSettingsModal = function() {
            if (!settingsInitialized) {
                initSettingsModal();
            }
            const modal = document.getElementById('settings-modal');
            if (modal) {
                loadModelsForModal();
                modal.classList.add('active');
            }
        };

        // Âä†ËΩΩÊ®°ÂûãÂàóË°®ÔºàÁã¨Á´ãÂáΩÊï∞Ôºå‰æõonclick‰ΩøÁî®Ôºâ
        function loadModelsForModal() {
            fetch('/api/models')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ‰ΩøÁî®ÊúçÂä°Âô®ËøîÂõûÁöÑÈÖçÁΩÆÔºåËÄå‰∏çÊòØ‰πãÂâçÂÜÖÂ≠ò‰∏≠ÁöÑÈÖçÁΩÆ
                        models = data.models || [];
                        // Á°Æ‰øùÊØè‰∏™Ê®°ÂûãÈÉΩÊúâcollapsed„ÄÅis_defaultÂíåenabledÂ±ûÊÄß
                        let hasDefault = false;
                        models.forEach(model => {
                            if (model.collapsed === undefined) {
                                model.collapsed = true; // ÈªòËÆ§ÊäòÂè†
                            }
                            if (model.is_default === true) {
                                hasDefault = true;
                            }
                            if (model.enabled === undefined) {
                                model.enabled = true; // ÈªòËÆ§ÂêØÁî®
                            }
                        });
                        // Â¶ÇÊûúÊ≤°ÊúâÈªòËÆ§Ê®°ÂûãÔºåÂ∞ÜÁ¨¨‰∏Ä‰∏™ËÆæ‰∏∫ÈªòËÆ§
                        if (!hasDefault && models.length > 0) {
                            models[0].is_default = true;
                        }
                        if (window.renderModels) {
                            window.renderModels();
                        }
                    } else {
                        addLog('error', `Âä†ËΩΩÊ®°ÂûãÈÖçÁΩÆÂ§±Ë¥•: ${data.error}`);
                    }
                })
                .catch(error => {
                    addLog('error', `Âä†ËΩΩÊ®°ÂûãÈÖçÁΩÆÂ§±Ë¥•: ${error.message}`);
                });
        }

        function initSettingsModal() {
            settingsBtn = document.getElementById('settings-btn');
            settingsModal = document.getElementById('settings-modal');
            settingsClose = document.getElementById('settings-close');
            btnAddModel = document.getElementById('btn-add-model');
            modelList = document.getElementById('model-list');
            btnSaveModels = document.getElementById('btn-save-models');

            if (!settingsBtn || !settingsModal || !settingsClose || !btnAddModel || !modelList || !btnSaveModels) {
                return false;
            }

            // Âä†ËΩΩÊ®°ÂûãÂàóË°®Ôºà‰ªéÊúçÂä°Âô®ËØªÂèñÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆÔºâ
            function loadModels() {
                fetch('/api/models')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // ‰ΩøÁî®ÊúçÂä°Âô®ËøîÂõûÁöÑÈÖçÁΩÆÔºåËÄå‰∏çÊòØ‰πãÂâçÂÜÖÂ≠ò‰∏≠ÁöÑÈÖçÁΩÆ
                            models = data.models || [];
                            // Á°Æ‰øùÊØè‰∏™Ê®°ÂûãÈÉΩÊúâcollapsed„ÄÅis_defaultÂíåenabledÂ±ûÊÄß
                            let hasDefault = false;
                            models.forEach(model => {
                                if (model.collapsed === undefined) {
                                    model.collapsed = true; // ÈªòËÆ§ÊäòÂè†
                                }
                                if (model.is_default === true) {
                                    hasDefault = true;
                                }
                                if (model.enabled === undefined) {
                                    model.enabled = true; // ÈªòËÆ§ÂêØÁî®
                                }
                            });
                            // Â¶ÇÊûúÊ≤°ÊúâÈªòËÆ§Ê®°ÂûãÔºåÂ∞ÜÁ¨¨‰∏Ä‰∏™ËÆæ‰∏∫ÈªòËÆ§
                            if (!hasDefault && models.length > 0) {
                                models[0].is_default = true;
                            }
                            renderModels();
                            // Âä†ËΩΩÂ§ñÈÉ®ÊúçÂä°ÈÖçÁΩÆ
                            loadExternalServices();
                        } else {
                            addLog('error', `Âä†ËΩΩÊ®°ÂûãÈÖçÁΩÆÂ§±Ë¥•: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        addLog('error', `Âä†ËΩΩÊ®°ÂûãÈÖçÁΩÆÂ§±Ë¥•: ${error.message}`);
                    });
            }

            // Ê∏≤ÊüìÊ®°ÂûãÂàóË°®
            function renderModels() {
                if (!modelList) return;
                
                modelList.innerHTML = '';
                
                if (models.length === 0) {
                    modelList.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">ÊöÇÊó†Ê®°ÂûãÈÖçÁΩÆÔºåÁÇπÂáª"Ê∑ªÂä†Ê®°Âûã"ÂàõÂª∫</div>';
                    return;
                }

                models.forEach((model, index) => {
                    const modelItem = document.createElement('div');
                    modelItem.className = 'model-item';
                    const isCollapsed = model.collapsed !== false; // ÈªòËÆ§ÊäòÂè†
                    modelItem.innerHTML = `
                        <div class="model-item-header">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <button class="btn-collapse" onclick="toggleModelCollapse(${index})" title="${isCollapsed ? 'Â±ïÂºÄ' : 'ÊäòÂè†'}">
                                    ${isCollapsed ? '‚ñ∂' : '‚ñº'}
                                </button>
                                <label class="default-model-radio">
                                    <input type="radio" name="default-model" value="${index}" 
                                           ${model.is_default ? 'checked' : ''} 
                                           onchange="setDefaultModel(${index})">
                                    <span class="radio-label">ÈªòËÆ§</span>
                                </label>
                                <label class="enable-model-checkbox">
                                    <input type="checkbox" 
                                           ${model.enabled !== false ? 'checked' : ''} 
                                           onchange="toggleModelEnabled(${index}, this.checked)">
                                    <span class="checkbox-label">ÂêØÁî®</span>
                                </label>
                                <input type="text" class="model-title-input" value="${model.name || 'Êú™ÂëΩÂêçÊ®°Âûã'}" 
                                       onchange="updateModel(${index}, 'name', this.value)" 
                                       placeholder="Ê®°ÂûãÂêçÁß∞"
                                       style="background: transparent; border: none; border-bottom: 1px solid var(--neon-cyan); color: var(--neon-cyan); font-family: 'Rajdhani', sans-serif; font-size: 16px; font-weight: 600; padding: 4px 8px; flex: 1;">
                            </div>
                            <div class="model-item-actions">
                                <button class="btn-test" onclick="testModel(${index})">ÊµãËØï</button>
                                <button class="btn-delete" onclick="deleteModel(${index})">Âà†Èô§</button>
                            </div>
                        </div>
                        <div class="model-item-content" style="display: ${isCollapsed ? 'none' : 'block'}; margin-top: 15px;">
                            <div class="model-form-group">
                                <label>Ê®°ÂûãÁ±ªÂûã</label>
                                <select onchange="updateModelType(${index}, this.value)">
                                    <option value="local" ${model.type === 'local' ? 'selected' : ''}>Êú¨Âú∞Ê®°Âûã (Ollama)</option>
                                    <option value="remote" ${model.type === 'remote' ? 'selected' : ''}>ËøúÁ®ãÊ®°Âûã (API)</option>
                                </select>
                            </div>
                            ${model.type === 'local' ? `
                                <div class="model-form-group">
                                    <label>Base URL</label>
                                    <input type="text" value="${model.base_url || ''}" onchange="updateModel(${index}, 'base_url', this.value)" placeholder="‰æãÂ¶Ç: http://localhost:11434">
                                </div>
                                <div class="model-form-group">
                                    <label>Ê®°ÂûãÂêçÁß∞</label>
                                    <input type="text" value="${model.model_name || ''}" onchange="updateModel(${index}, 'model_name', this.value)" placeholder="‰æãÂ¶Ç: qwen2.5:32b">
                                </div>
                            ` : `
                                <div class="model-form-group">
                                    <label>API Key</label>
                                    <input type="password" value="${model.api_key || ''}" onchange="updateModel(${index}, 'api_key', this.value)" placeholder="ËæìÂÖ•APIÂØÜÈí•">
                                </div>
                                <div class="model-form-group">
                                    <label>Base URL / API Base</label>
                                    <input type="text" value="${model.base_url || model.api_base || ''}" onchange="updateModel(${index}, 'base_url', this.value)" placeholder="‰æãÂ¶Ç: https://api.openai.com/v1">
                                </div>
                                <div class="model-form-group">
                                    <label>Ê®°ÂûãÂêçÁß∞ (ÂèØÈÄâ)</label>
                                    <input type="text" value="${model.model_name || ''}" onchange="updateModel(${index}, 'model_name', this.value)" placeholder="‰æãÂ¶Ç: gpt-4">
                                </div>
                            `}
                            <div class="model-form-group">
                                <label>ÊèèËø∞ (ÂèØÈÄâ)</label>
                                <input type="text" value="${model.description || ''}" onchange="updateModel(${index}, 'description', this.value)" placeholder="Ê®°ÂûãÊèèËø∞">
                            </div>
                        </div>
                    `;
                    modelList.appendChild(modelItem);
                });
            }

            // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
            window.renderModels = renderModels;

            // ÊâìÂºÄËÆæÁΩÆÂºπÁ™ó
            settingsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                loadModels();
                settingsModal.classList.add('active');
            });

            // ÂÖ≥Èó≠ËÆæÁΩÆÂºπÁ™ó
            settingsClose.addEventListener('click', () => {
                settingsModal.classList.remove('active');
            });

            // ÁßªÈô§ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠ÂäüËÉΩÔºåÂè™ËÉΩÈÄöËøáXÊåâÈíÆÂÖ≥Èó≠

            // Ê∑ªÂä†Êñ∞Ê®°ÂûãÔºàÊ∑ªÂä†Âà∞ÊúÄ‰∏äÈù¢Ôºâ
            btnAddModel.addEventListener('click', () => {
                const newModel = {
                    id: `model_${Date.now()}`,
                    name: 'Êñ∞Ê®°Âûã',
                    type: 'local',
                    base_url: 'http://localhost:11434',
                    model_name: 'qwen2.5:32b',
                    api_key: '',
                    description: '',
                    collapsed: false, // Êñ∞Ê∑ªÂä†ÁöÑÊ®°ÂûãÈªòËÆ§Â±ïÂºÄ
                    is_default: models.length === 0, // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™Ê®°ÂûãÔºåËá™Âä®ËÆæ‰∏∫ÈªòËÆ§
                    enabled: true // Êñ∞Ê∑ªÂä†ÁöÑÊ®°ÂûãÈªòËÆ§ÂêØÁî®
                };
                // Â¶ÇÊûúËøôÊòØÁ¨¨‰∏Ä‰∏™Ê®°ÂûãÔºåËÆæ‰∏∫ÈªòËÆ§ÔºõÂê¶ÂàôÊ∏ÖÈô§ÂÖ∂‰ªñÊ®°ÂûãÁöÑÈªòËÆ§Ê†áËÆ∞
                if (models.length === 0) {
                    newModel.is_default = true;
                } else {
                    models.forEach(model => {
                        model.is_default = false;
                    });
                }
                models.unshift(newModel); // ‰ΩøÁî®unshiftÊ∑ªÂä†Âà∞Êï∞ÁªÑÂºÄÂ§¥
                renderModels();
            });

            // ‰øùÂ≠òÊ®°ÂûãÈÖçÁΩÆ
            btnSaveModels.addEventListener('click', () => {
                // È™åËØÅÊâÄÊúâÊ®°ÂûãÈÖçÁΩÆ
                let hasError = false;
                for (let i = 0; i < models.length; i++) {
                    const model = models[i];
                    if (!model.name || !model.name.trim()) {
                        addLog('error', `Ê®°Âûã ${i + 1} Áº∫Â∞ëÂêçÁß∞`);
                        hasError = true;
                    }
                    if (model.type === 'local') {
                        if (!model.base_url || !model.model_name) {
                            addLog('error', `Ê®°Âûã "${model.name}" Áº∫Â∞ëÂøÖË¶ÅÈÖçÁΩÆÔºàBase URL ÊàñÊ®°ÂûãÂêçÁß∞Ôºâ`);
                            hasError = true;
                        }
                    } else if (model.type === 'remote') {
                        if (!model.api_key || (!model.base_url && !model.api_base)) {
                            addLog('error', `Ê®°Âûã "${model.name}" Áº∫Â∞ëÂøÖË¶ÅÈÖçÁΩÆÔºàAPI Key Êàñ Base URLÔºâ`);
                            hasError = true;
                        }
                    }
                }

                if (hasError) {
                    return;
                }

                // ‰øùÂ≠òÂ§ñÈÉ®ÊúçÂä°ÈÖçÁΩÆ
                const firecrawlKey = document.getElementById('firecrawl-api-key').value;
                fetch('/api/settings/external_services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firecrawl_api_key: firecrawlKey })
                }).catch(err => console.error('‰øùÂ≠òÂ§ñÈÉ®ÊúçÂä°ÈÖçÁΩÆÂ§±Ë¥•:', err));

                fetch('/api/models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ models: models })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog('success', 'Ê®°ÂûãÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü');
                        settingsModal.classList.remove('active');
                    } else {
                        addLog('error', `‰øùÂ≠òÂ§±Ë¥•: ${data.error}`);
                    }
                })
                .catch(error => {
                    addLog('error', `‰øùÂ≠òÂ§±Ë¥•: ${error.message}`);
                });
            });

            // Âä†ËΩΩÂ§ñÈÉ®ÊúçÂä°ÈÖçÁΩÆ
            loadExternalServices();

            settingsInitialized = true;
            return true;
        }

        // Âä†ËΩΩÂ§ñÈÉ®ÊúçÂä°ÈÖçÁΩÆ
        function loadExternalServices() {
            fetch('/api/settings/external_services')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.firecrawl_api_key) {
                            const input = document.getElementById('firecrawl-api-key');
                            if (input) input.value = data.firecrawl_api_key;
                        }
                    }
                })
                .catch(error => console.error('Âä†ËΩΩÂ§ñÈÉ®ÊúçÂä°ÈÖçÁΩÆÂ§±Ë¥•:', error));
        }

        // Êõ¥Êñ∞Ê®°ÂûãÈÖçÁΩÆ
        window.updateModel = function(index, field, value) {
            if (models[index]) {
                models[index][field] = value;
            }
        };

        // ÂàáÊç¢Ê®°ÂûãÊäòÂè†/Â±ïÂºÄ
        window.toggleModelCollapse = function(index) {
            if (models[index]) {
                models[index].collapsed = !models[index].collapsed;
                if (window.renderModels) window.renderModels();
            }
        };

        // ËÆæÁΩÆÈªòËÆ§Ê®°Âûã
        window.setDefaultModel = function(index) {
            // Ê∏ÖÈô§ÊâÄÊúâÊ®°ÂûãÁöÑÈªòËÆ§Ê†áËÆ∞
            models.forEach((model, i) => {
                model.is_default = (i === index);
            });
            // ÈáçÊñ∞Ê∏≤Êüì‰ª•Êõ¥Êñ∞ÂçïÈÄâÊåâÈíÆÁä∂ÊÄÅ
            if (window.renderModels) window.renderModels();
        };

        // ÂàáÊç¢Ê®°ÂûãÂêØÁî®Áä∂ÊÄÅ
        window.toggleModelEnabled = function(index, enabled) {
            if (models[index]) {
                models[index].enabled = enabled;
            }
        };

        // Êõ¥Êñ∞Ê®°ÂûãÁ±ªÂûãÔºàÈúÄË¶ÅÈáçÊñ∞Ê∏≤ÊüìÔºâ
        window.updateModelType = function(index, type) {
            if (models[index]) {
                models[index].type = type;
                // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÈªòËÆ§ÂÄº
                if (type === 'local') {
                    if (!models[index].base_url) models[index].base_url = 'http://localhost:11434';
                    if (!models[index].model_name) models[index].model_name = 'qwen2.5:32b';
                    models[index].api_key = '';
                } else {
                    if (!models[index].api_key) models[index].api_key = '';
                    if (!models[index].base_url && !models[index].api_base) {
                        models[index].base_url = '';
                    }
                }
                if (window.renderModels) window.renderModels();
            }
        };

        // Âà†Èô§Ê®°Âûã
        window.deleteModel = function(index) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê®°ÂûãÈÖçÁΩÆÂêóÔºü')) {
                models.splice(index, 1);
                if (window.renderModels) window.renderModels();
            }
        };

        // ÊµãËØïÊ®°Âûã
        window.testModel = function(index) {
            const model = models[index];
            if (!model) return;

            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = 'ÊµãËØï‰∏≠...';
            
            // ÁßªÈô§‰πãÂâçÁöÑÊµãËØïÁä∂ÊÄÅ
            const statusEl = testBtn.parentElement.querySelector('.test-status');
            if (statusEl) {
                statusEl.remove();
            }

            fetch('/api/models/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ model: model })
            })
            .then(response => response.json())
            .then(data => {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
                
                const statusEl = document.createElement('span');
                statusEl.className = 'test-status ' + (data.success ? 'success' : 'error');
                statusEl.textContent = data.success ? '‚úì ËøûÊé•ÊàêÂäü' : '‚úó ' + (data.error || 'ËøûÊé•Â§±Ë¥•');
                testBtn.parentElement.appendChild(statusEl);
                
                // 3ÁßíÂêéÁßªÈô§Áä∂ÊÄÅÊèêÁ§∫
                setTimeout(() => {
                    if (statusEl.parentElement) {
                        statusEl.remove();
                    }
                }, 3000);
            })
            .catch(error => {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
                
                const statusEl = document.createElement('span');
                statusEl.className = 'test-status error';
                statusEl.textContent = '‚úó ÊµãËØïÂ§±Ë¥•: ' + error.message;
                testBtn.parentElement.appendChild(statusEl);
                
                setTimeout(() => {
                    if (statusEl.parentElement) {
                        statusEl.remove();
                    }
                }, 3000);
            });
        };

        // Âú®DOMÂä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        function tryInitSettings() {
            const result = initSettingsModal();
            if (!result) {
                setTimeout(tryInitSettings, 1000);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryInitSettings);
        } else {
            // DOMÂ∑≤ÁªèÂä†ËΩΩÂÆåÊàê
            tryInitSettings();
        }
    </script>

    <!-- ÈÇÆÁÆ±ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div class="email-settings-modal" id="email-settings-modal">
        <div class="email-settings-content">
            <div class="email-settings-header">
                <h3>‚öôÔ∏è ÈÇÆÁÆ±ËÆæÁΩÆ</h3>
                <button class="email-settings-close" id="email-settings-close">‚úï</button>
            </div>
            <div class="email-settings-body">
                <div class="email-settings-form">
                    <div class="form-group">
                        <label for="email-config-user">ÈÇÆÁÆ±Ë¥¶Âè∑</label>
                        <input type="text" id="email-config-user" class="input-field" placeholder="your_email@qq.com">
                    </div>
                    <div class="form-group">
                        <label for="email-config-password">ÊéàÊùÉÁ†Å/ÂØÜÁ†Å</label>
                        <input type="password" id="email-config-password" class="input-field" placeholder="ËØ∑ËæìÂÖ•IMAPÊéàÊùÉÁ†Å">
                    </div>
                    <div class="form-group">
                        <label for="email-config-imap-server">IMAPÊúçÂä°Âô®</label>
                        <input type="text" id="email-config-imap-server" class="input-field" placeholder="imap.qq.com" value="imap.qq.com">
                    </div>
                    <div class="form-group">
                        <label for="email-config-imap-port">IMAPÁ´ØÂè£</label>
                        <input type="number" id="email-config-imap-port" class="input-field" placeholder="993" value="993">
                    </div>
                    <div class="form-hint">
                        <p>üí° ÊèêÁ§∫Ôºö</p>
                        <ul>
                            <li>QQÈÇÆÁÆ±ÈúÄË¶ÅÂú®"ËÆæÁΩÆ-Ë¥¶Êà∑"‰∏≠ÂºÄÂêØIMAPÊúçÂä°Âπ∂Ëé∑ÂèñÊéàÊùÉÁ†Å</li>
                            <li>ÂÖ∂‰ªñÈÇÆÁÆ±ËØ∑ÂèÇËÄÉÂØπÂ∫îÈÇÆÁÆ±ÊúçÂä°ÂïÜÁöÑIMAPÈÖçÁΩÆËØ¥Êòé</li>
                            <li>ÈÖçÁΩÆ‰ø°ÊÅØÂ∞Ü‰øùÂ≠òÂú®Êú¨Âú∞Ôºå‰∏ç‰ºö‰∏ä‰º†Âà∞ÊúçÂä°Âô®</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="email-settings-footer">
                <button class="btn-test" id="btn-test-email">ÊµãËØïËøûÊé•</button>
                <button class="btn-save" id="btn-save-email-config">‰øùÂ≠òÈÖçÁΩÆ</button>
            </div>
        </div>
    </div>

    <!-- ÈÇÆ‰ª∂‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü -->
    <!-- Á¨îËÆ∞ÂØºÂÖ•Ê®°ÊÄÅÊ°Ü -->
    <div class="email-modal" id="note-modal">
        <div class="email-content">
            <div class="email-header">
                <h3>üìì Á¨îËÆ∞Á≥ªÁªü</h3>
                <button class="email-close" onclick="closeNoteModal()">‚úï</button>
            </div>
            <div class="email-body">
                <div class="note-flow-container">
                    <!-- Á¨¨‰∏ÄË°åÔºöÂæÖÂ§ÑÁêÜ -> Â∑≤ÂØºÂÖ• -> Â∑≤ÂêåÊ≠• -->
                    <div class="note-flow-row">
                        <div class="note-flow-step">
                            <span class="note-flow-label">ÂæÖÂ§ÑÁêÜ</span>
                            <span id="note-pending-count" class="note-flow-count">0</span>
                        </div>
                        <div class="note-flow-arrow">‚Üí</div>
                        <div class="note-flow-step">
                            <span class="note-flow-label">Â∑≤ÂØºÂÖ•</span>
                            <span id="note-processed-count" class="note-flow-count">0</span>
                        </div>
                        <div class="note-flow-arrow">‚Üí</div>
                        <div class="note-flow-step">
                            <span class="note-flow-label">Â∑≤ÂêåÊ≠•</span>
                            <span id="note-synchronized-count" class="note-flow-count">0</span>
                        </div>
                    </div>
                    <!-- Á¨¨‰∫åË°åÔºöÂºÄÂÖ≥ -->
                    <div class="note-flow-row" style="margin-top: 5px;">
                        <div style="width: 100px;"></div> <!-- ÂØπÈΩêÂæÖÂ§ÑÁêÜ -->
                        <div class="note-flow-switch-container">
                            <label class="agent-import-toggle" style="margin: 0;" title="ÂºÄÂêØÂêéÔºåÁ≥ªÁªü‰ºöËá™Âä®Â§ÑÁêÜÁ¨îËÆ∞Âπ∂ÂØºÂÖ•Êï∞ÊçÆÂ∫ì">
                                <input type="checkbox" id="note-agent-import-switch" onchange="toggleNoteAgentImport()">
                                <span class="toggle-label">Agent ÂØºÂÖ•</span>
                            </label>
                            <span class="note-flow-switch-label">Ëá™Âä®Ëß£ÊûêÂØºÂÖ•</span>
                        </div>
                        <div style="width: 100px;"></div> <!-- ÂØπÈΩêÂ∑≤ÂØºÂÖ• -->
                        <div class="note-flow-switch-container">
                            <label class="agent-import-toggle" style="margin: 0;" title="ÂºÄÂêØÂêéÔºåÂ§ßËÑë‰ºöËá™Âä®ÈÄêÁØáÂê∏Êî∂Â∑≤Â§ÑÁêÜÁöÑÁ¨îËÆ∞Âà∞ËÆ§Áü•ËæπÁïå">
                                <input type="checkbox" id="brain-sync-switch" onchange="toggleBrainSync()">
                                <span class="toggle-label">Áü•ËØÜÂêåÊ≠•</span>
                            </label>
                            <span class="note-flow-switch-label">ËÆ§Áü•ÂõæË∞±Êï¥Âêà</span>
                        </div>
                        <div style="width: 100px;"></div> <!-- ÂØπÈΩêÂ∑≤ÂêåÊ≠• -->
                    </div>
                </div>

                <div class="email-summary" id="note-stats" style="margin-top: 0; padding: 10px; background: none; border: none; justify-content: flex-end;">
                    <div class="email-summary-item" style="margin: 0;">
                        <span class="email-summary-label">Êñá‰ª∂ÊÄªÊï∞:</span>
                        <span id="note-total-count" style="color: rgba(255,255,255,0.6);">0</span>
                    </div>
                </div>

                <div class="email-list" id="note-list-container">
                    <!-- Á¨îËÆ∞ÂàóË°®Â∞ÜÂú®Ê≠§Â§Ñ‰ª•Âç°ÁâáÂΩ¢ÂºèÂä®ÊÄÅÁîüÊàê -->
                    <div style="text-align: center; padding: 40px 20px; color: rgba(255, 255, 255, 0.5);">
                        Ê≠£Âú®Êâ´ÊèèÁ¨îËÆ∞Êñá‰ª∂...
                    </div>
                </div>
            </div>
            
            <div class="email-footer">
                <div class="email-footer-buttons">
                    <button class="btn-settings" id="note-settings-btn" onclick="toggleNoteSettings()" title="ËÆæÁΩÆÁ¨îËÆ∞Ë∑ØÂæÑ">‚öôÔ∏è</button>
                    <button class="btn-update" onclick="refreshNoteFileList()">Âà∑Êñ∞ÂàóË°®</button>
                </div>
            </div>

            <!-- Á¨îËÆ∞Ë∑ØÂæÑËÆæÁΩÆÊµÆÂ±Ç -->
            <div id="note-settings-panel" style="display: none; position: absolute; bottom: 70px; left: 20px; right: 20px; padding: 20px; background: var(--dark-panel); border: 2px solid var(--neon-cyan); border-radius: 12px; z-index: 1001; box-shadow: 0 0 30px rgba(0, 217, 255, 0.3);">
                <div class="option-group">
                    <label style="color: var(--neon-cyan); font-size: 14px; margin-bottom: 12px; display: block; font-family: 'Rajdhani', sans-serif; font-weight: 600; text-transform: uppercase;">Á¨îËÆ∞Â≠òÊîæË∑ØÂæÑ</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="input-field" id="note-path-input" readonly placeholder="ÁÇπÂáªÂè≥‰æßÊåâÈíÆÈÄâÊã©Êñá‰ª∂Â§π..." style="background: rgba(0, 0, 0, 0.3); border-color: rgba(0, 217, 255, 0.3); flex: 1;">
                        <button class="btn-update" style="width: auto; height: 38px; min-width: 80px;" onclick="selectNoteFolder()">ÊµèËßà...</button>
                        <button class="btn-update" style="width: auto; height: 38px; min-width: 100px; background: rgba(0, 255, 100, 0.2); border-color: var(--neon-green); color: var(--neon-green);" onclick="saveNoteSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
                    </div>
                    <small style="color: rgba(255, 255, 255, 0.5); margin-top: 10px; display: block;">ËÆæÁΩÆÂêéÁ≥ªÁªüÂ∞ÜËá™Âä®Êâ´ÊèèËØ•Êñá‰ª∂Â§π‰∏ãÁöÑÊâÄÊúâÊîØÊåÅÊ†ºÂºèÁöÑÁ¨îËÆ∞Êñá‰ª∂</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÇÆÁÆ±Á≥ªÁªüÊ®°ÊÄÅÊ°Ü -->
    <div class="email-modal" id="email-modal">
        <div class="email-content">
            <div class="email-header">
                <h3>üìß ÈÇÆÁÆ±Á≥ªÁªü</h3>
                <button class="email-close" id="email-close">‚úï</button>
            </div>
            <div class="email-body">
                <div class="email-summary" id="email-summary">
                    <div class="email-summary-item">
                        <span class="email-summary-label">ÊúÄÂêéÊõ¥Êñ∞:</span>
                        <span id="email-last-update">-</span>
                    </div>
                    <div class="email-summary-item">
                        <span class="email-summary-label">ÈÇÆ‰ª∂ÊÄªÊï∞:</span>
                        <span id="email-total">0</span>
                    </div>
                    <div class="email-summary-item">
                        <span class="email-summary-label">ËÆ∫ÊñáÊÄªÊï∞:</span>
                        <span id="email-papers-total">0</span>
                    </div>
                </div>
                <div class="email-list" id="email-list">
                    <!-- ÈÇÆ‰ª∂ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="email-footer">
                <div class="email-pagination" id="email-pagination" style="display: none;">
                    <button class="pagination-btn" id="pagination-prev">‰∏ä‰∏ÄÈ°µ</button>
                    <span class="pagination-info" id="pagination-info">Á¨¨ 1 È°µÔºåÂÖ± 1 È°µ</span>
                    <button class="pagination-btn" id="pagination-next">‰∏ã‰∏ÄÈ°µ</button>
                </div>
                <div class="email-footer-buttons">
                    <button class="btn-settings" id="btn-email-settings" title="ÈÇÆÁÆ±ËÆæÁΩÆ">‚öôÔ∏è</button>
                    <label class="agent-import-toggle" title="ÂºÄÂêØÂêéÔºåÁ≥ªÁªü‰ºöÂú®Á©∫Èó≤Êó∂Ëá™Âä®Â§ÑÁêÜÂæÖÂ§ÑÁêÜÁöÑÊñáÁ´†">
                        <input type="checkbox" id="agent-import-switch">
                        <span class="toggle-label">AgentÂØºÂÖ•</span>
                    </label>
                    <button class="btn-update" id="btn-update-emails">Êõ¥Êñ∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÈÇÆ‰ª∂‰ø°ÊÅØÊ®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥‰ª£Á†Å
        let emailModal, emailClose, btnUpdateEmails, emailList, emailLastUpdate, emailTotal, emailPapersTotal;
        let allEmails = [];  // Â≠òÂÇ®ÊâÄÊúâÈÇÆ‰ª∂
        let currentPage = 1;
        const emailsPerPage = 10;  // ÊØèÈ°µÊòæÁ§∫10Â∞ÅÈÇÆ‰ª∂

        function loadEmailInfo() {
            fetch('/api/emails/all')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const emailData = data.data;
                        emailLastUpdate.textContent = emailData.last_update || '‰ªéÊú™Êõ¥Êñ∞';
                        emailTotal.textContent = emailData.total_emails || 0;
                        emailPapersTotal.textContent = emailData.total_papers || 0;
                        
                        // ‰øùÂ≠òÊâÄÊúâÈÇÆ‰ª∂
                        allEmails = emailData.emails || [];
                        currentPage = 1;
                        
                        // Ê∏≤ÊüìÈÇÆ‰ª∂ÂàóË°®ÂíåÂàÜÈ°µ
                        renderEmailList();
                        updatePagination();
                    } else {
                        console.error('Ëé∑ÂèñÈÇÆ‰ª∂‰ø°ÊÅØÂ§±Ë¥•:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Ëé∑ÂèñÈÇÆ‰ª∂‰ø°ÊÅØÂá∫Èîô:', error);
                });
        }

        function renderEmailList() {
            emailList.innerHTML = '';
            
            if (allEmails.length === 0) {
                emailList.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 40px 20px;">ÊöÇÊó†ÈÇÆ‰ª∂</div>';
                return;
            }
            
            // ËÆ°ÁÆóÂΩìÂâçÈ°µÁöÑÈÇÆ‰ª∂ËåÉÂõ¥
            const startIndex = (currentPage - 1) * emailsPerPage;
            const endIndex = startIndex + emailsPerPage;
            const currentPageEmails = allEmails.slice(startIndex, endIndex);
            
            currentPageEmails.forEach(email => {
                const emailItem = document.createElement('div');
                emailItem.className = 'email-item';
                
                const papersHtml = email.papers && email.papers.length > 0
                    ? email.papers.map(paper => {
                        const title = paper.title || 'Êó†Ê†áÈ¢ò';
                        const link = paper.link || '#';
                        const status = paper.processing_status || 'pending';
                        const statusText = {
                            'pending': 'ÂæÖÂ§ÑÁêÜ',
                            'processing': 'Â§ÑÁêÜ‰∏≠',
                            'processed': 'Â∑≤Â§ÑÁêÜ'
                        }[status] || 'ÂæÖÂ§ÑÁêÜ';
                        const statusClass = `status-${status}`;
                        return `
                        <div class="email-paper-item ${statusClass}">
                            <span class="email-paper-status-badge ${status}">${statusText}</span>
                            ${link && link !== '#' ? `<a href="${link}" target="_blank" class="email-paper-title-link">${title}</a>` : `<div class="email-paper-title">${title}</div>`}
                        </div>
                    `;
                    }).join('')
                    : '<div style="color: rgba(255, 255, 255, 0.5); font-size: 12px;">Êó†ËÆ∫Êñá‰ø°ÊÅØ</div>';
                
                emailItem.innerHTML = `
                    <div class="email-item-header">
                        <div class="email-item-subject">${email.subject || 'Êó†‰∏ªÈ¢ò'}</div>
                        <div class="email-item-date">${email.date || '-'}</div>
                    </div>
                    <div class="email-item-papers">
                        <div class="email-item-papers-title">ËÆ∫Êñá (${email.paper_count || 0}):</div>
                        ${papersHtml}
                    </div>
                `;
                
                emailList.appendChild(emailItem);
            });
        }

        function updatePagination() {
            const pagination = document.getElementById('email-pagination');
            const paginationInfo = document.getElementById('pagination-info');
            const paginationPrev = document.getElementById('pagination-prev');
            const paginationNext = document.getElementById('pagination-next');
            
            if (!pagination || !paginationInfo || !paginationPrev || !paginationNext) {
                return;
            }
            
            const totalPages = Math.ceil(allEmails.length / emailsPerPage);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            paginationInfo.textContent = `Á¨¨ ${currentPage} È°µÔºåÂÖ± ${totalPages} È°µ`;
            
            paginationPrev.disabled = currentPage === 1;
            paginationNext.disabled = currentPage === totalPages;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(allEmails.length / emailsPerPage);
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            renderEmailList();
            updatePagination();
            // ÊªöÂä®Âà∞È°∂ÈÉ®
            const emailBody = document.querySelector('.email-body');
            if (emailBody) {
                emailBody.scrollTop = 0;
            }
        }

        function updateEmails() {
            btnUpdateEmails.disabled = true;
            btnUpdateEmails.textContent = 'Êõ¥Êñ∞‰∏≠...';
            
            fetch('/api/emails/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    start_days: 7,
                    end_days: 0
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadEmailInfo();
                        alert(`Êõ¥Êñ∞ÊàêÂäüÔºÅÂÖ±Êõ¥Êñ∞ ${data.updated_count || 0} Â∞ÅÈÇÆ‰ª∂`);
                    } else {
                        alert('Êõ¥Êñ∞Â§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
                    }
                })
                .catch(error => {
                    console.error('Êõ¥Êñ∞ÈÇÆ‰ª∂Âá∫Èîô:', error);
                    alert('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
                })
                .finally(() => {
                    btnUpdateEmails.disabled = false;
                    btnUpdateEmails.textContent = 'Êõ¥Êñ∞';
                });
        }

        // --- Á¨îËÆ∞Á≥ªÁªüÈÄªËæë ---
        let noteModal = null;
        let noteFiles = [];

        function initNoteModal() {
            noteModal = document.getElementById('note-modal');
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
            window.addEventListener('click', (event) => {
                if (event.target === noteModal) {
                    closeNoteModal();
                }
            });

            // ÁõëÂê¨ Socket.IO Ê∂àÊÅØÊõ¥Êñ∞Êñá‰ª∂Áä∂ÊÄÅ
            if (socket) {
                socket.on('message', (data) => {
                    if (data.type === 'note_file_updated') {
                        updateNoteFileUIStatus(data.file_id, data.status);
                    }
                });
            }
        }

        window.openNoteModal = function() {
            if (!noteModal) initNoteModal();
            noteModal.classList.add('active');
            loadNoteSettings();
            refreshNoteFileList();
        };

        window.closeNoteModal = function() {
            if (noteModal) noteModal.classList.remove('active');
        };

        window.toggleNoteSettings = function() {
            const panel = document.getElementById('note-settings-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        };

        window.selectNoteFolder = function() {
            addLog('info', 'ËØ∑Âú®ÂºπÂá∫ÁöÑÁ≥ªÁªüÂØπËØùÊ°Ü‰∏≠ÈÄâÊã©Á¨îËÆ∞Êñá‰ª∂Â§π...');
            fetch('/api/utils/select-folder')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.path) {
                        document.getElementById('note-path-input').value = data.path;
                        addLog('success', `Â∑≤ÈÄâÊã©Êñá‰ª∂Â§π: ${data.path}`);
                    } else if (data.message === 'ÂèñÊ∂àÈÄâÊã©') {
                        addLog('info', 'Â∑≤ÂèñÊ∂àÈÄâÊã©Êñá‰ª∂Â§π');
                    }
                })
                .catch(err => {
                    console.error('ÈÄâÊã©Êñá‰ª∂Â§πÂá∫Èîô:', err);
                    addLog('error', 'Êó†Ê≥ïÊâìÂºÄÊñá‰ª∂Â§πÈÄâÊã©ÂØπËØùÊ°ÜÔºåËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°ËøêË°åÊ≠£Â∏∏');
                });
        };

        function loadNoteSettings() {
            fetch('/api/note/settings')
                .then(res => res.json())
                .then(data => {
                    if (data.note_path) {
                        document.getElementById('note-path-input').value = data.note_path;
                    } else {
                        document.getElementById('note-path-input').value = '';
                    }
                    document.getElementById('note-agent-import-switch').checked = !!data.agent_import_active;
                    const brainSyncSwitch = document.getElementById('brain-sync-switch');
                    if (brainSyncSwitch) {
                        brainSyncSwitch.checked = !!data.brain_sync_active;
                    }
                });
        }

        window.saveNoteSettings = function() {
            const path = document.getElementById('note-path-input').value.trim();
            if (!path) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑË∑ØÂæÑ');
                return;
            }

            fetch('/api/note/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note_path: path })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    addLog('success', 'Á¨îËÆ∞Ë∑ØÂæÑËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
                    toggleNoteSettings();
                    refreshNoteFileList();
                } else {
                    alert('‰øùÂ≠òÂ§±Ë¥•: ' + data.error);
                }
            });
        };

        function refreshNoteFileList() {
            const container = document.getElementById('note-list-container');
            if (!container) return;
            container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: rgba(255, 255, 255, 0.5);">Ê≠£Âú®Êâ´Êèè...</div>';

            fetch('/api/note/files')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        noteFiles = data.files;
                        renderNoteFileList();
                    } else {
                        container.innerHTML = `<div style="text-align: center; padding: 40px 20px; color: var(--neon-red);">${data.error}</div>`;
                    }
                });
        }

        function renderNoteFileList() {
            const container = document.getElementById('note-list-container');
            if (!container) return;
            if (noteFiles.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: rgba(255, 255, 255, 0.5);">Êñá‰ª∂Â§π‰∏∫Á©∫ÊàñÊú™ÂåÖÂê´ÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã</div>';
                return;
            }

            container.innerHTML = '';
            let pending = 0;
            let processed = 0;
            let synchronized = 0;

            noteFiles.forEach(file => {
                if (file.status === 'synchronized') synchronized++;
                else if (file.status === 'processed') processed++;
                else pending++;

                const statusText = file.status === 'synchronized' ? 'Â∑≤ÂêåÊ≠•' : (file.status === 'processed' ? 'Â∑≤ÂØºÂÖ•' : 'ÂæÖÂ§ÑÁêÜ');
                
                const statusClass = `status-${file.status}`;

                const itemDiv = document.createElement('div');
                itemDiv.className = `email-item note-item`;
                itemDiv.id = `note-file-${file.id.replace(/\//g, '_').replace(/\./g, '_')}`;
                
                itemDiv.innerHTML = `
                    <div class="email-item-header">
                        <div class="email-item-subject" title="${file.path}">${file.name}</div>
                        <div class="email-item-date">${file.mod_time}</div>
                    </div>
                    <div class="email-item-papers" style="border-top: none; margin-top: 5px; padding-top: 0;">
                        <div class="email-paper-item ${statusClass}">
                            <span class="email-paper-status-badge ${file.status}">${statusText}</span>
                            <div class="email-paper-title" style="color: rgba(255,255,255,0.7); font-size: 12px;">
                                Á±ªÂûã: ${file.type.toUpperCase()} | Ë∑ØÂæÑ: ${file.rel_path}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            const totalEl = document.getElementById('note-total-count');
            const pendingEl = document.getElementById('note-pending-count');
            const processedEl = document.getElementById('note-processed-count');
            const synchronizedEl = document.getElementById('note-synchronized-count');
            
            if (totalEl) totalEl.textContent = noteFiles.length;
            if (pendingEl) pendingEl.textContent = pending;
            if (processedEl) processedEl.textContent = processed;
            if (synchronizedEl) synchronizedEl.textContent = synchronized;
        }

        function updateNoteFileUIStatus(fileId, status) {
            const elementId = `note-file-${fileId.replace(/\//g, '_').replace(/\./g, '_')}`;
            const item = document.getElementById(elementId);
            if (item) {
                const paperItem = item.querySelector('.email-paper-item');
                const badge = item.querySelector('.email-paper-status-badge');
                
                if (paperItem) {
                    paperItem.className = `email-paper-item status-${status}`;
                }
                if (badge) {
                    badge.className = `email-paper-status-badge ${status}`;
                    let statusText = 'ÂæÖÂ§ÑÁêÜ';
                    if (status === 'synchronized') statusText = 'Â∑≤ÂêåÊ≠•';
                    else if (status === 'processed') statusText = 'Â∑≤ÂØºÂÖ•';
                    badge.textContent = statusText;
                }
                
                // Êõ¥Êñ∞ÁªüËÆ°
                const pendingEl = document.getElementById('note-pending-count');
                const processedEl = document.getElementById('note-processed-count');
                const synchronizedEl = document.getElementById('note-synchronized-count');
                
                if (pendingEl && processedEl && synchronizedEl) {
                    // Áî±‰∫éÂÆûÊó∂Êõ¥Êñ∞ÊØîËæÉÂ§çÊùÇÔºåÂª∫ËÆÆÁõ¥Êé•Ê†πÊçÆÂΩìÂâçÂàóË°®ÈáçÊñ∞ËÆ°ÁÆóÁªüËÆ°ÔºåÊàñËÄÖÈÄöËøáÂÅèÁßªËÆ°ÁÆó
                    // ËøôÈáåÊàë‰ª¨ÈááÁî®ÁÆÄÂçïÈÄªËæëÔºöÂè™Â§ÑÁêÜ processed Âíå synchronized ÁöÑÂ¢ûÂä†
                    if (status === 'processed') {
                        processedEl.textContent = parseInt(processedEl.textContent) + 1;
                        pendingEl.textContent = Math.max(0, parseInt(pendingEl.textContent) - 1);
                    } else if (status === 'synchronized') {
                        synchronizedEl.textContent = parseInt(synchronizedEl.textContent) + 1;
                        processedEl.textContent = Math.max(0, parseInt(processedEl.textContent) - 1);
                    } else if (status === 'unprocessed') {
                        // Â¶ÇÊûúÂõûÊªöÂà∞Êú™Â§ÑÁêÜÔºåÈáçÁΩÆÁõ∏ÂÖ≥ËÆ°Êï∞ÔºàËøôÊòØ‰∏Ä‰∏™ÁÆÄÂåñÂ§ÑÁêÜÔºâ
                        pendingEl.textContent = parseInt(pendingEl.textContent) + 1;
                    }
                }
            }
        }

        window.toggleNoteAgentImport = function() {
            const isChecked = document.getElementById('note-agent-import-switch').checked;
            
            fetch('/api/note/agent-import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ active: isChecked })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    addLog('info', isChecked ? 'Á¨îËÆ∞ Agent Ëá™Âä®ÂØºÂÖ•Â∑≤ÂºÄÂêØ' : 'Á¨îËÆ∞ Agent Ëá™Âä®ÂØºÂÖ•Â∑≤ÂÅúÊ≠¢');
                    // ‰øùÂ≠òÂºÄÂÖ≥Áä∂ÊÄÅ
                    fetch('/api/note/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ agent_import_active: isChecked })
                    });
                } else {
                    alert('Êìç‰ΩúÂ§±Ë¥•: ' + data.error);
                    document.getElementById('note-agent-import-switch').checked = !isChecked;
                }
            });
        };

        window.toggleBrainSync = function() {
            const isChecked = document.getElementById('brain-sync-switch').checked;
            
            fetch('/api/note/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brain_sync_active: isChecked })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    addLog('info', isChecked ? 'Â§ßËÑëÂêéÂè∞ÂêåÊ≠•Â∑≤ÂºÄÂêØ' : 'Â§ßËÑëÂêéÂè∞ÂêåÊ≠•Â∑≤ÂÅúÊ≠¢');
                } else {
                    alert('Êìç‰ΩúÂ§±Ë¥•: ' + data.error);
                    document.getElementById('brain-sync-switch').checked = !isChecked;
                }
            });
        };

        // ÁßªÈô§ÊóßÁöÑ triggerBrainSync ÂáΩÊï∞

        // ÂàùÂßãÂåñÈÇÆ‰ª∂Ê®°ÊÄÅÊ°Ü
        function initEmailModal() {
            emailModal = document.getElementById('email-modal');
            emailClose = document.getElementById('email-close');
            btnUpdateEmails = document.getElementById('btn-update-emails');
            emailList = document.getElementById('email-list');
            emailLastUpdate = document.getElementById('email-last-update');
            emailTotal = document.getElementById('email-total');
            emailPapersTotal = document.getElementById('email-papers-total');
            
            const paginationPrev = document.getElementById('pagination-prev');
            const paginationNext = document.getElementById('pagination-next');
            const agentImportSwitch = document.getElementById('agent-import-switch');
            
            // email-btnÁöÑÁÇπÂáª‰∫ã‰ª∂Â∑≤Âú®openEmailModalÂáΩÊï∞‰∏≠Â§ÑÁêÜÔºàÈÄöËøáonclickÂ±ûÊÄßÔºâ
            
            if (emailClose) {
                emailClose.addEventListener('click', () => {
                    emailModal.classList.remove('active');
                });
            }
            
            if (btnUpdateEmails) {
                btnUpdateEmails.addEventListener('click', updateEmails);
            }
            
            if (paginationPrev) {
                paginationPrev.addEventListener('click', () => {
                    goToPage(currentPage - 1);
                });
            }
            
            if (paginationNext) {
                paginationNext.addEventListener('click', () => {
                    goToPage(currentPage + 1);
                });
            }
            
            // AgentÂØºÂÖ•ÂºÄÂÖ≥
            if (agentImportSwitch) {
                // Âä†ËΩΩÂºÄÂÖ≥Áä∂ÊÄÅ
                fetch('/api/email/agent-import-status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success !== undefined) {
                            agentImportSwitch.checked = data.enabled || false;
                        }
                    })
                    .catch(error => {
                        console.error('Âä†ËΩΩAgentÂØºÂÖ•Áä∂ÊÄÅÂ§±Ë¥•:', error);
                    });
                
                agentImportSwitch.addEventListener('change', function() {
                    const enabled = this.checked;
                    fetch('/api/email/agent-import-status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ enabled: enabled })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addLog(enabled ? 'info' : 'info', enabled ? 'AgentÂØºÂÖ•Â∑≤ÂºÄÂêØ' : 'AgentÂØºÂÖ•Â∑≤ÂÖ≥Èó≠');
                            // Â¶ÇÊûúÂºÄÂêØÔºåÂà∑Êñ∞ÂæÖÂ§ÑÁêÜÊñáÁ´†ÂàóË°®
                            if (enabled) {
                                loadPendingPapers();
                            }
                        } else {
                            addLog('error', 'Êõ¥Êñ∞AgentÂØºÂÖ•Áä∂ÊÄÅÂ§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
                            // ÊÅ¢Â§çÂºÄÂÖ≥Áä∂ÊÄÅ
                            this.checked = !enabled;
                        }
                    })
                    .catch(error => {
                        console.error('Êõ¥Êñ∞AgentÂØºÂÖ•Áä∂ÊÄÅÂ§±Ë¥•:', error);
                        addLog('error', 'Êõ¥Êñ∞AgentÂØºÂÖ•Áä∂ÊÄÅÂ§±Ë¥•: ' + error.message);
                        // ÊÅ¢Â§çÂºÄÂÖ≥Áä∂ÊÄÅ
                        this.checked = !enabled;
                    });
                });
            }
            
            // ÂàùÂßãÂåñÈÇÆÁÆ±ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
            initEmailSettingsModal();
            
            // ÂàùÂßãÂåñÂæÖÂ§ÑÁêÜÊñáÁ´†ÂàóË°®
            initPaperProcessingList();
        }

        // ÂàùÂßãÂåñÈÇÆÁÆ±ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function initEmailSettingsModal() {
            emailSettingsModal = document.getElementById('email-settings-modal');
            emailSettingsClose = document.getElementById('email-settings-close');
            btnEmailSettings = document.getElementById('btn-email-settings');
            btnSaveEmailConfig = document.getElementById('btn-save-email-config');
            btnTestEmail = document.getElementById('btn-test-email');
            emailConfigUser = document.getElementById('email-config-user');
            emailConfigPassword = document.getElementById('email-config-password');
            emailConfigImapServer = document.getElementById('email-config-imap-server');
            emailConfigImapPort = document.getElementById('email-config-imap-port');
            
            // ÊâìÂºÄËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
            if (btnEmailSettings) {
                btnEmailSettings.addEventListener('click', () => {
                    loadEmailConfig();
                    emailSettingsModal.classList.add('active');
                });
            }
            
            // ÂÖ≥Èó≠ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
            if (emailSettingsClose) {
                emailSettingsClose.addEventListener('click', () => {
                    emailSettingsModal.classList.remove('active');
                });
            }
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            if (emailSettingsModal) {
                emailSettingsModal.addEventListener('click', (e) => {
                    if (e.target === emailSettingsModal) {
                        emailSettingsModal.classList.remove('active');
                    }
                });
            }
            
            // ‰øùÂ≠òÈÖçÁΩÆ
            if (btnSaveEmailConfig) {
                btnSaveEmailConfig.addEventListener('click', saveEmailConfig);
            }
            
            // ÊµãËØïËøûÊé•
            if (btnTestEmail) {
                btnTestEmail.addEventListener('click', testEmailConnection);
            }
            
            // ÂΩìÁî®Êà∑ÁÇπÂáªÂØÜÁ†ÅËæìÂÖ•Ê°ÜÊó∂ÔºåÂ¶ÇÊûúÊòØÂç†‰ΩçÁ¨¶ÔºåÊ∏ÖÁ©∫‰ª•‰æøËæìÂÖ•
            if (emailConfigPassword) {
                emailConfigPassword.addEventListener('focus', function() {
                    if (this.value === '********') {
                        this.value = '';
                        this.placeholder = 'ËØ∑ËæìÂÖ•IMAPÊéàÊùÉÁ†Å';
                    }
                });
            }
        }

        // Âä†ËΩΩÈÇÆÁÆ±ÈÖçÁΩÆ
        function loadEmailConfig() {
            fetch('/api/email/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.config) {
                        if (emailConfigUser) emailConfigUser.value = data.config.user || '';
                        // Â¶ÇÊûúÈÖçÁΩÆÂ≠òÂú®‰∏îÊúâÁî®Êà∑Ë¥¶Âè∑ÔºåËØ¥ÊòéÂ∑≤ÈÖçÁΩÆËøáÔºåÂØÜÁ†ÅÂ≠óÊÆµÊòæÁ§∫Âç†‰ΩçÁ¨¶
                        if (emailConfigPassword) {
                            if (data.config.user && data.config.user.trim() !== '') {
                                // Â∑≤ÈÖçÁΩÆËøáÔºåÊòæÁ§∫Âç†‰ΩçÁ¨¶
                                emailConfigPassword.value = '********';
                                emailConfigPassword.placeholder = '********';
                            } else {
                                // Êú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÂéüÂßãÂç†‰ΩçÁ¨¶
                                emailConfigPassword.value = '';
                                emailConfigPassword.placeholder = 'ËØ∑ËæìÂÖ•IMAPÊéàÊùÉÁ†Å';
                            }
                        }
                        if (emailConfigImapServer) emailConfigImapServer.value = data.config.imap_server || 'imap.qq.com';
                        if (emailConfigImapPort) emailConfigImapPort.value = data.config.imap_port || 993;
                    }
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÈÇÆÁÆ±ÈÖçÁΩÆÂ§±Ë¥•:', error);
                });
        }

        // ‰øùÂ≠òÈÇÆÁÆ±ÈÖçÁΩÆ
        function saveEmailConfig() {
            const config = {
                user: emailConfigUser ? emailConfigUser.value.trim() : '',
                password: emailConfigPassword ? emailConfigPassword.value.trim() : '',
                imap_server: emailConfigImapServer ? emailConfigImapServer.value.trim() : 'imap.qq.com',
                imap_port: emailConfigImapPort ? parseInt(emailConfigImapPort.value) : 993
            };
            
            // Â¶ÇÊûúÂØÜÁ†ÅÊòØÂç†‰ΩçÁ¨¶Êàñ‰∏∫Á©∫ÔºåÊèêÁ§∫Áî®Êà∑ËæìÂÖ•
            if (!config.password || config.password === '********') {
                addLog('error', 'ËØ∑Â°´ÂÜôÊéàÊùÉÁ†Å/ÂØÜÁ†Å');
                if (emailConfigPassword) {
                    emailConfigPassword.focus();
                }
                return;
            }
            
            if (!config.user) {
                addLog('error', 'ËØ∑Â°´ÂÜôÈÇÆÁÆ±Ë¥¶Âè∑');
                if (emailConfigUser) {
                    emailConfigUser.focus();
                }
                return;
            }
            
            btnSaveEmailConfig.disabled = true;
            btnSaveEmailConfig.textContent = '‰øùÂ≠ò‰∏≠...';
            
            fetch('/api/email/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                btnSaveEmailConfig.disabled = false;
                btnSaveEmailConfig.textContent = '‰øùÂ≠òÈÖçÁΩÆ';
                
                if (data.success) {
                    addLog('success', 'ÈÇÆÁÆ±ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò');
                    // ‰øùÂ≠òÊàêÂäüÂêéÔºåÂ∞ÜÂØÜÁ†ÅÂ≠óÊÆµËÆæÁΩÆ‰∏∫Âç†‰ΩçÁ¨¶
                    if (emailConfigPassword) {
                        emailConfigPassword.value = '********';
                        emailConfigPassword.placeholder = '********';
                    }
                    emailSettingsModal.classList.remove('active');
                } else {
                    addLog('error', `‰øùÂ≠òÂ§±Ë¥•: ${data.error}`);
                }
            })
            .catch(error => {
                btnSaveEmailConfig.disabled = false;
                btnSaveEmailConfig.textContent = '‰øùÂ≠òÈÖçÁΩÆ';
                addLog('error', `‰øùÂ≠òÂ§±Ë¥•: ${error.message}`);
            });
        }

        // ÊµãËØïÈÇÆÁÆ±ËøûÊé•
        function testEmailConnection() {
            const config = {
                user: emailConfigUser ? emailConfigUser.value.trim() : '',
                password: emailConfigPassword ? emailConfigPassword.value.trim() : '',
                imap_server: emailConfigImapServer ? emailConfigImapServer.value.trim() : 'imap.qq.com',
                imap_port: emailConfigImapPort ? parseInt(emailConfigImapPort.value) : 993
            };
            
            if (!config.user || !config.password) {
                addLog('error', 'ËØ∑Â°´ÂÜôÈÇÆÁÆ±Ë¥¶Âè∑ÂíåÊéàÊùÉÁ†Å');
                return;
            }
            
            btnTestEmail.disabled = true;
            btnTestEmail.textContent = 'ÊµãËØï‰∏≠...';
            
            fetch('/api/email/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                btnTestEmail.disabled = false;
                btnTestEmail.textContent = 'ÊµãËØïËøûÊé•';
                
                if (data.success) {
                    addLog('success', 'ÈÇÆÁÆ±ËøûÊé•ÊµãËØïÊàêÂäü');
                } else {
                    addLog('error', `ËøûÊé•ÊµãËØïÂ§±Ë¥•: ${data.error}`);
                }
            })
            .catch(error => {
                btnTestEmail.disabled = false;
                btnTestEmail.textContent = 'ÊµãËØïËøûÊé•';
                addLog('error', `ËøûÊé•ÊµãËØïÂ§±Ë¥•: ${error.message}`);
            });
        }

        // ÂæÖÂ§ÑÁêÜÊñáÁ´†ÂàóË°®Áõ∏ÂÖ≥‰ª£Á†Å
        let paperProcessingList;
        let pendingPapers = [];  // Â≠òÂÇ®ÂæÖÂ§ÑÁêÜÊñáÁ´†ÂàóË°®
        let processingPapers = new Set();  // Ê≠£Âú®Â§ÑÁêÜÁöÑÊñáÁ´†IDÈõÜÂêà
        
        function initPaperProcessingList() {
            paperProcessingList = document.getElementById('paper-processing-list');
            
            // ÂàùÂßãÂåñÊ†áÁ≠æÂàáÊç¢ÂäüËÉΩ
            initTaskQueueTabs();
            
            // ÁõëÂê¨Á†îÁ©∂ÊñπÂêëÂÖ≥ÈîÆËØçÂèòÂåñÔºåÂêåÊ≠•Âà∞ÂêéÁ´Ø
            const keywordsInput = document.getElementById('keywords');
            if (keywordsInput) {
                // È°µÈù¢Âä†ËΩΩÊó∂ÂêåÊ≠•‰∏ÄÊ¨°
                syncResearchKeywords();
                
                // ÁõëÂê¨ËæìÂÖ•ÂèòÂåñÔºà‰ΩøÁî®Èò≤ÊäñÔºåÈÅøÂÖçÈ¢ëÁπÅËØ∑Ê±ÇÔºâ
                let keywordsTimeout;
                keywordsInput.addEventListener('input', function() {
                    clearTimeout(keywordsTimeout);
                    keywordsTimeout = setTimeout(() => {
                        syncResearchKeywords();
                    }, 1000);  // 1ÁßíÂêéÂêåÊ≠•
                });
            }
            
            // ÂÆöÊúüÂà∑Êñ∞ÂæÖÂ§ÑÁêÜÊñáÁ´†ÂàóË°®
            loadPendingPapers();
            setInterval(loadPendingPapers, 5000);  // ÊØè5ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
        }

        // ÂàùÂßãÂåñ‰ªªÂä°ÈòüÂàóÊ†áÁ≠æÂàáÊç¢
        function initTaskQueueTabs() {
            const tabFiles = document.getElementById('tab-files');
            const tabPapers = document.getElementById('tab-papers');
            const panelFiles = document.getElementById('panel-files');
            const panelPapers = document.getElementById('panel-papers');
            const clearBtn = document.getElementById('clear-files-btn');
            
            if (!tabFiles || !tabPapers || !panelFiles || !panelPapers) return;
            
            // Êñá‰ª∂Ê†áÁ≠æÁÇπÂáª
            tabFiles.addEventListener('click', () => {
                switchTaskTab('files');
            });
            
            // ÊñáÁ´†Ê†áÁ≠æÁÇπÂáª
            tabPapers.addEventListener('click', () => {
                switchTaskTab('papers');
            });
        }

        // ÂàáÊç¢‰ªªÂä°ÈòüÂàóÊ†áÁ≠æ
        function switchTaskTab(tabName) {
            const tabFiles = document.getElementById('tab-files');
            const tabPapers = document.getElementById('tab-papers');
            const panelFiles = document.getElementById('panel-files');
            const panelPapers = document.getElementById('panel-papers');
            const clearBtn = document.getElementById('clear-files-btn');
            
            if (!tabFiles || !tabPapers || !panelFiles || !panelPapers) return;
            
            if (tabName === 'files') {
                tabFiles.classList.add('active');
                tabPapers.classList.remove('active');
                panelFiles.classList.add('active');
                panelPapers.classList.remove('active');
                if (clearBtn) {
                    clearBtn.style.display = fileStatusMap.size > 0 ? 'block' : 'none';
                }
            } else if (tabName === 'papers') {
                tabFiles.classList.remove('active');
                tabPapers.classList.add('active');
                panelFiles.classList.remove('active');
                panelPapers.classList.add('active');
                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
            }
        }
        
        function syncResearchKeywords() {
            const keywordsInput = document.getElementById('keywords');
            if (!keywordsInput) return;
            
            const keywords = keywordsInput.value.trim();
            if (keywords) {
                fetch('/api/settings/research-keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: keywords
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Á†îÁ©∂ÊñπÂêëÂÖ≥ÈîÆËØçÂ∑≤ÂêåÊ≠•Âà∞ÂêéÁ´Ø');
                    }
                })
                .catch(error => {
                    console.error('ÂêåÊ≠•Á†îÁ©∂ÊñπÂêëÂÖ≥ÈîÆËØçÂ§±Ë¥•:', error);
                });
            }
        }
        
        function loadPendingPapers() {
            fetch('/api/email/pending-papers')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const newPapers = data.papers || [];
                        // ËøáÊª§ÊéâÊ≠£Âú®Â§ÑÁêÜÁöÑÊñáÁ´†ÔºåÈÅøÂÖçÈáçÊñ∞Ê∑ªÂä†
                        const filteredPapers = newPapers.filter(paper => !processingPapers.has(paper.paper_id));
                        
                        // Ëé∑ÂèñÂΩìÂâçÂàóË°®‰∏≠ÁöÑÊñáÁ´†IDÈõÜÂêà
                        const currentPaperIds = new Set(pendingPapers.map(p => p.paper_id));
                        
                        // ÊâæÂá∫ÈúÄË¶ÅÁßªÈô§ÁöÑÊñáÁ´†ÔºàÂú®ÂΩìÂâçÂàóË°®‰∏≠‰ΩÜ‰∏çÂú®Êñ∞ÂàóË°®‰∏≠ÔºåËØ¥ÊòéÂ∑≤Â§ÑÁêÜÔºâ
                        const removedPapers = pendingPapers.filter(p => {
                            return !filteredPapers.find(np => np.paper_id === p.paper_id) && 
                                   !processingPapers.has(p.paper_id);
                        });
                        
                        // Â¶ÇÊûúÊúâÊñáÁ´†Ë¢´ÁßªÈô§ÔºàÁä∂ÊÄÅÂèò‰∏∫Â∑≤Â§ÑÁêÜÔºâÔºåËÆ∞ÂΩïÊó•Âøó
                        if (removedPapers.length > 0) {
                            removedPapers.forEach(paper => {
                                addLog('success', `ÊñáÁ´† "${paper.title_en || paper.title || 'Êú™Áü•'}" Â∑≤Â§ÑÁêÜÂÆåÊàê`);
                            });
                        }
                        
                        // ÂêàÂπ∂Áé∞ÊúâÂàóË°®ÂíåÊñ∞ÁöÑÂàóË°®ÔºåÂéªÈáç
                        const existingIds = new Set(pendingPapers.map(p => p.paper_id));
                        const newPapersToAdd = filteredPapers.filter(p => !existingIds.has(p.paper_id));
                        
                        // Êõ¥Êñ∞ÂàóË°®Ôºö‰øùÁïô‰ªçÂú®Â§ÑÁêÜ‰∏≠ÁöÑÊñáÁ´† + Êñ∞ÁöÑÊñáÁ´†
                        pendingPapers = [
                            ...pendingPapers.filter(p => processingPapers.has(p.paper_id)), // ‰øùÁïôÊ≠£Âú®Â§ÑÁêÜÁöÑÊñáÁ´†
                            ...filteredPapers.filter(p => !processingPapers.has(p.paper_id)) // Ê∑ªÂä†Êñ∞ÁöÑÊàñÊõ¥Êñ∞ÁöÑÊñáÁ´†
                        ];
                        
                        renderPendingPapers();
                    } else {
                        console.error('Ëé∑ÂèñÂæÖÂ§ÑÁêÜÊñáÁ´†Â§±Ë¥•:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Ëé∑ÂèñÂæÖÂ§ÑÁêÜÊñáÁ´†Âá∫Èîô:', error);
                });
        }
        
        function renderPendingPapers() {
            if (!paperProcessingList) return;
            
            const taskQueueSection = document.getElementById('task-queue-section');
            
            // Ê∏≤ÊüìÂàóË°®
            if (pendingPapers.length === 0) {
                paperProcessingList.innerHTML = '<div class="paper-processing-empty">ÊöÇÊó†ÂæÖÂ§ÑÁêÜÊñáÁ´†</div>';
                // Â¶ÇÊûú‰∏§‰∏™ÂàóË°®ÈÉΩ‰∏∫Á©∫ÔºåÈöêËóèÊï¥‰∏™Âå∫Âüü
                if (taskQueueSection && fileStatusMap.size === 0) {
                    taskQueueSection.style.display = 'none';
                }
                return;
            }

            // ÊòæÁ§∫‰ªªÂä°ÈòüÂàóÂå∫ÂüüÔºåÂπ∂ÂàáÊç¢Âà∞ÊñáÁ´†Ê†áÁ≠æ
            if (taskQueueSection) {
                taskQueueSection.style.display = 'flex';
                // Â¶ÇÊûúÊúâÊñ∞ÊñáÁ´†ÔºåÂàáÊç¢Âà∞ÊñáÁ´†Ê†áÁ≠æ
                switchTaskTab('papers');
            }
            
            let html = '';
            pendingPapers.forEach(paper => {
                const titleEn = paper.title_en || paper.title || 'Êú™Áü•Ê†áÈ¢ò';
                const titleCn = paper.title_cn || '';
                const titleBilingual = paper.title_bilingual || (titleCn ? `${titleEn} | ${titleCn}` : titleEn);
                const explanation = paper.relevance_explanation || '';
                const relevanceScore = paper.relevance_score || 0;
                const paperId = paper.paper_id || '';
                
                const isProcessing = processingPapers.has(paperId);
                
                html += `
                    <div class="paper-processing-item ${relevanceScore === 1 ? 'relevant' : ''}" data-paper-id="${paperId}">
                        <div class="paper-processing-item-title">${escapeHtml(titleEn)}</div>
                        ${titleCn ? `<div class="paper-processing-item-title-cn">${escapeHtml(titleCn)}</div>` : ''}
                        ${explanation ? `<div class="paper-processing-item-explanation">${escapeHtml(explanation)}</div>` : ''}
                        ${relevanceScore === 1 ? `
                            <div class="paper-processing-item-actions">
                                <button class="paper-action-btn interested ${isProcessing ? 'processing' : ''}" 
                                        ${isProcessing ? 'disabled' : ''} 
                                        onclick="handlePaperInterest('${paperId}', true)">
                                    ${isProcessing ? 'Â§ÑÁêÜ‰∏≠‚Ä¶' : 'ÊÑüÂÖ¥Ë∂£'}
                                </button>
                                <button class="paper-action-btn not-interested ${isProcessing ? 'disabled-gray' : ''}" 
                                        ${isProcessing ? 'disabled' : ''} 
                                        onclick="handlePaperInterest('${paperId}', false)">‰∏çÊÑüÂÖ¥Ë∂£</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            paperProcessingList.innerHTML = html;
        }
        
        function handlePaperInterest(paperId, interested) {
            // Ê£ÄÊü•ÊòØÂê¶Ê≠£Âú®Â§ÑÁêÜ‰∏≠
            if (processingPapers.has(paperId)) {
                addLog('warning', 'ËØ•ÊñáÁ´†Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂÄô...');
                return;
            }
            
            const paper = pendingPapers.find(p => p.paper_id === paperId);
            if (!paper) {
                addLog('error', 'Êú™ÊâæÂà∞ÊñáÁ´†‰ø°ÊÅØ');
                return;
            }
            
            // Ê†áËÆ∞‰∏∫Ê≠£Âú®Â§ÑÁêÜ
            processingPapers.add(paperId);
            
            // Ëé∑ÂèñËØ•ÊñáÁ´†ÁöÑÊâÄÊúâÊåâÈíÆ
            const itemElement = document.querySelector(`[data-paper-id="${paperId}"]`);
            if (!itemElement) {
                processingPapers.delete(paperId);
                return;
            }
            
            const interestedBtn = itemElement.querySelector('.paper-action-btn.interested');
            const notInterestedBtn = itemElement.querySelector('.paper-action-btn.not-interested');
            
        if (interested) {
            // ÁÇπÂáª"ÊÑüÂÖ¥Ë∂£"Êó∂
            if (interestedBtn) {
                interestedBtn.disabled = true;
                interestedBtn.classList.add('processing');
                interestedBtn.setAttribute('data-original-text', 'ÊÑüÂÖ¥Ë∂£');
                interestedBtn.textContent = 'Â§ÑÁêÜ‰∏≠‚Ä¶';
            }
            if (notInterestedBtn) {
                notInterestedBtn.disabled = true;
                notInterestedBtn.classList.add('disabled-gray'); // Âè¶‰∏Ä‰∏™ÊåâÈíÆÂèòÁÅ∞
            }
        } else {
            // ÁÇπÂáª"‰∏çÊÑüÂÖ¥Ë∂£"Êó∂
            if (notInterestedBtn) {
                notInterestedBtn.disabled = true;
                notInterestedBtn.classList.add('processing');
                notInterestedBtn.setAttribute('data-original-text', '‰∏çÊÑüÂÖ¥Ë∂£');
                notInterestedBtn.textContent = 'Â§ÑÁêÜ‰∏≠‚Ä¶';
            }
            if (interestedBtn) {
                interestedBtn.disabled = true;
                interestedBtn.classList.add('disabled-gray'); // Âè¶‰∏Ä‰∏™ÊåâÈíÆÂèòÁÅ∞
            }
        }
            
            // ÂèëÈÄÅËØ∑Ê±ÇÔºå‰ΩÜ‰∏çÁ≠âÂæÖÂìçÂ∫îÔºåËÆ©ÂêéÁ´ØÂºÇÊ≠•Â§ÑÁêÜ
            fetch('/api/email/handle-paper-interest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    paper_id: paperId,
                    interested: interested
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPÈîôËØØ: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Êî∂Âà∞ÂêéÁ´ØÂìçÂ∫î:', data);
                if (data.success) {
                    addLog('success', interested ? 'ÊñáÁ´†Â§ÑÁêÜÊàêÂäüÂπ∂Â∑≤ÂÖ•Â∫ì' : 'Â∑≤Ê†áËÆ∞‰∏∫‰∏çÊÑüÂÖ¥Ë∂£');
                    // Á´ãÂç≥‰ªéÂâçÁ´ØÂàóË°®‰∏≠Áâ©ÁêÜÁßªÈô§ÔºåÁ°Æ‰øù UI ÂèäÊó∂ÂèçÈ¶à
                    pendingPapers = pendingPapers.filter(p => p.paper_id !== paperId);
                    // ‰ªéÂ§ÑÁêÜ‰∏≠ÈõÜÂêàÁßªÈô§
                    processingPapers.delete(paperId);
                    // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                    renderPendingPapers();
                } else {
                    addLog('error', 'Â§ÑÁêÜÂ§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    if (interestedBtn) {
                        interestedBtn.disabled = false;
                        interestedBtn.classList.remove('processing');
                        interestedBtn.textContent = interestedBtn.getAttribute('data-original-text') || 'ÊÑüÂÖ¥Ë∂£';
                    }
                    if (notInterestedBtn) {
                        notInterestedBtn.disabled = false;
                        notInterestedBtn.classList.remove('processing', 'disabled-gray');
                        notInterestedBtn.textContent = '‰∏çÊÑüÂÖ¥Ë∂£';
                    }
                    // ‰ªéÂ§ÑÁêÜ‰∏≠ÈõÜÂêàÁßªÈô§ÔºåÂÖÅËÆ∏ÈáçËØï
                    processingPapers.delete(paperId);
                }
            })
            .catch(error => {
                console.error('Â§ÑÁêÜÊñáÁ´†ÂÖ¥Ë∂£Â§±Ë¥•:', error);
                addLog('error', 'Êèê‰∫§Â§ÑÁêÜËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message);
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                if (interestedBtn) {
                    interestedBtn.disabled = false;
                    interestedBtn.classList.remove('processing');
                    interestedBtn.textContent = interestedBtn.getAttribute('data-original-text') || 'ÊÑüÂÖ¥Ë∂£';
                }
                if (notInterestedBtn) {
                    notInterestedBtn.disabled = false;
                    notInterestedBtn.classList.remove('processing', 'disabled-gray');
                    notInterestedBtn.textContent = '‰∏çÊÑüÂÖ¥Ë∂£';
                }
                
                // ‰ªéÂ§ÑÁêÜ‰∏≠ÈõÜÂêàÁßªÈô§ÔºåÂÖÅËÆ∏ÈáçËØï
                processingPapers.delete(paperId);
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initEmailModal);
        } else {
            initEmailModal();
        }

        // ÊâìÂºÄÊï∞ÊçÆÂ∫ìÁ≥ªÁªüÈ°µÈù¢ÔºàÊñ∞Á™óÂè£Ôºâ
        window.openDatabasePage = function() {
            const windowWidth = 1400;
            const windowHeight = 900;
            const left = (screen.width - windowWidth) / 2;
            const top = (screen.height - windowHeight) / 2;
            
            const dbWindow = window.open(
                '/database',
                '_blank',
                `width=${windowWidth},height=${windowHeight},` +
                `left=${left},top=${top},` +
                `scrollbars=yes,resizable=yes`
            );
            
            if (!dbWindow) {
                addLog('error', 'Êó†Ê≥ïÊâìÂºÄÊñ∞Á™óÂè£ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÂºπÁ™óËÆæÁΩÆ');
            }
        };
        
        // ÊâìÂºÄÈÇÆÁÆ±Á≥ªÁªü
        window.openEmailModal = function() {
            // Á°Æ‰øùÈÇÆÁÆ±Ê®°ÊÄÅÊ°ÜÂ∑≤ÂàùÂßãÂåñ
            if (!emailModal) {
                initEmailModal();
            }
            if (emailModal) {
                loadEmailInfo();
                emailModal.classList.add('active');
            } else {
                addLog('error', 'Êó†Ê≥ïÊâìÂºÄÈÇÆÁÆ±Á≥ªÁªüÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        };
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÈÇÆÁÆ±Ê®°ÊÄÅÊ°Ü
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if (!emailModal) {
                    initEmailModal();
                }
            });
        } else {
            if (!emailModal) {
                initEmailModal();
            }
        }
    </script>
</body>
</html>

