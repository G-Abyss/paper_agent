<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Summarizer - 学术论文自动总结系统</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-cyan: #00d9ff;
            --neon-purple: #7b2cbf;
            --neon-green: #0f0;
            --neon-red: #ff0054;
            --neon-orange: #ffaa00;
            --dark-bg: #0a0e27;
            --dark-panel: rgba(10, 20, 40, 0.7);
            --dark-border: #00d9ff;
            --panel-left-bg: rgba(10, 20, 40, 0.7);
            --panel-center-bg: rgba(10, 20, 40, 0.7);
            --panel-right-bg: rgba(10, 20, 40, 0.7);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark-bg);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* 背景网格效果 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 16px;
            background: var(--dark-bg);
            position: relative;
            z-index: 1;
            padding: 12px;
        }

        .panel {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            border: 2px solid var(--dark-border);
            background: var(--dark-panel);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3),
                        inset 0 0 20px rgba(0, 217, 255, 0.05);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        /* 动态霓虹光边缘效果 */
        .panel::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--neon-cyan), var(--neon-purple), var(--neon-cyan));
            border-radius: 12px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .panel:hover::before {
            opacity: 0.5;
            animation: borderGlow 2s infinite;
        }

        @keyframes borderGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        /* 左侧面板 - 来源 */
        .left-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            background: var(--panel-left-bg);
        }

        /* 中间面板 - 对话 */
        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel-center-bg);
        }

        /* 右侧面板 - 生成 */
        .right-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            background: var(--panel-right-bg);
        }

        .panel-header {
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 2px;
            color: var(--neon-cyan);
            margin: 0;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .settings-btn {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 18px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
        }

        .settings-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
            transform: translateY(-1px);
        }

        .settings-btn:active {
            transform: translateY(0);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            background: transparent;
        }

        /* 自定义滚动条 - 素色椭圆长条 */
        .panel-content::-webkit-scrollbar {
            width: 10px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .panel-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
            background-clip: padding-box;
        }

        /* Firefox 滚动条样式 */
        .panel-content {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        /* 运行选项区域 */
        .run-options {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-bottom: 2px solid var(--dark-border);
            border-radius: 0 0 8px 8px;
            margin-bottom: 0;
        }

        .option-group {
            margin-bottom: 15px;
        }

        .option-group label {
            display: block;
            font-size: 12px;
            color: var(--neon-cyan);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-option {
            position: relative;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--neon-cyan);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option input[type="radio"]:checked {
            background: var(--neon-cyan);
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        .radio-option input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: var(--dark-bg);
            border-radius: 50%;
        }

        .radio-option span {
            margin-left: 8px;
            color: #fff;
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 10px 15px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--neon-cyan);
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .file-select-button {
            width: 100%;
            padding: 10px 15px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
            position: relative;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .file-select-button:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
            transform: translateY(-1px);
        }

        .file-select-button:active {
            transform: translateY(0);
        }

        #file-select-text {
            pointer-events: none;
        }

        .date-inputs {
            display: flex;
            gap: 10px;
        }

        .date-inputs input {
            flex: 1;
        }

        .run-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            border: 2px solid var(--neon-cyan);
            border-radius: 8px;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .run-button::before {
            content: '▶';
            margin-right: 8px;
        }

        .run-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.8);
        }

        .run-button:active {
            transform: translateY(0);
        }

        .run-button.running {
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-red));
            animation: pulse 2s infinite;
        }

        .run-button.waiting {
            background: linear-gradient(135deg, var(--neon-orange), var(--neon-red));
            animation: pulse 2s infinite;
        }

        .run-button.waiting::before {
            content: '⏸';
        }

        .run-button.waiting:hover {
            background: linear-gradient(135deg, var(--neon-green), var(--neon-cyan));
        }

        .run-button.waiting:hover::before {
            content: '▶';
        }

        .email-button {
            width: 100%;
            padding: 12px;
            background: rgba(0, 217, 255, 0.1);
            border: 2px solid var(--neon-cyan);
            border-radius: 8px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        .email-button:hover {
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
            transform: translateY(-2px);
        }

        .email-button:active {
            transform: translateY(0);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(123, 44, 191, 0.5); }
            50% { box-shadow: 0 0 40px rgba(123, 44, 191, 0.8), 0 0 60px rgba(123, 44, 191, 0.6); }
        }

        /* 论文列表 */
        .paper-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .paper-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.2);
        }

        .paper-item:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
            transform: translateX(5px);
        }

        .paper-item[data-link]:hover {
            cursor: pointer;
        }

        .paper-item:not([data-link]) {
            cursor: default;
        }

        .paper-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .paper-title {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            line-height: 1.4;
        }

        .paper-status {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-left: 10px;
        }

        .paper-status.success {
            color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green);
            animation: glow 2s infinite;
        }

        .paper-status.error {
            color: var(--neon-red);
            text-shadow: 0 0 10px var(--neon-red);
        }

        .paper-status.pending {
            color: var(--neon-cyan);
            animation: spin 2s linear infinite;
        }

        @keyframes glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .paper-toggle {
            background: none;
            border: none;
            color: var(--neon-cyan);
            cursor: pointer;
            font-size: 11px;
            padding: 5px 10px;
            margin-top: 8px;
            transition: all 0.3s;
        }

        .paper-toggle:hover {
            color: var(--neon-purple);
            text-shadow: 0 0 10px var(--neon-purple);
        }

        .paper-abstract {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 20, 40, 0.6);
            border-left: 3px solid var(--neon-cyan);
            font-size: 13px;
            line-height: 1.6;
            color: var(--neon-cyan);
            display: none;
        }

        .paper-abstract.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .paper-abstract-editable {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 20, 40, 0.6);
            border-left: 3px solid var(--neon-cyan);
            font-size: 13px;
            line-height: 1.6;
            color: var(--neon-cyan);
            display: none;
        }

        .paper-abstract-editable.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .paper-abstract-editable textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s;
        }

        .paper-abstract-editable textarea:focus {
            outline: none;
            border-color: var(--neon-purple);
            box-shadow: 0 0 10px rgba(123, 44, 191, 0.5);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 日志区域 */
        .log-container {
            height: 100%;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            background: rgba(0, 20, 40, 0.6);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.1);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .log-status {
            color: var(--neon-green);
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 0 10px var(--neon-green);
        }

        .log-content {
            color: var(--neon-cyan);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .log-entry.info .log-content {
            color: var(--neon-cyan);
        }

        .log-entry.success .log-content {
            color: var(--neon-green);
        }

        .log-entry.error .log-content {
            color: var(--neon-red);
            text-shadow: 0 0 10px var(--neon-red);
        }

        .log-entry.warning .log-content {
            color: var(--neon-orange);
            text-shadow: 0 0 10px var(--neon-orange);
        }

        .log-entry.agent_started .log-content {
            color: var(--neon-cyan);
        }

        .log-entry.agent_final_answer .log-content {
            color: var(--neon-green);
        }

        .log-progress {
            color: var(--neon-orange);
            text-shadow: 0 0 10px var(--neon-orange);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(0, 217, 255, 0.2);
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        /* Markdown样式 */
        .log-entry.agent_started p,
        .log-entry.agent_final_answer p {
            margin: 0.5em 0;
        }

        .log-entry.agent_started strong,
        .log-entry.agent_final_answer strong {
            font-weight: 600;
        }

        .log-entry.agent_started code,
        .log-entry.agent_final_answer code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry.agent_started pre,
        .log-entry.agent_final_answer pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .log-entry.agent_started pre code,
        .log-entry.agent_final_answer pre code {
            background: transparent;
            padding: 0;
        }

        .log-entry.agent_started ul,
        .log-entry.agent_final_answer ul,
        .log-entry.agent_started ol,
        .log-entry.agent_final_answer ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .log-entry.agent_started li,
        .log-entry.agent_final_answer li {
            margin: 0.25em 0;
        }

        .log-timestamp {
            color: rgba(0, 217, 255, 0.6);
            font-size: 12px;
            display: block;
            text-align: left;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 217, 255, 0.2);
        }

        /* 输出文件列表 */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .paper-result-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .file-list-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .file-list-header {
            margin-bottom: 15px;
        }

        .file-list-header h3 {
            font-size: 16px;
            color: var(--neon-cyan);
            margin: 0;
            font-weight: 600;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .paper-result-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .paper-result-item:hover {
            background: rgba(0, 217, 255, 0.15);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
            transform: translateX(5px);
        }

        .paper-result-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .paper-result-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .paper-result-score {
            color: var(--neon-cyan);
            font-weight: 600;
        }

        .paper-result-score.high-value {
            color: var(--neon-green);
        }

        .file-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .file-item:hover {
            background: rgba(0, 217, 255, 0.15);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        .file-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .file-item-icon {
            font-size: 24px;
            line-height: 1;
        }

        .file-item-info {
            flex: 1;
        }

        .file-item-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 6px;
            word-break: break-word;
        }

        .file-item-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .file-item-type {
            color: var(--neon-cyan);
        }

        .file-item-size {
            color: rgba(255, 255, 255, 0.5);
        }

        .file-item-time {
            color: rgba(255, 255, 255, 0.4);
        }

        .file-item-actions {
            display: flex;
            gap: 8px;
        }

        .file-action-btn {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: var(--neon-cyan);
        }

        .file-action-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.4);
        }

        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(0, 217, 255, 0.2), 
                transparent);
            transition: left 0.5s;
        }

        .file-item:hover {
            background: rgba(0, 217, 255, 0.15);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
            transform: translateX(5px);
        }

        .file-item:hover::before {
            left: 100%;
        }

        .file-name {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }

        .file-info {
            font-size: 11px;
            color: rgba(0, 217, 255, 0.6);
        }

        .file-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 16px;
        }

        /* 故障效果 */
        .glitch {
            position: relative;
            animation: glitch-anim 5s infinite;
        }

        @keyframes glitch-anim {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }

        /* 隐藏选项 */
        .hidden {
            display: none !important;
        }

        /* 设置弹窗 */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex !important;
            justify-content: center;
            align-items: center;
        }

        .settings-content {
            background: var(--dark-panel);
            border: 2px solid var(--neon-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            position: relative;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--neon-cyan);
            margin: 0;
            text-transform: uppercase;
        }

        .settings-close {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .settings-close:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .settings-body {
            padding: 20px;
        }

        .model-list {
            margin-bottom: 20px;
        }

        .model-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid var(--neon-cyan);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .model-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .model-item-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--neon-cyan);
        }

        .model-item-actions {
            display: flex;
            gap: 10px;
        }

        .btn-test, .btn-delete {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-test {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .btn-test:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        .btn-delete {
            background: rgba(255, 0, 84, 0.1);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .btn-delete:hover {
            background: rgba(255, 0, 84, 0.2);
        }

        .btn-collapse {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 4px;
            color: var(--neon-cyan);
            font-size: 12px;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 30px;
        }

        .btn-collapse:hover {
            background: rgba(0, 217, 255, 0.1);
        }

        .model-title-input {
            background: transparent !important;
            border: none !important;
            border-bottom: 1px solid var(--neon-cyan) !important;
            color: var(--neon-cyan) !important;
            font-family: 'Rajdhani', sans-serif !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            padding: 4px 8px !important;
            flex: 1;
            transition: all 0.3s;
        }

        .model-title-input:focus {
            outline: none;
            border-bottom-color: var(--neon-purple) !important;
            box-shadow: 0 2px 0 rgba(123, 44, 191, 0.5) !important;
        }

        .model-item-content {
            animation: slideDown 0.3s ease;
        }

        .default-model-radio {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
        }

        .default-model-radio input[type="radio"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--neon-cyan);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0;
        }

        .default-model-radio input[type="radio"]:checked {
            background: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .default-model-radio input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: var(--dark-bg);
            border-radius: 50%;
        }

        .default-model-radio .radio-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
        }

        .default-model-radio:hover .radio-label {
            color: var(--neon-cyan);
        }

        .enable-model-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
        }

        .enable-model-checkbox input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--neon-cyan);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0;
        }

        .enable-model-checkbox input[type="checkbox"]:checked {
            background: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .enable-model-checkbox input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--dark-bg);
            font-size: 12px;
            font-weight: bold;
        }

        .enable-model-checkbox .checkbox-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
        }

        .enable-model-checkbox:hover .checkbox-label {
            color: var(--neon-cyan);
        }

        .model-form-group {
            margin-bottom: 15px;
        }

        .model-form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 5px;
            font-family: 'Rajdhani', sans-serif;
        }

        .model-form-group input,
        .model-form-group select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
        }

        .model-form-group input:focus,
        .model-form-group select:focus {
            outline: none;
            border-color: var(--neon-cyan);
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .btn-add-model {
            width: 100%;
            padding: 12px;
            background: rgba(0, 217, 255, 0.1);
            border: 2px dashed var(--neon-cyan);
            border-radius: 8px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .btn-add-model:hover {
            background: rgba(0, 217, 255, 0.2);
            border-style: solid;
        }

        .settings-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-save {
            padding: 10px 20px;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save:hover {
            background: rgba(0, 217, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .test-status {
            display: inline-block;
            margin-left: 10px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .test-status.success {
            background: rgba(0, 255, 0, 0.2);
            color: #0f0;
        }

        .test-status.error {
            background: rgba(255, 0, 84, 0.2);
            color: var(--neon-red);
        }

        .test-status.testing {
            background: rgba(255, 170, 0, 0.2);
            color: var(--neon-orange);
        }

        /* 邮件信息模态框 */
        .email-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .email-modal.active {
            display: flex !important;
            justify-content: center;
            align-items: center;
        }

        .email-settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .email-settings-modal.active {
            display: flex !important;
        }

        .email-settings-content {
            background: var(--dark-panel);
            border: 2px solid var(--neon-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            display: flex;
            flex-direction: column;
        }

        .email-settings-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-settings-header h3 {
            margin: 0;
            color: var(--neon-cyan);
            font-size: 18px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
        }

        .email-settings-close {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .email-settings-close:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .email-settings-body {
            padding: 20px;
        }

        .email-settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
        }

        .form-group .input-field {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-family: 'Rajdhani', sans-serif;
        }

        .form-group .input-field:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .form-hint {
            background: rgba(0, 217, 255, 0.05);
            border-left: 3px solid var(--neon-cyan);
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .form-hint p {
            margin: 0 0 8px 0;
            color: var(--neon-cyan);
            font-size: 13px;
            font-weight: 600;
        }

        .form-hint ul {
            margin: 0;
            padding-left: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            line-height: 1.6;
        }

        .form-hint li {
            margin-bottom: 4px;
        }

        .email-settings-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .email-content {
            background: var(--dark-panel);
            border: 2px solid var(--neon-cyan);
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            position: relative;
        }

        .email-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-header h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--neon-cyan);
            margin: 0;
            text-transform: uppercase;
        }

        .email-close {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-size: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .email-close:hover {
            background: rgba(255, 0, 84, 0.2);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .email-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .email-summary {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid var(--neon-cyan);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .email-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .email-summary-item:last-child {
            margin-bottom: 0;
        }

        .email-summary-label {
            color: var(--neon-cyan);
            font-weight: 600;
        }

        .email-list {
            margin-top: 20px;
        }

        .email-item {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .email-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .email-item-subject {
            font-size: 16px;
            font-weight: 600;
            color: var(--neon-cyan);
        }

        .email-item-date {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .email-pagination {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 16px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin: 0 10px;
        }

        .email-item-papers {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .email-item-papers-title {
            font-size: 12px;
            color: var(--neon-cyan);
            margin-bottom: 8px;
        }

        .email-paper-item {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--neon-cyan);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .email-paper-item:last-child {
            margin-bottom: 0;
        }

        .email-paper-title {
            font-size: 13px;
            color: #fff;
            margin-bottom: 4px;
        }

        .email-paper-title-link {
            font-size: 13px;
            color: var(--neon-cyan);
            text-decoration: none;
            display: block;
            transition: all 0.3s;
        }

        .email-paper-title-link:hover {
            color: #fff;
            text-decoration: underline;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .email-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .email-footer-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-settings {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            color: var(--neon-cyan);
        }

        .btn-settings:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.4);
        }

        .email-settings-footer .btn-test,
        .email-settings-footer .btn-save {
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid;
        }

        .email-settings-footer .btn-test {
            background: rgba(0, 217, 255, 0.1);
            border-color: rgba(0, 217, 255, 0.3);
            color: var(--neon-cyan);
        }

        .email-settings-footer .btn-test:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.4);
        }

        .email-settings-footer .btn-test:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .email-settings-footer .btn-save {
            background: rgba(0, 255, 100, 0.1);
            border-color: rgba(0, 255, 100, 0.3);
            color: var(--neon-green);
        }

        .email-settings-footer .btn-save:hover {
            background: rgba(0, 255, 100, 0.2);
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 255, 100, 0.4);
        }

        .email-settings-footer .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-update {
            padding: 10px 20px;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid var(--neon-cyan);
            border-radius: 6px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-update:hover {
            background: rgba(0, 217, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        .btn-update:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左侧面板 - 来源 -->
        <div class="left-panel panel">
            <div class="panel-header">
                <h2>来源</h2>
                <div class="paper-stats" id="paper-stats" style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 5px;">
                    总计: 0 | 成功: 0 | 失败: 0 | 等待: 0
                </div>
            </div>
            <div class="run-options">
                <div class="option-group">
                    <label>研究方向关键词</label>
                    <input type="text" class="input-field" id="keywords" 
                           placeholder="例如: 机器人学、控制理论、遥操作、机器人动力学、力控、机器学习" 
                           value="机器人学、控制理论、遥操作、机器人动力学、力控、机器学习">
                </div>
                <div class="option-group">
                    <label>运行模式</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="mode" value="local" checked>
                            <span>本地模式</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mode" value="remote">
                            <span>远程模式</span>
                        </label>
                    </div>
                </div>
                <div class="option-group" id="local-options">
                    <label>选择CSV文件</label>
                    <div style="margin-bottom: 10px; padding: 8px 12px; background: rgba(0, 217, 255, 0.05); border-left: 3px solid var(--neon-cyan); border-radius: 4px;">
                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 12px; line-height: 1.6;">
                            <strong style="color: var(--neon-cyan);">CSV文件格式要求：</strong><br>
                            第一列：论文名称<br>
                            第二列：网站链接<br>
                            第三列：摘要
                        </div>
                    </div>
                    <div style="position: relative;">
                        <div class="file-select-button" id="file-select-button">
                            <span id="file-select-text">📁 点击选择CSV文件</span>
                            <input type="file" class="input-field" id="csv-file" 
                                   accept=".csv" 
                                   style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10;">
                        </div>
                    </div>
                    <div id="csv-file-name" style="margin-top: 8px; color: rgba(255, 255, 255, 0.7); font-size: 12px;">
                        未选择文件
                    </div>
                </div>
                <div class="option-group hidden" id="remote-options">
                    <button class="email-button" id="email-btn" style="width: 100%; margin-bottom: 15px;">
                        📧 邮箱
                    </button>
                    <label>日期范围</label>
                    <div class="date-inputs">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; color: rgba(255, 255, 255, 0.7); margin-bottom: 5px;">开始日期</label>
                            <input type="date" class="input-field" id="start-date">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; color: rgba(255, 255, 255, 0.7); margin-bottom: 5px;">结束日期</label>
                            <input type="date" class="input-field" id="end-date">
                        </div>
                    </div>
                </div>
                <button class="run-button" id="run-btn">▶ 开始运行</button>
            </div>
            <div class="panel-content">
                <div class="paper-list" id="paper-list">
                </div>
            </div>
        </div>

        <!-- 中间面板 - 对话 -->
        <div class="center-panel panel">
            <div class="panel-header">
                <h2>对话</h2>
                <button class="settings-btn" id="settings-btn" title="模型设置" onclick="openSettingsModal()">⚙️</button>
            </div>
            <div class="panel-content">
                <div class="log-container" id="log-container">
                    <div class="log-entry info">
                        <span class="log-timestamp">[系统]</span>
                        系统就绪，等待开始处理...
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧面板 - 生成 -->
        <div class="right-panel panel">
            <div class="panel-header">
                <h2>生成</h2>
            </div>
            <div class="panel-content">
                <!-- 论文列表区域 -->
                <div class="paper-result-list" id="paper-result-list">
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 40px 20px;">
                        等待处理论文...
                    </div>
                </div>
                <!-- 文件列表区域 -->
                <div class="file-list-section" id="file-list-section" style="display: none;">
                    <div class="file-list-header">
                        <h3>生成的文件</h3>
                    </div>
                    <div class="file-list" id="file-list">
                        <!-- 文件列表将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO连接
        let socket = null;
        let isRunning = false;
        let isWaitingConfirmation = false;
        let confirmationPapers = {};  // 存储等待确认的论文数据

        // DOM元素
        const modeRadios = document.querySelectorAll('input[name="mode"]');
        const localOptions = document.getElementById('local-options');
        const remoteOptions = document.getElementById('remote-options');
        const runBtn = document.getElementById('run-btn');
        const paperList = document.getElementById('paper-list');
        const logContainer = document.getElementById('log-container');

        // 设置默认日期（昨天和今天）
        function setDefaultDates() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            // 格式化为 YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            if (startDateInput) {
                startDateInput.value = formatDate(yesterday);
            }
            if (endDateInput) {
                endDateInput.value = formatDate(today);
            }
        }
        
        // 初始化时设置默认日期
        setDefaultDates();
        
        // 模式切换函数
        function updateModeDisplay() {
            const checkedMode = document.querySelector('input[name="mode"]:checked');
            if (checkedMode) {
                if (checkedMode.value === 'local') {
                    localOptions.classList.remove('hidden');
                    remoteOptions.classList.add('hidden');
                } else {
                    localOptions.classList.add('hidden');
                    remoteOptions.classList.remove('hidden');
                }
            }
        }
        
        // 模式切换事件监听
        modeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                updateModeDisplay();
            });
        });
        
        // 初始化时根据默认选中的模式设置显示状态
        updateModeDisplay();

        // 连接Socket.IO
        function connectWebSocket() {
            const socketUrl = window.location.origin;
            
            socket = io(socketUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: Infinity
            });

            socket.on('connect', () => {
                addLog('info', 'Socket.IO连接已建立');
            });

            socket.on('message', (data) => {
                handleWebSocketMessage(data);
            });

            socket.on('disconnect', () => {
                addLog('warning', 'Socket.IO连接已断开，尝试重连...');
            });

            socket.on('connect_error', (error) => {
                addLog('error', `Socket.IO连接错误: ${error.message || '连接失败'}`);
            });
        }

        // 处理WebSocket消息
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'log':
                    addLog(data.level || 'info', data.message);
                    break;
                case 'paper_added':
                    addPaper(data.paper);
                    break;
                case 'paper_updated':
                    updatePaper(data.paper_id, data.paper);
                    // 如果论文处理成功，添加到生成列表
                    if (data.paper.status === 'success' && data.paper.score !== undefined && data.paper.score >= 0) {
                        addPaperToResultList(data.paper_id, data.paper);
                    }
                    break;
                case 'paper_removed':
                    removePaper(data.paper_id);
                    removePaperFromResultList(data.paper_id);
                    break;
                case 'file_generated':
                    addFile(data.file);
                    break;
                case 'agent_status':
                    addAgentStatus(data.agent_name, data.status, data.target, data.output, data.message);
                    break;
                case 'status':
                    if (data.status === 'running') {
                        isRunning = true;
                        isWaitingConfirmation = false;
                        runBtn.classList.remove('waiting');
                        runBtn.classList.add('running');
                        runBtn.textContent = '⏸ 运行中...';
                        runBtn.disabled = true;
                    } else if (data.status === 'waiting_confirmation') {
                        isRunning = false;
                        isWaitingConfirmation = true;
                        runBtn.classList.remove('running');
                        runBtn.classList.add('waiting');
                        runBtn.textContent = '⏸ 等待人工确认';
                        runBtn.disabled = false;
                    } else if (data.status === 'completed') {
                        isRunning = false;
                        isWaitingConfirmation = false;
                        runBtn.classList.remove('running', 'waiting');
                        runBtn.textContent = '▶ 开始运行';
                        runBtn.disabled = false;
                    }
                    break;
                case 'waiting_confirmation':
                    handleWaitingConfirmation(data.papers);
                    break;
                case 'paper_ready_for_confirmation':
                    handlePaperReadyForConfirmation(data.paper_id, data.paper);
                    break;
            }
        }

        // 添加日志
        function addLog(level, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            const timestamp = new Date().toLocaleTimeString();
            
            let statusText = '';
            let contentText = '';
            
            // 对于agent_started和agent_final_answer，使用markdown渲染
            if (level === 'agent_started') {
                statusText = '[ Agent Started ]';
                try {
                    // 使用marked.js渲染markdown
                    contentText = marked.parse(message);
                } catch (e) {
                    // 如果markdown解析失败，回退到普通文本
                    const messageLines = message.split('\n');
                    contentText = messageLines
                        .map((line, index) => {
                            if (line.trim()) {
                                return escapeHtml(line);
                            }
                            return '';
                        })
                        .filter(line => line)
                        .join('<br>');
                }
            } else if (level === 'agent_final_answer') {
                statusText = '[ Agent Final Answer ]';
                try {
                    // 使用marked.js渲染markdown
                    contentText = marked.parse(message);
                } catch (e) {
                    // 如果markdown解析失败，回退到普通文本
                    const messageLines = message.split('\n');
                    contentText = messageLines
                        .map((line, index) => {
                            if (line.trim()) {
                                return escapeHtml(line);
                            }
                            return '';
                        })
                        .filter(line => line)
                        .join('<br>');
                }
            } else {
                // 其他消息：根据内容判断状态和内容
                const messageLines = message.split('\n');
                const firstLine = messageLines[0]?.trim() || '';
                
                // 检查是否是状态消息（如 Crew:, Task:, Status:）
                if (firstLine.includes('Crew:') || firstLine.includes('Task:') || firstLine.includes('Status:') || firstLine.includes('🔄') || firstLine.includes('📋')) {
                    // 提取状态信息，格式化为类似 "Crew: Crew | 📋 Task: xxx | Status: Executing Task..."
                    const statusParts = [];
                    const contentParts = [];
                    
                    messageLines.forEach(line => {
                        const trimmed = line.trim();
                        if (!trimmed) return;
                        
                        // 提取状态行（包含 Crew, Task, Status, Tool 等关键词）
                        if (trimmed.includes('Crew:') || trimmed.includes('Task:') || trimmed.includes('Status:') || trimmed.includes('Tool:') || trimmed.includes('Tool Args:') || trimmed.includes('🔄') || trimmed.includes('📋')) {
                            // 清理格式，提取关键信息
                            let cleanLine = trimmed;
                            if (cleanLine.includes('🔄')) cleanLine = cleanLine.replace('🔄', '').trim();
                            if (cleanLine.includes('📋')) cleanLine = cleanLine.replace('📋', '').trim();
                            statusParts.push(cleanLine);
                        } else {
                            // 其他内容
                            contentParts.push(trimmed);
                        }
                    });
                    
                    // 格式化状态文本
                    if (statusParts.length > 0) {
                        statusText = `[ ${statusParts.join(' | ')} ]`;
                    } else {
                        statusText = `[ ${level.toUpperCase()} ]`;
                    }
                    
                    // 内容文本
                    contentText = contentParts.length > 0 ? contentParts.map(l => escapeHtml(l)).join('<br>') : '';
                    
                    // 如果状态包含 "Executing Task"，添加进度条
                    if (statusText.includes('Executing Task')) {
                        contentText = '<div class="progress-bar"><div class="progress-fill"></div></div>' + contentText;
                    }
                } else {
                    // 普通消息
                    statusText = `[ ${level.toUpperCase()} ]`;
                    contentText = messageLines
                        .map((line, index) => {
                            if (line.trim()) {
                                return escapeHtml(line);
                            }
                            return '';
                        })
                        .filter(line => line)
                        .join('<br>');
                }
            }
            
            entry.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div class="log-status">${statusText}</div>
                <div class="log-content">${contentText}</div>
            `;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 添加agent状态信息
        function addAgentStatus(agentName, status, target, output, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${status === 'start' ? 'info' : 'success'}`;
            const timestamp = new Date().toLocaleTimeString();
            
            let statusText = '';
            let contentText = '';
            
            if (status === 'start') {
                statusText = `[ ${agentName} 工作开始 ]`;
                if (target) {
                    contentText = escapeHtml(`目标文章：${target}`);
                } else {
                    contentText = escapeHtml(message || `${agentName}开始工作`);
                }
            } else if (status === 'end') {
                statusText = `[ ${agentName} 工作结束 ]`;
                const contentParts = [];
                
                // 如果有目标论文，先显示目标论文
                if (target) {
                    contentParts.push(`目标论文：${escapeHtml(target)}`);
                }
                
                // 如果有输出，显示输出
                if (output) {
                    // 输出信息可能很长，只显示前200字符
                    const outputPreview = output.length > 200 ? output.substring(0, 200) + '...' : output;
                    contentParts.push(`输出：${escapeHtml(outputPreview)}`);
                }
                
                // 如果都没有，显示默认消息
                if (contentParts.length === 0) {
                    contentText = escapeHtml(message || `${agentName}工作完成`);
                } else {
                    contentText = contentParts.join('<br>');
                }
            } else {
                statusText = `[ ${agentName} ]`;
                contentText = escapeHtml(message || `${agentName}状态：${status}`);
            }
            
            entry.innerHTML = `
                <div class="log-status">${statusText}</div>
                <div class="log-content">${contentText}</div>
                <div style="font-size: 10px; color: rgba(255, 255, 255, 0.5); margin-top: 5px;">${timestamp}</div>
            `;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 添加论文
        // 更新统计信息
        function updatePaperStats() {
            const statsEl = document.getElementById('paper-stats');
            if (!statsEl) return;
            
            const papers = paperList.querySelectorAll('.paper-item');
            let total = papers.length;
            let success = 0;
            let error = 0;
            let pending = 0;
            
            papers.forEach(paper => {
                const statusEl = paper.querySelector('.paper-status');
                if (statusEl) {
                    if (statusEl.classList.contains('success')) {
                        success++;
                    } else if (statusEl.classList.contains('error')) {
                        error++;
                    } else if (statusEl.classList.contains('pending')) {
                        pending++;
                    }
                }
            });
            
            statsEl.textContent = `总计: ${total} | 成功: ${success} | 失败: ${error} | 等待: ${pending}`;
        }

        function addPaper(paper) {
            // 移除"处理中..."提示
            if (paperList.children.length === 1) {
                const firstChild = paperList.firstElementChild;
                if (firstChild && firstChild.textContent.includes('处理中...')) {
                    paperList.removeChild(firstChild);
                }
            }

            // 检查是否已存在（避免重复添加）
            const existingPaper = document.getElementById(`paper-${paper.id}`);
            if (existingPaper) {
                return;
            }

            const paperItem = document.createElement('div');
            paperItem.className = 'paper-item';
            paperItem.id = `paper-${paper.id}`;
            // 保存链接到data属性
            if (paper.link) {
                paperItem.setAttribute('data-link', paper.link);
            }
            // 保存状态到data属性，便于排序
            paperItem.setAttribute('data-status', paper.status || 'pending');
            // 保存标题到data属性，便于搜索
            paperItem.setAttribute('data-title', paper.title.toLowerCase());
            
            paperItem.innerHTML = `
                <div class="paper-header">
                    <div class="paper-title" title="${escapeHtml(paper.title)}">${escapeHtml(paper.title)}</div>
                    <div class="paper-status pending">⏳</div>
                </div>
                <button class="paper-toggle" onclick="event.stopPropagation(); toggleAbstract('${paper.id}')" style="display: none;">
                    ▼ 查看摘要
                </button>
                <div class="paper-abstract" id="abstract-${paper.id}"></div>
            `;
            
            // 添加点击事件：在新窗口打开论文链接
            if (paper.link) {
                paperItem.addEventListener('click', function(e) {
                    // 如果点击的是摘要切换按钮、摘要区域或可编辑摘要区域，不打开链接
                    if (e.target.closest('.paper-toggle') || 
                        e.target.closest('.paper-abstract') || 
                        e.target.closest('.paper-abstract-editable')) {
                        return;
                    }
                    // 在新窗口打开链接
                    window.open(paper.link, '_blank');
                });
            } else {
                // 如果没有链接，移除指针样式
                paperItem.style.cursor = 'default';
            }
            
            paperList.appendChild(paperItem);
            updatePaperStats();
        }

        // 处理等待确认消息（批量模式，已弃用）
        function handleWaitingConfirmation(papers) {
            confirmationPapers = papers;
            isWaitingConfirmation = true;
            
            // 为每篇论文添加可编辑的摘要框
            for (const [paperId, paperData] of Object.entries(papers)) {
                addEditableAbstractToPaper(paperId, paperData);
            }
            
            addLog('info', `等待人工确认 ${Object.keys(papers).length} 篇论文的摘要`);
        }
        
        // 处理单个论文准备确认消息（实时模式）
        function handlePaperReadyForConfirmation(paperId, paperData) {
            const paperItem = document.getElementById(`paper-${paperId}`);
            if (!paperItem) {
                return;
            }
            
            // 添加可编辑摘要框
            addEditableAbstractToPaper(paperId, paperData);
            
            if (paperData.abstract && paperData.abstract.trim()) {
                addLog('info', `论文 "${paperData.title}" 摘要已提取，可以编辑摘要`);
            } else {
                addLog('info', `论文 "${paperData.title}" 摘要提取失败，可以手动添加摘要`);
            }
        }
        
        // 为论文添加可编辑摘要框（通用函数）
        function addEditableAbstractToPaper(paperId, paperData) {
            const paperItem = document.getElementById(`paper-${paperId}`);
            if (!paperItem) return;
            
            // 检查是否已有可编辑摘要框
            let editableAbstract = paperItem.querySelector('.paper-abstract-editable');
            if (!editableAbstract) {
                // 创建可编辑摘要框
                editableAbstract = document.createElement('div');
                editableAbstract.className = 'paper-abstract-editable';
                editableAbstract.id = `abstract-editable-${paperId}`;
                
                const textarea = document.createElement('textarea');
                textarea.id = `abstract-textarea-${paperId}`;
                textarea.value = paperData.abstract || '';
                textarea.placeholder = '请在此处编辑或粘贴论文摘要...';
                
                editableAbstract.appendChild(textarea);
                
                // 插入到论文项中（在摘要切换按钮之后）
                const toggleBtn = paperItem.querySelector('.paper-toggle');
                if (toggleBtn) {
                    toggleBtn.insertAdjacentElement('afterend', editableAbstract);
                } else {
                    const header = paperItem.querySelector('.paper-header');
                    header.insertAdjacentElement('afterend', editableAbstract);
                }
            } else {
                // 更新现有摘要框的内容
                // 重要：如果用户已经编辑过摘要，不要覆盖用户编辑的内容
                const textarea = editableAbstract.querySelector('textarea');
                if (textarea) {
                    // 只有当新数据有摘要且当前文本框为空时，才更新
                    // 或者如果新数据的摘要与当前内容不同，可能是系统更新，需要更新
                    const currentValue = textarea.value.trim();
                    const newValue = (paperData.abstract || '').trim();
                    
                    // 如果当前文本框为空，使用新数据
                    // 如果新数据不为空且与当前内容不同，可能是系统更新（例如摘要提取成功），更新内容
                    if (currentValue === '' || (newValue !== '' && newValue !== currentValue)) {
                        textarea.value = newValue;
                    }
                    // 否则保持用户编辑的内容不变
                }
            }
            
            // 显示摘要切换按钮（如果还没有显示）
            const toggleBtn = paperItem.querySelector('.paper-toggle');
            if (toggleBtn) {
                toggleBtn.style.display = 'block';
                toggleBtn.textContent = '▼ 查看/编辑摘要';
                toggleBtn.onclick = function(e) {
                    e.stopPropagation();
                    toggleEditableAbstract(paperId);
                };
            }
            
            // 默认展开可编辑摘要框
            editableAbstract.classList.add('show');
        }
        
        // 切换可编辑摘要显示
        function toggleEditableAbstract(paperId) {
            const editableAbstract = document.getElementById(`abstract-editable-${paperId}`);
            const toggleBtn = editableAbstract ? editableAbstract.previousElementSibling : null;
            
            if (editableAbstract) {
                editableAbstract.classList.toggle('show');
                if (toggleBtn) {
                    toggleBtn.textContent = editableAbstract.classList.contains('show') 
                        ? '▲ 隐藏摘要' 
                        : '▼ 查看/编辑摘要';
                }
            }
        }

        // 更新论文状态
        function updatePaper(paperId, paper) {
            const paperItem = document.getElementById(`paper-${paperId}`);
            if (!paperItem) return;

            const statusEl = paperItem.querySelector('.paper-status');
            const toggleBtn = paperItem.querySelector('.paper-toggle');
            const abstractEl = paperItem.querySelector('.paper-abstract');

            // 状态映射
            const statusMap = {
                'pending': { icon: '⏳', class: 'pending', text: '等待处理' },
                'analyzing_relevance': { icon: '🔍', class: 'pending', text: '相关性分析中' },
                'extracting_abstract': { icon: '📄', class: 'pending', text: '摘要提取中' },
                'abstract_extracted': { icon: '✓', class: 'pending', text: '摘要提取成功' },
                'abstract_extraction_failed': { icon: '✗', class: 'pending', text: '摘要提取失败' },
                'waiting_confirmation': { icon: '✋', class: 'pending', text: '等待人工确认' },
                'abstract_confirmed': { icon: '✓', class: 'pending', text: '摘要已确认' },
                'validating_cleaning': { icon: '🔎', class: 'pending', text: '验证与清洗中' },
                'translating': { icon: '🌐', class: 'pending', text: '翻译中' },
                'reviewing': { icon: '⭐', class: 'pending', text: '评审中' },
                'success': { icon: '✓', class: 'success', text: '处理完成' },
                'error': { icon: '✗', class: 'error', text: '处理失败' }
            };

            // 获取状态信息
            const statusInfo = statusMap[paper.status] || statusMap['pending'];
            
            // 更新状态图标和样式
            statusEl.className = `paper-status ${statusInfo.class}`;
            statusEl.textContent = statusInfo.icon;
            statusEl.setAttribute('title', paper.status_text || statusInfo.text);
            paperItem.setAttribute('data-status', paper.status || 'pending');

            // 如果状态文本存在，在标题下方显示状态文本
            let statusTextEl = paperItem.querySelector('.paper-status-text');
            if (paper.status_text && paper.status !== 'success' && paper.status !== 'error') {
                if (!statusTextEl) {
                    statusTextEl = document.createElement('div');
                    statusTextEl.className = 'paper-status-text';
                    statusTextEl.style.cssText = 'font-size: 11px; color: rgba(0, 217, 255, 0.7); margin-top: 5px;';
                    const header = paperItem.querySelector('.paper-header');
                    header.insertAdjacentElement('afterend', statusTextEl);
                }
                statusTextEl.textContent = paper.status_text;
                statusTextEl.style.display = 'block';
            } else if (statusTextEl) {
                statusTextEl.style.display = 'none';
            }

            // 处理成功状态
            if (paper.status === 'success') {
                if (paper.abstract) {
                    toggleBtn.style.display = 'block';
                    abstractEl.textContent = paper.abstract;
                }
            }
            
            // 更新标题（如果提供了新标题）
            if (paper.title) {
                const titleEl = paperItem.querySelector('.paper-title');
                if (titleEl) {
                    titleEl.textContent = paper.title;
                    titleEl.setAttribute('title', paper.title);
                    paperItem.setAttribute('data-title', paper.title.toLowerCase());
                }
            }
            
            // 更新链接（如果提供了新链接）
            if (paper.link) {
                paperItem.setAttribute('data-link', paper.link);
            }
            
            updatePaperStats();
        }
        
        // 删除论文
        function removePaper(paperId) {
            const paperItem = document.getElementById(`paper-${paperId}`);
            if (paperItem) {
                paperItem.remove();
                updatePaperStats();
            }
        }

        // 切换摘要显示
        function toggleAbstract(paperId) {
            const abstractEl = document.getElementById(`abstract-${paperId}`);
            const toggleBtn = abstractEl.previousElementSibling;
            abstractEl.classList.toggle('show');
            toggleBtn.textContent = abstractEl.classList.contains('show') ? '▲ 隐藏摘要' : '▼ 查看摘要';
        }
        
        // 打开论文链接
        function openPaperLink(link) {
            if (link) {
                window.open(link, '_blank');
            }
        }
        
        // 确认并继续运行
        function confirmAndContinue() {
            // 收集所有可编辑摘要框的内容（包括实时显示的）
            const confirmedPapers = {};
            
            // 收集所有可编辑摘要框（包括空摘要，用户可能已经手动添加）
            const allTextareas = document.querySelectorAll('textarea[id^="abstract-textarea-"]');
            allTextareas.forEach(textarea => {
                const paperId = textarea.id.replace('abstract-textarea-', '');
                const abstractText = textarea.value.trim();
                // 即使摘要为空也收集，因为用户可能正在编辑或已经确认为空
                confirmedPapers[paperId] = abstractText;
            });
            
            // 如果没有收集到任何摘要框，尝试从 confirmationPapers 中收集
            if (Object.keys(confirmedPapers).length === 0) {
                for (const paperId of Object.keys(confirmationPapers)) {
                    const textarea = document.getElementById(`abstract-textarea-${paperId}`);
                    if (textarea) {
                        const abstractText = textarea.value.trim();
                        // 即使摘要为空也收集
                        confirmedPapers[paperId] = abstractText;
                    }
                }
            }
            
            // 发送确认请求
            fetch('/api/confirm_abstracts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    papers: confirmedPapers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('success', `已确认 ${Object.keys(confirmedPapers).length} 篇论文的摘要，继续处理...`);
                    isWaitingConfirmation = false;
                    confirmationPapers = {};
                } else {
                    addLog('error', `确认失败: ${data.error}`);
                }
            })
            .catch(error => {
                addLog('error', `确认请求失败: ${error.message}`);
            });
        }

        // 添加文件
        function addFile(file) {
            addLog('success', `文件已生成: ${file.name}`);
            
            // 显示文件列表区域
            const fileListSection = document.getElementById('file-list-section');
            const fileList = document.getElementById('file-list');
            
            if (!fileListSection || !fileList) {
                return;
            }
            
            // 显示文件列表区域
            fileListSection.style.display = 'block';
            
            // 创建文件项
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.dataset.filePath = file.path;
            
            // 根据文件类型设置图标
            const fileIcon = file.type === 'md' ? '📄' : '📊';
            const fileTypeText = file.type === 'md' ? 'Markdown' : 'CSV';
            
            // 转义文件路径和名称中的特殊字符
            const escapedPath = file.path.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const escapedName = file.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            fileItem.innerHTML = `
                <div class="file-item-content">
                    <div class="file-item-icon">${fileIcon}</div>
                    <div class="file-item-info">
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-meta">
                            <span class="file-item-type">${fileTypeText}</span>
                            <span class="file-item-size">${file.size}</span>
                            <span class="file-item-time">${file.time}</span>
                        </div>
                    </div>
                </div>
                <div class="file-item-actions">
                    <button class="file-action-btn" onclick="downloadFile('${escapedPath}', '${escapedName}')" title="下载">
                        ⬇️
                    </button>
                    <button class="file-action-btn" onclick="openFile('${escapedPath}')" title="打开">
                        🔍
                    </button>
                </div>
            `;
            
            // 添加到文件列表（新文件添加到顶部）
            fileList.insertBefore(fileItem, fileList.firstChild);
        }

        // 打开文件
        function openFile(filePath) {
            fetch(`/api/open_file?path=${encodeURIComponent(filePath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog('success', `已打开文件: ${filePath}`);
                    } else {
                        addLog('error', `无法打开文件: ${data.error}`);
                    }
                })
                .catch(error => {
                    addLog('error', `打开文件失败: ${error.message}`);
                });
        }

        // 下载文件
        function downloadFile(filePath, fileName) {
            // 创建下载链接
            const link = document.createElement('a');
            link.href = `/api/download_file?path=${encodeURIComponent(filePath)}`;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            addLog('success', `开始下载: ${fileName}`);
        }

        // ========== 论文结果列表功能 ==========
        const paperResultList = document.getElementById('paper-result-list');
        const processedPapers = {}; // 存储已处理的论文数据 {paper_id: paper_data}

        // 添加论文到生成列表
        function addPaperToResultList(paperId, paper) {
            // 只添加成功处理且评分>=0的论文
            if (paper.status !== 'success' || paper.score === undefined || paper.score < 0) {
                return;
            }

            // 保存论文数据
            processedPapers[paperId] = paper;

            // 检查是否已存在
            const existingItem = document.getElementById(`result-paper-${paperId}`);
            if (existingItem) {
                updatePaperResultItem(paperId, paper);
                return;
            }

            // 移除"等待处理论文..."提示
            if (paperResultList && paperResultList.children.length === 1) {
                const firstChild = paperResultList.firstElementChild;
                if (firstChild && firstChild.textContent.includes('等待处理论文...')) {
                    paperResultList.removeChild(firstChild);
                }
            }

            // 创建论文结果项
            const resultItem = document.createElement('div');
            resultItem.className = 'paper-result-item';
            resultItem.id = `result-paper-${paperId}`;
            resultItem.onclick = () => openPaperReviewWindow(paperId, paper);

            const scoreClass = paper.score >= 3.5 ? 'high-value' : '';
            resultItem.innerHTML = `
                <div class="paper-result-title" title="${escapeHtml(paper.title || '')}">
                    ${escapeHtml(paper.title || 'Unknown')}
                </div>
                <div class="paper-result-meta">
                    <span>评分: <span class="paper-result-score ${scoreClass}">${paper.score ? paper.score.toFixed(2) : '0.00'}/4.0</span></span>
                    ${paper.is_high_value ? '<span style="color: var(--neon-green);">⭐ 高价值</span>' : ''}
                </div>
            `;

            if (paperResultList) {
                paperResultList.appendChild(resultItem);
            }
        }

        // 更新论文结果项
        function updatePaperResultItem(paperId, paper) {
            const resultItem = document.getElementById(`result-paper-${paperId}`);
            if (!resultItem) return;

            processedPapers[paperId] = paper;

            const scoreClass = paper.score >= 3.5 ? 'high-value' : '';
            resultItem.innerHTML = `
                <div class="paper-result-title" title="${escapeHtml(paper.title || '')}">
                    ${escapeHtml(paper.title || 'Unknown')}
                </div>
                <div class="paper-result-meta">
                    <span>评分: <span class="paper-result-score ${scoreClass}">${paper.score ? paper.score.toFixed(2) : '0.00'}/4.0</span></span>
                    ${paper.is_high_value ? '<span style="color: var(--neon-green);">⭐ 高价值</span>' : ''}
                </div>
            `;
            resultItem.onclick = () => openPaperReviewWindow(paperId, paper);
        }

        // 从生成列表移除论文
        function removePaperFromResultList(paperId) {
            const resultItem = document.getElementById(`result-paper-${paperId}`);
            if (resultItem) {
                resultItem.remove();
            }
            delete processedPapers[paperId];

            // 如果没有论文了，显示提示
            if (paperResultList && paperResultList.children.length === 0) {
                paperResultList.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 40px 20px;">等待处理论文...</div>';
            }
        }

        // 打开论文评审窗口
        function openPaperReviewWindow(paperId, paper) {
            // 获取完整的论文数据（包括多模型结果）
            const fullPaper = processedPapers[paperId] || paper;
            
            // 计算窗口居中位置
            const windowWidth = 1200;
            const windowHeight = 800;
            const left = (screen.width - windowWidth) / 2;
            const top = (screen.height - windowHeight) / 2;
            
            // 创建新窗口（居中显示）
            const reviewWindow = window.open('', '_blank', 
                `width=${windowWidth},height=${windowHeight},` +
                `left=${left},top=${top},` +
                `scrollbars=yes,resizable=yes`);
            if (!reviewWindow) {
                addLog('error', '无法打开新窗口，请检查浏览器弹窗设置');
                return;
            }

            // 构建HTML内容
            const multiModelResults = fullPaper.multi_model_results || {};
            const summaryResult = fullPaper.summary_result || null;
            const modelIds = Object.keys(multiModelResults);
            
            let tabsHtml = '';
            let contentHtml = '';
            let tabIndex = 0;
            
            // 如果有汇总结果，先添加汇总标签页
            if (summaryResult) {
                const isActive = tabIndex === 0 ? 'active' : '';
                tabsHtml += `<button class="review-tab ${isActive}" onclick="switchReviewTab('summary')">📊 汇总</button>`;
                
                const isContentActive = tabIndex === 0 ? 'active' : '';
                // 构建汇总内容
                let summaryContent = '';
                if (summaryResult.consensus_points) {
                    summaryContent += `**共识要点**：\n\n${summaryResult.consensus_points}\n\n`;
                }
                if (summaryResult.divergence_points) {
                    summaryContent += `**分歧分析**：\n\n${summaryResult.divergence_points}\n\n`;
                }
                if (summaryResult.final_review) {
                    summaryContent += `**综合评审报告**：\n\n${summaryResult.final_review}\n\n`;
                }
                if (summaryResult.final_score_details && Object.keys(summaryResult.final_score_details).length > 0) {
                    summaryContent += `**最终评分详情**：\n\n`;
                    for (const [dim, score] of Object.entries(summaryResult.final_score_details)) {
                        summaryContent += `- ${dim}：${score.toFixed(2)}/1.0\n`;
                    }
                    summaryContent += `\n`;
                }
                if (summaryResult.model_consistency !== undefined) {
                    summaryContent += `**模型一致性**：${(summaryResult.model_consistency * 100).toFixed(1)}%\n\n`;
                }
                if (summaryResult.confidence !== undefined) {
                    summaryContent += `**结果可信度**：${(summaryResult.confidence * 100).toFixed(1)}%\n\n`;
                }
                
                contentHtml += `
                    <div class="review-content ${isContentActive}" id="review-content-summary">
                        <div class="review-markdown" id="review-markdown-summary">
                            ${escapeHtml(summaryContent || '暂无汇总结果')}
                        </div>
                    </div>
                `;
                tabIndex++;
            }
            
            // 添加各个模型的标签页
            if (modelIds.length > 0) {
                modelIds.forEach((modelId) => {
                    const modelResult = multiModelResults[modelId];
                    const modelName = modelResult.model_name || modelId;
                    const isActive = tabIndex === 0 && !summaryResult ? 'active' : '';
                    tabsHtml += `<button class="review-tab ${isActive}" onclick="switchReviewTab('${modelId}')">${escapeHtml(modelName)}</button>`;
                    
                    const isContentActive = tabIndex === 0 && !summaryResult ? 'active' : '';
                    contentHtml += `
                        <div class="review-content ${isContentActive}" id="review-content-${modelId}">
                            <div class="review-markdown" id="review-markdown-${modelId}">
                                ${escapeHtml(modelResult.review || '暂无评审结果')}
                            </div>
                        </div>
                    `;
                    tabIndex++;
                });
            } else {
                // 如果没有多模型结果，显示单一评审结果
                if (!summaryResult) {
                    tabsHtml = '<button class="review-tab active">评审结果</button>';
                    contentHtml = `
                        <div class="review-content active">
                            <div class="review-markdown">
                                ${escapeHtml(fullPaper.review || '暂无评审结果')}
                            </div>
                        </div>
                    `;
                }
            }

            // 先序列化JSON数据，避免在模板字符串中嵌套${}
            const multiModelResultsJson = JSON.stringify(multiModelResults);
            const summaryResultJson = JSON.stringify(summaryResult);
            const fullPaperReviewJson = JSON.stringify(fullPaper.review || '');
            
            // 使用字符串拼接而不是模板字符串，避免JSON中的特殊字符导致语法错误
            const htmlContent = '<!DOCTYPE html>\n' +
'<html lang="zh-CN">\n' +
'<head>\n' +
'    <meta charset="UTF-8">\n' +
'    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
'    <title>论文评审 - ' + escapeHtml(fullPaper.title || 'Unknown') + '</title>\n' +
'    <script>\n' +
'        // 动态加载 marked.js，避免 document.write 警告\n' +
'        (function() {\n' +
'            const script = document.createElement(\'script\');\n' +
'            script.src = \'https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js\';\n' +
'            script.async = true;\n' +
'            document.head.appendChild(script);\n' +
'        })();\n' +
'    <\/script>\n' +
'    <style>\n' +
'        * { margin: 0; padding: 0; box-sizing: border-box; }\n' +
'        body { font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; background: #0a0e27; color: #fff; padding: 20px; overflow-y: auto; }\n' +
'        .review-header { background: rgba(10, 20, 40, 0.7); border: 2px solid #00d9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px; }\n' +
'        .review-title { font-size: 20px; font-weight: 600; color: #00d9ff; margin-bottom: 10px; }\n' +
'        .review-meta { display: flex; gap: 20px; font-size: 14px; color: rgba(255, 255, 255, 0.7); }\n' +
'        .review-meta a { color: #00d9ff; text-decoration: none; }\n' +
'        .review-meta a:hover { text-decoration: underline; }\n' +
'        .review-tabs { display: flex !important; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid rgba(0, 217, 255, 0.3); padding-bottom: 10px; visibility: visible !important; opacity: 1 !important; }\n' +
'        .review-tab { background: rgba(0, 217, 255, 0.1); border: 1px solid #00d9ff; border-radius: 6px; padding: 10px 20px; color: #00d9ff; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; }\n' +
'        .review-tab:hover { background: rgba(0, 217, 255, 0.2); }\n' +
'        .review-tab.active { background: rgba(0, 217, 255, 0.3); border-color: #00d9ff; box-shadow: 0 0 15px rgba(0, 217, 255, 0.4); }\n' +
'        .review-content { display: none; background: rgba(10, 20, 40, 0.7); border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 12px; padding: 30px; min-height: 500px; max-height: calc(100vh - 300px); overflow-y: auto; }\n' +
'        .review-content.active { display: block; }\n' +
'        .review-markdown { line-height: 1.8; color: rgba(255, 255, 255, 0.9); }\n' +
'        .review-markdown h1, .review-markdown h2, .review-markdown h3 { color: #00d9ff; margin-top: 20px; margin-bottom: 10px; }\n' +
'        .review-markdown p { margin-bottom: 15px; }\n' +
'        .review-markdown code { background: rgba(0, 0, 0, 0.3); padding: 2px 6px; border-radius: 3px; font-family: \'Courier New\', monospace; }\n' +
'        .review-markdown pre { background: rgba(0, 0, 0, 0.5); padding: 15px; border-radius: 6px; overflow-x: auto; margin: 15px 0; }\n' +
'        .review-markdown pre code { background: transparent; padding: 0; }\n' +
'        .review-markdown strong { color: #00d9ff; }\n' +
'        .review-markdown ul, .review-markdown ol { margin-left: 20px; margin-bottom: 15px; }\n' +
'        .review-markdown li { margin-bottom: 8px; }\n' +
'        /* 自定义滚动条样式 - 与主UI风格一致 */\n' +
'        body::-webkit-scrollbar, .review-content::-webkit-scrollbar { width: 10px; }\n' +
'        body::-webkit-scrollbar-track, .review-content::-webkit-scrollbar-track { background: transparent; }\n' +
'        body::-webkit-scrollbar-thumb, .review-content::-webkit-scrollbar-thumb { background: rgba(0, 217, 255, 0.2); border-radius: 10px; border: 2px solid transparent; background-clip: padding-box; }\n' +
'        body::-webkit-scrollbar-thumb:hover, .review-content::-webkit-scrollbar-thumb:hover { background: rgba(0, 217, 255, 0.3); background-clip: padding-box; }\n' +
'        body { scrollbar-width: thin; scrollbar-color: rgba(0, 217, 255, 0.2) transparent; }\n' +
'        .review-content { scrollbar-width: thin; scrollbar-color: rgba(0, 217, 255, 0.2) transparent; }\n' +
'    </style>\n' +
'</head>\n' +
'<body>\n' +
'    <div class="review-header">\n' +
'        <div class="review-title">' + escapeHtml(fullPaper.title || 'Unknown') + '</div>\n' +
'        <div class="review-meta">\n' +
'            <span>评分: <strong style="color: #00d9ff;">' + (fullPaper.score ? fullPaper.score.toFixed(2) : '0.00') + '/4.0</strong></span>\n' +
(fullPaper.is_high_value ? '            <span style="color: #0f0;">⭐ 高价值论文</span>\n' : '') +
(fullPaper.link ? '            <span><a href="' + escapeHtml(fullPaper.link) + '" target="_blank">查看原文</a></span>\n' : '') +
'        </div>\n' +
'    </div>\n' +
(tabsHtml ? '    <div class="review-tabs">' + tabsHtml + '</div>\n' : '') +
contentHtml + '\n' +
'    <script>\n' +
'        const multiModelResults = ' + multiModelResultsJson + ';\n' +
'        const summaryResult = ' + summaryResultJson + ';\n' +
'\n' +
'        function switchReviewTab(tabId) {\n' +
'            document.querySelectorAll(\'.review-content\').forEach(content => {\n' +
'                content.classList.remove(\'active\');\n' +
'            });\n' +
'            document.querySelectorAll(\'.review-tab\').forEach(tab => {\n' +
'                tab.classList.remove(\'active\');\n' +
'            });\n' +
'            const content = document.getElementById(\'review-content-\' + tabId);\n' +
'            if (content) {\n' +
'                content.classList.add(\'active\');\n' +
'            }\n' +
'            event.target.classList.add(\'active\');\n' +
'            if (content && window.marked) {\n' +
'                const markdownEl = content.querySelector(\'.review-markdown\');\n' +
'                if (markdownEl) {\n' +
'                    let reviewText = \'\';\n' +
'                    if (tabId === \'summary\') {\n' +
'                        // 显示汇总结果\n' +
'                        if (summaryResult) {\n' +
'                            if (summaryResult.consensus_points) {\n' +
'                                reviewText += \'**共识要点**：\\n\\n\' + summaryResult.consensus_points + \'\\n\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.divergence_points) {\n' +
'                                reviewText += \'**分歧分析**：\\n\\n\' + summaryResult.divergence_points + \'\\n\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.final_review) {\n' +
'                                reviewText += \'**综合评审报告**：\\n\\n\' + summaryResult.final_review + \'\\n\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.final_score_details && Object.keys(summaryResult.final_score_details).length > 0) {\n' +
'                                reviewText += \'**最终评分详情**：\\n\\n\';\n' +
'                                for (const [dim, score] of Object.entries(summaryResult.final_score_details)) {\n' +
'                                    reviewText += \'- \' + dim + \'：\' + score.toFixed(2) + \'/1.0\\n\';\n' +
'                                }\n' +
'                                reviewText += \'\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.model_consistency !== undefined) {\n' +
'                                reviewText += \'**模型一致性**：\' + (summaryResult.model_consistency * 100).toFixed(1) + \'%\\n\\n\';\n' +
'                            }\n' +
'                            if (summaryResult.confidence !== undefined) {\n' +
'                                reviewText += \'**结果可信度**：\' + (summaryResult.confidence * 100).toFixed(1) + \'%\\n\\n\';\n' +
'                            }\n' +
'                        } else {\n' +
'                            reviewText = \'暂无汇总结果\';\n' +
'                        }\n' +
'                    } else if (multiModelResults[tabId]) {\n' +
'                        // 显示单个模型的结果\n' +
'                        reviewText = multiModelResults[tabId].review || \'\';\n' +
'                    } else {\n' +
'                        reviewText = \'暂无评审结果\';\n' +
'                    }\n' +
'                    markdownEl.innerHTML = window.marked.parse(reviewText);\n' +
'                }\n' +
'            }\n' +
'        }\n' +
'\n' +
'        window.addEventListener(\'DOMContentLoaded\', () => {\n' +
'            const firstContent = document.querySelector(\'.review-content.active\');\n' +
'            if (firstContent && window.marked) {\n' +
'                const markdownEl = firstContent.querySelector(\'.review-markdown\');\n' +
'                if (markdownEl) {\n' +
'                    let reviewText = \'\';\n' +
'                    if (summaryResult) {\n' +
'                        // 默认显示汇总结果\n' +
'                        if (summaryResult.consensus_points) {\n' +
'                            reviewText += \'**共识要点**：\\n\\n\' + summaryResult.consensus_points + \'\\n\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.divergence_points) {\n' +
'                            reviewText += \'**分歧分析**：\\n\\n\' + summaryResult.divergence_points + \'\\n\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.final_review) {\n' +
'                            reviewText += \'**综合评审报告**：\\n\\n\' + summaryResult.final_review + \'\\n\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.final_score_details && Object.keys(summaryResult.final_score_details).length > 0) {\n' +
'                            reviewText += \'**最终评分详情**：\\n\\n\';\n' +
'                            for (const [dim, score] of Object.entries(summaryResult.final_score_details)) {\n' +
'                                reviewText += \'- \' + dim + \'：\' + score.toFixed(2) + \'/1.0\\n\';\n' +
'                            }\n' +
'                            reviewText += \'\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.model_consistency !== undefined) {\n' +
'                            reviewText += \'**模型一致性**：\' + (summaryResult.model_consistency * 100).toFixed(1) + \'%\\n\\n\';\n' +
'                        }\n' +
'                        if (summaryResult.confidence !== undefined) {\n' +
'                            reviewText += \'**结果可信度**：\' + (summaryResult.confidence * 100).toFixed(1) + \'%\\n\\n\';\n' +
'                        }\n' +
'                    } else {\n' +
'                        const firstModelId = Object.keys(multiModelResults)[0];\n' +
'                        if (firstModelId) {\n' +
'                            reviewText = multiModelResults[firstModelId].review || \'\';\n' +
'                        } else {\n' +
'                            reviewText = ' + fullPaperReviewJson + ';\n' +
'                        }\n' +
'                    }\n' +
'                    markdownEl.innerHTML = window.marked.parse(reviewText);\n' +
'                }\n' +
'            }\n' +
'        });\n' +
'    <\/script>\n' +
'<\/body>\n' +
'<\/html>';

            // 使用更安全的方式写入内容
            reviewWindow.document.open();
            reviewWindow.document.write(htmlContent);
            reviewWindow.document.close();
            
            // 等待 marked.js 加载完成后再渲染
            const checkMarked = setInterval(function() {
                if (reviewWindow.marked) {
                    clearInterval(checkMarked);
                    // 渲染所有 Markdown 内容
                    reviewWindow.document.querySelectorAll('.review-markdown').forEach(function(el) {
                        if (el.textContent && !el.innerHTML.includes('<')) {
                            // 如果内容还是纯文本，说明还没渲染
                            el.innerHTML = reviewWindow.marked.parse(el.textContent);
                        }
                    });
                }
            }, 100);
            
            // 10秒后停止检查
            setTimeout(function() {
                clearInterval(checkMarked);
            }, 10000);
        }

        // HTML转义函数（如果不存在）
        if (typeof escapeHtml === 'undefined') {
            window.escapeHtml = function(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
        }

        // 开始运行或继续运行
        runBtn.addEventListener('click', () => {
            // 如果正在等待确认，发送确认请求
            if (isWaitingConfirmation) {
                confirmAndContinue();
                return;
            }
            
            if (isRunning) return;

            const mode = document.querySelector('input[name="mode"]:checked').value;
            const keywords = document.getElementById('keywords').value.trim();
            const config = {
                mode: mode,
                keywords: keywords || '机器人学、控制理论、遥操作、机器人动力学、力控、机器学习'
            };

            if (mode === 'local') {
                const csvFileInput = document.getElementById('csv-file');
                if (!csvFileInput || !csvFileInput.files || csvFileInput.files.length === 0) {
                    addLog('error', '请选择CSV文件');
                    return;
                }
            } else {
                // 将日期转换为天数
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    startDate.setHours(0, 0, 0, 0);
                    const diffTime = today - startDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    config.start_days = diffDays;
                } else {
                    config.start_days = 1; // 默认昨天
                }
                
                if (endDateInput.value) {
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(0, 0, 0, 0);
                    const diffTime = today - endDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    config.end_days = diffDays;
                } else {
                    config.end_days = 0; // 默认今天
                }
            }

            // 清空列表
            if (paperList) {
                paperList.innerHTML = '<div style="text-align: center; color: #666; padding: 40px 20px;">处理中...</div>';
            }
            // 注意：fileList 已改为 paperResultList，但这里不需要清空，因为论文结果会在处理完成后自动添加

            // 发送启动请求
            let requestPromise;
            if (mode === 'local') {
                // 本地模式：使用FormData上传文件
                const csvFileInput = document.getElementById('csv-file');
                const formData = new FormData();
                formData.append('csv_file', csvFileInput.files[0]);
                formData.append('config', JSON.stringify(config));
                
                requestPromise = fetch('/api/start', {
                    method: 'POST',
                    body: formData
                });
            } else {
                // 远程模式：发送JSON配置
                requestPromise = fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
            }
            
            requestPromise
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('success', '任务已启动');
                } else {
                    addLog('error', `启动失败: ${data.error}`);
                }
            })
            .catch(error => {
                addLog('error', `请求失败: ${error.message}`);
            });
        });

        // 显示选中的文件名
        function initFileSelectHandler() {
            const csvFileInput = document.getElementById('csv-file');
            const csvFileName = document.getElementById('csv-file-name');
            const fileSelectText = document.getElementById('file-select-text');
            const fileSelectButton = document.getElementById('file-select-button');
            
            if (!csvFileInput || !csvFileName || !fileSelectText) {
                // 如果元素不存在，延迟重试
                setTimeout(initFileSelectHandler, 100);
                return;
            }
            
            // 文件选择变化事件
            csvFileInput.addEventListener('change', function(e) {
                const file = e.target.files && e.target.files.length > 0 ? e.target.files[0] : null;
                const fileName = file ? file.name : '未选择文件';
                
                // 更新文件名显示
                if (csvFileName) {
                    csvFileName.textContent = fileName;
                }
                
                // 更新按钮文本
                if (file && fileSelectText) {
                    fileSelectText.textContent = `✓ ${fileName}`;
                    fileSelectText.style.color = '#00ff88';
                } else if (fileSelectText) {
                    fileSelectText.textContent = '📁 点击选择CSV文件';
                    fileSelectText.style.color = '#fff';
                }
            });
            
            // 确保按钮点击也能触发文件选择
            if (fileSelectButton) {
                fileSelectButton.addEventListener('click', function(e) {
                    // 如果点击的不是文件输入框本身，触发文件选择
                    if (e.target !== csvFileInput) {
                        e.preventDefault();
                        e.stopPropagation();
                        csvFileInput.click();
                    }
                });
            }
            
            if (fileSelectText) {
                fileSelectText.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    csvFileInput.click();
                });
            }
        }

        // 初始化
        // 确保DOM加载完成后再初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initFileSelectHandler();
                connectWebSocket();
            });
        } else {
            // DOM已经加载完成
            initFileSelectHandler();
            connectWebSocket();
        }
    </script>

    <!-- 设置弹窗 -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h3>模型设置</h3>
                <button class="settings-close" id="settings-close">✕</button>
            </div>
            <div class="settings-body">
                <button class="btn-add-model" id="btn-add-model">+ 添加模型</button>
                <div class="model-list" id="model-list">
                    <!-- 模型列表将在这里动态生成 -->
                </div>
            </div>
            <div class="settings-footer">
                <button class="btn-save" id="btn-save-models">保存配置</button>
            </div>
        </div>
    </div>

    <script>
        // 设置弹窗功能（确保DOM已加载）
        let settingsBtn, settingsModal, settingsClose, btnAddModel, modelList, btnSaveModels;
        let models = [];
        let settingsInitialized = false;

        // 全局函数：打开设置弹窗（作为备选方案）
        window.openSettingsModal = function() {
            if (!settingsInitialized) {
                initSettingsModal();
            }
            const modal = document.getElementById('settings-modal');
            if (modal) {
                loadModelsForModal();
                modal.classList.add('active');
            }
        };

        // 加载模型列表（独立函数，供onclick使用）
        function loadModelsForModal() {
            fetch('/api/models')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 使用服务器返回的配置，而不是之前内存中的配置
                        models = data.models || [];
                        // 确保每个模型都有collapsed、is_default和enabled属性
                        let hasDefault = false;
                        models.forEach(model => {
                            if (model.collapsed === undefined) {
                                model.collapsed = true; // 默认折叠
                            }
                            if (model.is_default === true) {
                                hasDefault = true;
                            }
                            if (model.enabled === undefined) {
                                model.enabled = true; // 默认启用
                            }
                        });
                        // 如果没有默认模型，将第一个设为默认
                        if (!hasDefault && models.length > 0) {
                            models[0].is_default = true;
                        }
                        if (window.renderModels) {
                            window.renderModels();
                        }
                    } else {
                        addLog('error', `加载模型配置失败: ${data.error}`);
                    }
                })
                .catch(error => {
                    addLog('error', `加载模型配置失败: ${error.message}`);
                });
        }

        function initSettingsModal() {
            settingsBtn = document.getElementById('settings-btn');
            settingsModal = document.getElementById('settings-modal');
            settingsClose = document.getElementById('settings-close');
            btnAddModel = document.getElementById('btn-add-model');
            modelList = document.getElementById('model-list');
            btnSaveModels = document.getElementById('btn-save-models');

            if (!settingsBtn || !settingsModal || !settingsClose || !btnAddModel || !modelList || !btnSaveModels) {
                return false;
            }

            // 加载模型列表（从服务器读取已保存的配置）
            function loadModels() {
                fetch('/api/models')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 使用服务器返回的配置，而不是之前内存中的配置
                            models = data.models || [];
                            // 确保每个模型都有collapsed、is_default和enabled属性
                            let hasDefault = false;
                            models.forEach(model => {
                                if (model.collapsed === undefined) {
                                    model.collapsed = true; // 默认折叠
                                }
                                if (model.is_default === true) {
                                    hasDefault = true;
                                }
                                if (model.enabled === undefined) {
                                    model.enabled = true; // 默认启用
                                }
                            });
                            // 如果没有默认模型，将第一个设为默认
                            if (!hasDefault && models.length > 0) {
                                models[0].is_default = true;
                            }
                            renderModels();
                        } else {
                            addLog('error', `加载模型配置失败: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        addLog('error', `加载模型配置失败: ${error.message}`);
                    });
            }

            // 渲染模型列表
            function renderModels() {
                if (!modelList) return;
                
                modelList.innerHTML = '';
                
                if (models.length === 0) {
                    modelList.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">暂无模型配置，点击"添加模型"创建</div>';
                    return;
                }

                models.forEach((model, index) => {
                    const modelItem = document.createElement('div');
                    modelItem.className = 'model-item';
                    const isCollapsed = model.collapsed !== false; // 默认折叠
                    modelItem.innerHTML = `
                        <div class="model-item-header">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <button class="btn-collapse" onclick="toggleModelCollapse(${index})" title="${isCollapsed ? '展开' : '折叠'}">
                                    ${isCollapsed ? '▶' : '▼'}
                                </button>
                                <label class="default-model-radio">
                                    <input type="radio" name="default-model" value="${index}" 
                                           ${model.is_default ? 'checked' : ''} 
                                           onchange="setDefaultModel(${index})">
                                    <span class="radio-label">默认</span>
                                </label>
                                <label class="enable-model-checkbox">
                                    <input type="checkbox" 
                                           ${model.enabled !== false ? 'checked' : ''} 
                                           onchange="toggleModelEnabled(${index}, this.checked)">
                                    <span class="checkbox-label">启用</span>
                                </label>
                                <input type="text" class="model-title-input" value="${model.name || '未命名模型'}" 
                                       onchange="updateModel(${index}, 'name', this.value)" 
                                       placeholder="模型名称"
                                       style="background: transparent; border: none; border-bottom: 1px solid var(--neon-cyan); color: var(--neon-cyan); font-family: 'Rajdhani', sans-serif; font-size: 16px; font-weight: 600; padding: 4px 8px; flex: 1;">
                            </div>
                            <div class="model-item-actions">
                                <button class="btn-test" onclick="testModel(${index})">测试</button>
                                <button class="btn-delete" onclick="deleteModel(${index})">删除</button>
                            </div>
                        </div>
                        <div class="model-item-content" style="display: ${isCollapsed ? 'none' : 'block'}; margin-top: 15px;">
                            <div class="model-form-group">
                                <label>模型类型</label>
                                <select onchange="updateModelType(${index}, this.value)">
                                    <option value="local" ${model.type === 'local' ? 'selected' : ''}>本地模型 (Ollama)</option>
                                    <option value="remote" ${model.type === 'remote' ? 'selected' : ''}>远程模型 (API)</option>
                                </select>
                            </div>
                            ${model.type === 'local' ? `
                                <div class="model-form-group">
                                    <label>Base URL</label>
                                    <input type="text" value="${model.base_url || ''}" onchange="updateModel(${index}, 'base_url', this.value)" placeholder="例如: http://localhost:11434">
                                </div>
                                <div class="model-form-group">
                                    <label>模型名称</label>
                                    <input type="text" value="${model.model_name || ''}" onchange="updateModel(${index}, 'model_name', this.value)" placeholder="例如: qwen2.5:32b">
                                </div>
                            ` : `
                                <div class="model-form-group">
                                    <label>API Key</label>
                                    <input type="password" value="${model.api_key || ''}" onchange="updateModel(${index}, 'api_key', this.value)" placeholder="输入API密钥">
                                </div>
                                <div class="model-form-group">
                                    <label>Base URL / API Base</label>
                                    <input type="text" value="${model.base_url || model.api_base || ''}" onchange="updateModel(${index}, 'base_url', this.value)" placeholder="例如: https://api.openai.com/v1">
                                </div>
                                <div class="model-form-group">
                                    <label>模型名称 (可选)</label>
                                    <input type="text" value="${model.model_name || ''}" onchange="updateModel(${index}, 'model_name', this.value)" placeholder="例如: gpt-4">
                                </div>
                            `}
                            <div class="model-form-group">
                                <label>描述 (可选)</label>
                                <input type="text" value="${model.description || ''}" onchange="updateModel(${index}, 'description', this.value)" placeholder="模型描述">
                            </div>
                        </div>
                    `;
                    modelList.appendChild(modelItem);
                });
            }

            // 将函数暴露到全局作用域
            window.renderModels = renderModels;

            // 打开设置弹窗
            settingsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                loadModels();
                settingsModal.classList.add('active');
            });

            // 关闭设置弹窗
            settingsClose.addEventListener('click', () => {
                settingsModal.classList.remove('active');
            });

            // 移除点击背景关闭功能，只能通过X按钮关闭

            // 添加新模型（添加到最上面）
            btnAddModel.addEventListener('click', () => {
                const newModel = {
                    id: `model_${Date.now()}`,
                    name: '新模型',
                    type: 'local',
                    base_url: 'http://localhost:11434',
                    model_name: 'qwen2.5:32b',
                    api_key: '',
                    description: '',
                    collapsed: false, // 新添加的模型默认展开
                    is_default: models.length === 0, // 如果是第一个模型，自动设为默认
                    enabled: true // 新添加的模型默认启用
                };
                // 如果这是第一个模型，设为默认；否则清除其他模型的默认标记
                if (models.length === 0) {
                    newModel.is_default = true;
                } else {
                    models.forEach(model => {
                        model.is_default = false;
                    });
                }
                models.unshift(newModel); // 使用unshift添加到数组开头
                renderModels();
            });

            // 保存模型配置
            btnSaveModels.addEventListener('click', () => {
                // 验证所有模型配置
                let hasError = false;
                for (let i = 0; i < models.length; i++) {
                    const model = models[i];
                    if (!model.name || !model.name.trim()) {
                        addLog('error', `模型 ${i + 1} 缺少名称`);
                        hasError = true;
                    }
                    if (model.type === 'local') {
                        if (!model.base_url || !model.model_name) {
                            addLog('error', `模型 "${model.name}" 缺少必要配置（Base URL 或模型名称）`);
                            hasError = true;
                        }
                    } else if (model.type === 'remote') {
                        if (!model.api_key || (!model.base_url && !model.api_base)) {
                            addLog('error', `模型 "${model.name}" 缺少必要配置（API Key 或 Base URL）`);
                            hasError = true;
                        }
                    }
                }

                if (hasError) {
                    return;
                }

                fetch('/api/models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ models: models })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog('success', '模型配置保存成功');
                        settingsModal.classList.remove('active');
                    } else {
                        addLog('error', `保存失败: ${data.error}`);
                    }
                })
                .catch(error => {
                    addLog('error', `保存失败: ${error.message}`);
                });
            });

            settingsInitialized = true;
            return true;
        }

        // 更新模型配置
        window.updateModel = function(index, field, value) {
            if (models[index]) {
                models[index][field] = value;
            }
        };

        // 切换模型折叠/展开
        window.toggleModelCollapse = function(index) {
            if (models[index]) {
                models[index].collapsed = !models[index].collapsed;
                if (window.renderModels) window.renderModels();
            }
        };

        // 设置默认模型
        window.setDefaultModel = function(index) {
            // 清除所有模型的默认标记
            models.forEach((model, i) => {
                model.is_default = (i === index);
            });
            // 重新渲染以更新单选按钮状态
            if (window.renderModels) window.renderModels();
        };

        // 切换模型启用状态
        window.toggleModelEnabled = function(index, enabled) {
            if (models[index]) {
                models[index].enabled = enabled;
            }
        };

        // 更新模型类型（需要重新渲染）
        window.updateModelType = function(index, type) {
            if (models[index]) {
                models[index].type = type;
                // 根据类型设置默认值
                if (type === 'local') {
                    if (!models[index].base_url) models[index].base_url = 'http://localhost:11434';
                    if (!models[index].model_name) models[index].model_name = 'qwen2.5:32b';
                    models[index].api_key = '';
                } else {
                    if (!models[index].api_key) models[index].api_key = '';
                    if (!models[index].base_url && !models[index].api_base) {
                        models[index].base_url = '';
                    }
                }
                if (window.renderModels) window.renderModels();
            }
        };

        // 删除模型
        window.deleteModel = function(index) {
            if (confirm('确定要删除这个模型配置吗？')) {
                models.splice(index, 1);
                if (window.renderModels) window.renderModels();
            }
        };

        // 测试模型
        window.testModel = function(index) {
            const model = models[index];
            if (!model) return;

            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';
            
            // 移除之前的测试状态
            const statusEl = testBtn.parentElement.querySelector('.test-status');
            if (statusEl) {
                statusEl.remove();
            }

            fetch('/api/models/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ model: model })
            })
            .then(response => response.json())
            .then(data => {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
                
                const statusEl = document.createElement('span');
                statusEl.className = 'test-status ' + (data.success ? 'success' : 'error');
                statusEl.textContent = data.success ? '✓ 连接成功' : '✗ ' + (data.error || '连接失败');
                testBtn.parentElement.appendChild(statusEl);
                
                // 3秒后移除状态提示
                setTimeout(() => {
                    if (statusEl.parentElement) {
                        statusEl.remove();
                    }
                }, 3000);
            })
            .catch(error => {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
                
                const statusEl = document.createElement('span');
                statusEl.className = 'test-status error';
                statusEl.textContent = '✗ 测试失败: ' + error.message;
                testBtn.parentElement.appendChild(statusEl);
                
                setTimeout(() => {
                    if (statusEl.parentElement) {
                        statusEl.remove();
                    }
                }, 3000);
            });
        };

        // 在DOM加载完成后初始化
        function tryInitSettings() {
            const result = initSettingsModal();
            if (!result) {
                setTimeout(tryInitSettings, 1000);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryInitSettings);
        } else {
            // DOM已经加载完成
            tryInitSettings();
        }
    </script>

    <!-- 邮箱设置模态框 -->
    <div class="email-settings-modal" id="email-settings-modal">
        <div class="email-settings-content">
            <div class="email-settings-header">
                <h3>⚙️ 邮箱设置</h3>
                <button class="email-settings-close" id="email-settings-close">✕</button>
            </div>
            <div class="email-settings-body">
                <div class="email-settings-form">
                    <div class="form-group">
                        <label for="email-config-user">邮箱账号</label>
                        <input type="text" id="email-config-user" class="input-field" placeholder="your_email@qq.com">
                    </div>
                    <div class="form-group">
                        <label for="email-config-password">授权码/密码</label>
                        <input type="password" id="email-config-password" class="input-field" placeholder="请输入IMAP授权码">
                    </div>
                    <div class="form-group">
                        <label for="email-config-imap-server">IMAP服务器</label>
                        <input type="text" id="email-config-imap-server" class="input-field" placeholder="imap.qq.com" value="imap.qq.com">
                    </div>
                    <div class="form-group">
                        <label for="email-config-imap-port">IMAP端口</label>
                        <input type="number" id="email-config-imap-port" class="input-field" placeholder="993" value="993">
                    </div>
                    <div class="form-hint">
                        <p>💡 提示：</p>
                        <ul>
                            <li>QQ邮箱需要在"设置-账户"中开启IMAP服务并获取授权码</li>
                            <li>其他邮箱请参考对应邮箱服务商的IMAP配置说明</li>
                            <li>配置信息将保存在本地，不会上传到服务器</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="email-settings-footer">
                <button class="btn-test" id="btn-test-email">测试连接</button>
                <button class="btn-save" id="btn-save-email-config">保存配置</button>
            </div>
        </div>
    </div>

    <!-- 邮件信息模态框 -->
    <div class="email-modal" id="email-modal">
        <div class="email-content">
            <div class="email-header">
                <h3>📧 邮箱信息</h3>
                <button class="email-close" id="email-close">✕</button>
            </div>
            <div class="email-body">
                <div class="email-summary" id="email-summary">
                    <div class="email-summary-item">
                        <span class="email-summary-label">最后更新:</span>
                        <span id="email-last-update">-</span>
                    </div>
                    <div class="email-summary-item">
                        <span class="email-summary-label">邮件总数:</span>
                        <span id="email-total">0</span>
                    </div>
                    <div class="email-summary-item">
                        <span class="email-summary-label">论文总数:</span>
                        <span id="email-papers-total">0</span>
                    </div>
                </div>
                <div class="email-list" id="email-list">
                    <!-- 邮件列表将在这里动态生成 -->
                </div>
            </div>
            <div class="email-footer">
                <div class="email-pagination" id="email-pagination" style="display: none;">
                    <button class="pagination-btn" id="pagination-prev">上一页</button>
                    <span class="pagination-info" id="pagination-info">第 1 页，共 1 页</span>
                    <button class="pagination-btn" id="pagination-next">下一页</button>
                </div>
                <div class="email-footer-buttons">
                    <button class="btn-settings" id="btn-email-settings" title="邮箱设置">⚙️</button>
                    <button class="btn-update" id="btn-update-emails">更新</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 邮件信息模态框相关代码
        let emailModal, emailClose, btnUpdateEmails, emailList, emailLastUpdate, emailTotal, emailPapersTotal;
        let allEmails = [];  // 存储所有邮件
        let currentPage = 1;
        const emailsPerPage = 10;  // 每页显示10封邮件

        function loadEmailInfo() {
            fetch('/api/emails/all')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const emailData = data.data;
                        emailLastUpdate.textContent = emailData.last_update || '从未更新';
                        emailTotal.textContent = emailData.total_emails || 0;
                        emailPapersTotal.textContent = emailData.total_papers || 0;
                        
                        // 保存所有邮件
                        allEmails = emailData.emails || [];
                        currentPage = 1;
                        
                        // 渲染邮件列表和分页
                        renderEmailList();
                        updatePagination();
                    } else {
                        console.error('获取邮件信息失败:', data.error);
                    }
                })
                .catch(error => {
                    console.error('获取邮件信息出错:', error);
                });
        }

        function renderEmailList() {
            emailList.innerHTML = '';
            
            if (allEmails.length === 0) {
                emailList.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 40px 20px;">暂无邮件</div>';
                return;
            }
            
            // 计算当前页的邮件范围
            const startIndex = (currentPage - 1) * emailsPerPage;
            const endIndex = startIndex + emailsPerPage;
            const currentPageEmails = allEmails.slice(startIndex, endIndex);
            
            currentPageEmails.forEach(email => {
                const emailItem = document.createElement('div');
                emailItem.className = 'email-item';
                
                const papersHtml = email.papers && email.papers.length > 0
                    ? email.papers.map(paper => {
                        const title = paper.title || '无标题';
                        const link = paper.link || '#';
                        return `
                        <div class="email-paper-item">
                            ${link && link !== '#' ? `<a href="${link}" target="_blank" class="email-paper-title-link">${title}</a>` : `<div class="email-paper-title">${title}</div>`}
                        </div>
                    `;
                    }).join('')
                    : '<div style="color: rgba(255, 255, 255, 0.5); font-size: 12px;">无论文信息</div>';
                
                emailItem.innerHTML = `
                    <div class="email-item-header">
                        <div class="email-item-subject">${email.subject || '无主题'}</div>
                        <div class="email-item-date">${email.date || '-'}</div>
                    </div>
                    <div class="email-item-papers">
                        <div class="email-item-papers-title">论文 (${email.paper_count || 0}):</div>
                        ${papersHtml}
                    </div>
                `;
                
                emailList.appendChild(emailItem);
            });
        }

        function updatePagination() {
            const pagination = document.getElementById('email-pagination');
            const paginationInfo = document.getElementById('pagination-info');
            const paginationPrev = document.getElementById('pagination-prev');
            const paginationNext = document.getElementById('pagination-next');
            
            if (!pagination || !paginationInfo || !paginationPrev || !paginationNext) {
                return;
            }
            
            const totalPages = Math.ceil(allEmails.length / emailsPerPage);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            paginationInfo.textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            
            paginationPrev.disabled = currentPage === 1;
            paginationNext.disabled = currentPage === totalPages;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(allEmails.length / emailsPerPage);
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            renderEmailList();
            updatePagination();
            // 滚动到顶部
            const emailBody = document.querySelector('.email-body');
            if (emailBody) {
                emailBody.scrollTop = 0;
            }
        }

        function updateEmails() {
            btnUpdateEmails.disabled = true;
            btnUpdateEmails.textContent = '更新中...';
            
            fetch('/api/emails/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    start_days: 7,
                    end_days: 0
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadEmailInfo();
                        alert(`更新成功！共更新 ${data.updated_count || 0} 封邮件`);
                    } else {
                        alert('更新失败: ' + (data.error || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('更新邮件出错:', error);
                    alert('更新失败: ' + error.message);
                })
                .finally(() => {
                    btnUpdateEmails.disabled = false;
                    btnUpdateEmails.textContent = '更新';
                });
        }

        // 初始化邮件模态框
        function initEmailModal() {
            emailModal = document.getElementById('email-modal');
            emailClose = document.getElementById('email-close');
            btnUpdateEmails = document.getElementById('btn-update-emails');
            emailList = document.getElementById('email-list');
            emailLastUpdate = document.getElementById('email-last-update');
            emailTotal = document.getElementById('email-total');
            emailPapersTotal = document.getElementById('email-papers-total');
            
            const emailBtn = document.getElementById('email-btn');
            const paginationPrev = document.getElementById('pagination-prev');
            const paginationNext = document.getElementById('pagination-next');
            
            if (emailBtn) {
                emailBtn.addEventListener('click', () => {
                    loadEmailInfo();
                    emailModal.classList.add('active');
                });
            }
            
            if (emailClose) {
                emailClose.addEventListener('click', () => {
                    emailModal.classList.remove('active');
                });
            }
            
            if (btnUpdateEmails) {
                btnUpdateEmails.addEventListener('click', updateEmails);
            }
            
            if (paginationPrev) {
                paginationPrev.addEventListener('click', () => {
                    goToPage(currentPage - 1);
                });
            }
            
            if (paginationNext) {
                paginationNext.addEventListener('click', () => {
                    goToPage(currentPage + 1);
                });
            }
            
            // 初始化邮箱设置模态框
            initEmailSettingsModal();
        }

        // 初始化邮箱设置模态框
        function initEmailSettingsModal() {
            emailSettingsModal = document.getElementById('email-settings-modal');
            emailSettingsClose = document.getElementById('email-settings-close');
            btnEmailSettings = document.getElementById('btn-email-settings');
            btnSaveEmailConfig = document.getElementById('btn-save-email-config');
            btnTestEmail = document.getElementById('btn-test-email');
            emailConfigUser = document.getElementById('email-config-user');
            emailConfigPassword = document.getElementById('email-config-password');
            emailConfigImapServer = document.getElementById('email-config-imap-server');
            emailConfigImapPort = document.getElementById('email-config-imap-port');
            
            // 打开设置模态框
            if (btnEmailSettings) {
                btnEmailSettings.addEventListener('click', () => {
                    loadEmailConfig();
                    emailSettingsModal.classList.add('active');
                });
            }
            
            // 关闭设置模态框
            if (emailSettingsClose) {
                emailSettingsClose.addEventListener('click', () => {
                    emailSettingsModal.classList.remove('active');
                });
            }
            
            // 点击背景关闭
            if (emailSettingsModal) {
                emailSettingsModal.addEventListener('click', (e) => {
                    if (e.target === emailSettingsModal) {
                        emailSettingsModal.classList.remove('active');
                    }
                });
            }
            
            // 保存配置
            if (btnSaveEmailConfig) {
                btnSaveEmailConfig.addEventListener('click', saveEmailConfig);
            }
            
            // 测试连接
            if (btnTestEmail) {
                btnTestEmail.addEventListener('click', testEmailConnection);
            }
            
            // 当用户点击密码输入框时，如果是占位符，清空以便输入
            if (emailConfigPassword) {
                emailConfigPassword.addEventListener('focus', function() {
                    if (this.value === '********') {
                        this.value = '';
                        this.placeholder = '请输入IMAP授权码';
                    }
                });
            }
        }

        // 加载邮箱配置
        function loadEmailConfig() {
            fetch('/api/email/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.config) {
                        if (emailConfigUser) emailConfigUser.value = data.config.user || '';
                        // 如果配置存在且有用户账号，说明已配置过，密码字段显示占位符
                        if (emailConfigPassword) {
                            if (data.config.user && data.config.user.trim() !== '') {
                                // 已配置过，显示占位符
                                emailConfigPassword.value = '********';
                                emailConfigPassword.placeholder = '********';
                            } else {
                                // 未配置，显示原始占位符
                                emailConfigPassword.value = '';
                                emailConfigPassword.placeholder = '请输入IMAP授权码';
                            }
                        }
                        if (emailConfigImapServer) emailConfigImapServer.value = data.config.imap_server || 'imap.qq.com';
                        if (emailConfigImapPort) emailConfigImapPort.value = data.config.imap_port || 993;
                    }
                })
                .catch(error => {
                    console.error('加载邮箱配置失败:', error);
                });
        }

        // 保存邮箱配置
        function saveEmailConfig() {
            const config = {
                user: emailConfigUser ? emailConfigUser.value.trim() : '',
                password: emailConfigPassword ? emailConfigPassword.value.trim() : '',
                imap_server: emailConfigImapServer ? emailConfigImapServer.value.trim() : 'imap.qq.com',
                imap_port: emailConfigImapPort ? parseInt(emailConfigImapPort.value) : 993
            };
            
            // 如果密码是占位符或为空，提示用户输入
            if (!config.password || config.password === '********') {
                addLog('error', '请填写授权码/密码');
                if (emailConfigPassword) {
                    emailConfigPassword.focus();
                }
                return;
            }
            
            if (!config.user) {
                addLog('error', '请填写邮箱账号');
                if (emailConfigUser) {
                    emailConfigUser.focus();
                }
                return;
            }
            
            btnSaveEmailConfig.disabled = true;
            btnSaveEmailConfig.textContent = '保存中...';
            
            fetch('/api/email/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                btnSaveEmailConfig.disabled = false;
                btnSaveEmailConfig.textContent = '保存配置';
                
                if (data.success) {
                    addLog('success', '邮箱配置已保存');
                    // 保存成功后，将密码字段设置为占位符
                    if (emailConfigPassword) {
                        emailConfigPassword.value = '********';
                        emailConfigPassword.placeholder = '********';
                    }
                    emailSettingsModal.classList.remove('active');
                } else {
                    addLog('error', `保存失败: ${data.error}`);
                }
            })
            .catch(error => {
                btnSaveEmailConfig.disabled = false;
                btnSaveEmailConfig.textContent = '保存配置';
                addLog('error', `保存失败: ${error.message}`);
            });
        }

        // 测试邮箱连接
        function testEmailConnection() {
            const config = {
                user: emailConfigUser ? emailConfigUser.value.trim() : '',
                password: emailConfigPassword ? emailConfigPassword.value.trim() : '',
                imap_server: emailConfigImapServer ? emailConfigImapServer.value.trim() : 'imap.qq.com',
                imap_port: emailConfigImapPort ? parseInt(emailConfigImapPort.value) : 993
            };
            
            if (!config.user || !config.password) {
                addLog('error', '请填写邮箱账号和授权码');
                return;
            }
            
            btnTestEmail.disabled = true;
            btnTestEmail.textContent = '测试中...';
            
            fetch('/api/email/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                btnTestEmail.disabled = false;
                btnTestEmail.textContent = '测试连接';
                
                if (data.success) {
                    addLog('success', '邮箱连接测试成功');
                } else {
                    addLog('error', `连接测试失败: ${data.error}`);
                }
            })
            .catch(error => {
                btnTestEmail.disabled = false;
                btnTestEmail.textContent = '测试连接';
                addLog('error', `连接测试失败: ${error.message}`);
            });
        }

        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initEmailModal);
        } else {
            initEmailModal();
        }
    </script>
</body>
</html>

